<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Pipette Calibration System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .nav-tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
        .nav-tab { flex: 1; padding: 15px 20px; background: none; border: none; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.3s ease; }
        .nav-tab:hover { background: #e9ecef; }
        .nav-tab.active { background: white; color: #007bff; border-bottom: 3px solid #007bff; }
        .tab-content { display: none; padding: 30px; min-height: 600px; }
        .tab-content.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 8px; color: #333; }
        .form-group input, .form-group select, .form-group textarea { padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .pipette-card { background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 2px solid #e9ecef; transition: all 0.3s ease; }
        .pipette-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #dee2e6; }
        .pipette-header h3 { color: #2c3e50; margin-bottom: 5px; }
        .status-badge { padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .status-pass { background: #d4edda; color: #155724; }
        .status-fail { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        .measurement-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .measurement-table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 10px; text-align: center; font-weight: 600; }
        .measurement-table td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #e9ecef; }
        .measurement-input { width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
        .measurement-input:focus { border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }
        .measurement-input.pass { background-color: #d4edda; border-color: #c3e6cb; }
        .measurement-input.fail { background-color: #f8d7da; border-color: #f5c6cb; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; text-align: center; margin: 5px; }
        .btn-primary { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; }
        .statistics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #e9ecef; }
        .stat-value { font-size: 2em; font-weight: bold; color: #007bff; }
        .stat-label { color: #6c757d; margin-top: 5px; }
        .alert { padding: 15px; margin: 15px 0; border-radius: 8px; font-weight: 500; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .progress-bar { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; margin: 20px 0; }
        .progress-fill { height: 100%; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); transition: width 0.5s ease; }
        .environmental-data { background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .report-section { background: white; padding: 30px; margin: 20px 0; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <script>
        let pipettes = [];
        let currentPipetteId = 0;

        const isoSpecs = {
            'P-100': {
                10: { accuracy: { from: 9.2, to: 10.8 }, precision: { percent: 3.0 } },
                50: { accuracy: { from: 49.2, to: 50.8 }, precision: { percent: 0.6 } },
                100: { accuracy: { from: 99.2, to: 100.8 }, precision: { percent: 0.3 } }
            },
            'P-20': {
                2: { accuracy: { from: 1.80, to: 2.20 }, precision: { percent: 5.0 } },
                10: { accuracy: { from: 9.80, to: 10.20 }, precision: { percent: 1.0 } },
                20: { accuracy: { from: 19.80, to: 20.20 }, precision: { percent: 0.5 } }
            }
        };

        function getVolumePrecision(volume) {
            return volume <= 20 ? { step: 0.01, decimals: 2 } : { step: 0.1, decimals: 1 };
        }

        function formatVolume(value, decimals) {
            return parseFloat(value).toFixed(decimals);
        }

        function showTab(tabName, clickedTab) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (clickedTab) clickedTab.classList.add('active');
            if (tabName === 'analysis') updateAnalysis();
        }

        function addPipette() {
            currentPipetteId++;
            const pipette = {
                id: currentPipetteId,
                number: '',
                brand: 'Eppendorf',
                pipetteModel: '',
                serial: '',
                model: 'P-100',
                measurements: {
                    asFound: { low: ['', '', '', ''], mid: ['', '', '', ''], high: ['', '', '', ''] },
                    asLeft: { low: ['', '', '', ''], mid: ['', '', '', ''], high: ['', '', '', ''] }
                },
                comments: '',
                status: 'pending'
            };
            pipettes.push(pipette);
            renderPipette(pipette);
        }

        function renderPipette(pipette) {
            const container = document.getElementById('pipettesContainer');
            const pipetteDiv = document.createElement('div');
            pipetteDiv.className = 'pipette-card';
            pipetteDiv.id = `pipette-${pipette.id}`;

            // Get specific test volumes for this model
            const testVols = getTestVolumes(pipette.model);
            const lowVol = testVols[0];
            const midVol = testVols[1];
            const highVol = testVols[2];
            
            const lowPrecision = getVolumePrecision(lowVol);
            const midPrecision = getVolumePrecision(midVol);
            const highPrecision = getVolumePrecision(highVol);
            
            pipetteDiv.innerHTML = `
                <div class="pipette-header">
                    <div>
                        <h3>Pipette ${pipette.id}</h3>
                        <span class="status-badge status-${pipette.status}" id="status-${pipette.id}">
                            ${pipette.status.toUpperCase()}
                        </span>
                    </div>
                    <button class="btn btn-danger" onclick="removePipette(${pipette.id})">Remove</button>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Pipette Number</label>
                        <input type="text" value="${pipette.number}" onchange="updatePipetteInfo(${pipette.id}, 'number', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Brand</label>
                        <input type="text" value="${pipette.brand}" onchange="updatePipetteInfo(${pipette.id}, 'brand', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Model</label>
                        <input type="text" value="${pipette.pipetteModel || ''}" onchange="updatePipetteInfo(${pipette.id}, 'pipetteModel', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Serial Number</label>
                        <input type="text" value="${pipette.serial}" onchange="updatePipetteInfo(${pipette.id}, 'serial', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Volume</label>
                        <select onchange="updatePipetteModel(${pipette.id}, this.value)">
                            <option value="P-2" ${pipette.model === 'P-2' ? 'selected' : ''}>P-2 (0.2-2 μL)</option>
                            <option value="P-2.5" ${pipette.model === 'P-2.5' ? 'selected' : ''}>P-2.5 (0.5-2.5 μL)</option>
                            <option value="P-10" ${pipette.model === 'P-10' ? 'selected' : ''}>P-10 (1-10 μL)</option>
                            <option value="P-20" ${pipette.model === 'P-20' ? 'selected' : ''}>P-20 (2-20 μL)</option>
                            <option value="P-25" ${pipette.model === 'P-25' ? 'selected' : ''}>P-25 (5-25 μL)</option>
                            <option value="P-50" ${pipette.model === 'P-50' ? 'selected' : ''}>P-50 (10-50 μL)</option>
                            <option value="P-100" ${pipette.model === 'P-100' ? 'selected' : ''}>P-100 (10-100 μL)</option>
                            <option value="P-200" ${pipette.model === 'P-200' ? 'selected' : ''}>P-200 (20-200 μL)</option>
                            <option value="P-250" ${pipette.model === 'P-250' ? 'selected' : ''}>P-250 (25-250 μL)</option>
                            <option value="P-500" ${pipette.model === 'P-500' ? 'selected' : ''}>P-500 (100-500 μL)</option>
                            <option value="P-1000" ${pipette.model === 'P-1000' ? 'selected' : ''}>P-1000 (100-1000 μL)</option>
                            <option value="P-1200" ${pipette.model === 'P-1200' ? 'selected' : ''}>P-1200 (250-1200 μL)</option>
                            <option value="P-1250" ${pipette.model === 'P-1250' ? 'selected' : ''}>P-1250 (250-1250 μL)</option>
                            <option value="P-2000" ${pipette.model === 'P-2000' ? 'selected' : ''}>P-2000 (500-2000 μL)</option>
                            <option value="P-5000" ${pipette.model === 'P-5000' ? 'selected' : ''}>P-5000 (1000-5000 μL)</option>
                            <option value="P-10000" ${pipette.model === 'P-10000' ? 'selected' : ''}>P-10000 (2000-10000 μL)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Comments</label>
                        <textarea rows="2" onchange="updatePipetteInfo(${pipette.id}, 'comments', this.value)">${pipette.comments}</textarea>
                    </div>
                </div>

                <table class="measurement-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Test Point</th>
                            <th colspan="4">As Found</th>
                            <th colspan="4">As Left</th>
                            <th rowspan="2">Status</th>
                        </tr>
                        <tr>
                            <th>Reading 1</th>
                            <th>Reading 2</th>
                            <th>Reading 3</th>
                            <th>Reading 4</th>
                            <th>Reading 1</th>
                            <th>Reading 2</th>
                            <th>Reading 3</th>
                            <th>Reading 4</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Low (${formatVolume(lowVol, lowPrecision.decimals)} μL)</strong></td>
                            <td><input type="number" step="${lowPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asFound', 'low', 0, this.value)" value="${pipette.measurements.asFound.low[0] || ''}" placeholder="${lowPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${lowPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asFound', 'low', 1, this.value)" value="${pipette.measurements.asFound.low[1] || ''}" placeholder="${lowPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${lowPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asFound', 'low', 2, this.value)" value="${pipette.measurements.asFound.low[2] || ''}" placeholder="${lowPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${lowPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asFound', 'low', 3, this.value)" value="${pipette.measurements.asFound.low[3] || ''}" placeholder="${lowPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${lowPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'low', 0, this.value)" value="${pipette.measurements.asLeft.low[0] || ''}" placeholder="${lowPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${lowPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'low', 1, this.value)" value="${pipette.measurements.asLeft.low[1] || ''}" placeholder="${lowPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${lowPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'low', 2, this.value)" value="${pipette.measurements.asLeft.low[2] || ''}" placeholder="${lowPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${lowPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'low', 3, this.value)" value="${pipette.measurements.asLeft.low[3] || ''}" placeholder="${lowPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><span id="status-low-${pipette.id}" class="status-badge status-pending">PENDING</span></td>
                        </tr>
                        <tr>
                            <td><strong>Mid (${formatVolume(midVol, midPrecision.decimals)} μL)</strong></td>
                            <td><input type="number" step="${midPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asFound', 'mid', 0, this.value)" value="${pipette.measurements.asFound.mid[0] || ''}" placeholder="${midPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${midPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asFound', 'mid', 1, this.value)" value="${pipette.measurements.asFound.mid[1] || ''}" placeholder="${midPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${midPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asFound', 'mid', 2, this.value)" value="${pipette.measurements.asFound.mid[2] || ''}" placeholder="${midPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${midPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asFound', 'mid', 3, this.value)" value="${pipette.measurements.asFound.mid[3] || ''}" placeholder="${midPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${midPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'mid', 0, this.value)" value="${pipette.measurements.asLeft.mid[0] || ''}" placeholder="${midPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${midPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'mid', 1, this.value)" value="${pipette.measurements.asLeft.mid[1] || ''}" placeholder="${midPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${midPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'mid', 2, this.value)" value="${pipette.measurements.asLeft.mid[2] || ''}" placeholder="${midPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${midPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'mid', 3, this.value)" value="${pipette.measurements.asLeft.mid[3] || ''}" placeholder="${midPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><span id="status-mid-${pipette.id}" class="status-badge status-pending">PENDING</span></td>
                        </tr>
                        <tr>
                            <td><strong>High (${formatVolume(highVol, highPrecision.decimals)} μL)</strong></td>
                            <td><input type="number" step="${highPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asFound', 'high', 0, this.value)" value="${pipette.measurements.asFound.high[0] || ''}" placeholder="${highPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${highPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asFound', 'high', 1, this.value)" value="${pipette.measurements.asFound.high[1] || ''}" placeholder="${highPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${highPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asFound', 'high', 2, this.value)" value="${pipette.measurements.asFound.high[2] || ''}" placeholder="${highPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${highPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asFound', 'high', 3, this.value)" value="${pipette.measurements.asFound.high[3] || ''}" placeholder="${highPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${highPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'high', 0, this.value)" value="${pipette.measurements.asLeft.high[0] || ''}" placeholder="${highPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${highPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'high', 1, this.value)" value="${pipette.measurements.asLeft.high[1] || ''}" placeholder="${highPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${highPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'high', 2, this.value)" value="${pipette.measurements.asLeft.high[2] || ''}" placeholder="${highPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><input type="number" step="${highPrecision.step}" class="measurement-input" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'high', 3, this.value)" value="${pipette.measurements.asLeft.high[3] || ''}" placeholder="${highPrecision.decimals === 2 ? '0.00' : '0.0'}"></td>
                            <td><span id="status-high-${pipette.id}" class="status-badge status-pending">PENDING</span></td>
                        </tr>
                    </tbody>
                </table>

                <div id="calculations-${pipette.id}"></div>
            `;

            container.appendChild(pipetteDiv);
        }

        function getTestVolumes(model) {
            const testVolumes = {
                'P-2': [0.5, 1, 2],
                'P-2.5': [0.5, 1.25, 2.5],
                'P-10': [2, 5, 10],
                'P-20': [5, 10, 20],
                'P-25': [5, 12.5, 25],
                'P-50': [10, 25, 50],
                'P-100': [20, 50, 100],
                'P-200': [50, 100, 200],
                'P-250': [50, 125, 250],
                'P-500': [100, 250, 500],
                'P-1000': [200, 500, 1000],
                'P-1200': [250, 600, 1200],
                'P-1250': [250, 625, 1250],
                'P-2000': [500, 1000, 2000],
                'P-5000': [1000, 2500, 5000],
                'P-10000': [2000, 5000, 10000]
            };
            return testVolumes[model] || [20, 50, 100];
        }

        function getMaxVolume(model) {
            const maxVolumes = {
                'P-2': 2,
                'P-2.5': 2.5,
                'P-10': 10,
                'P-20': 20,
                'P-25': 25,
                'P-50': 50,
                'P-100': 100,
                'P-200': 200,
                'P-250': 250,
                'P-500': 500,
                'P-1000': 1000,
                'P-1200': 1200,
                'P-1250': 1250,
                'P-2000': 2000,
                'P-5000': 5000,
                'P-10000': 10000
            };
            return maxVolumes[model] || 100;
        }

        function getVolumeRanges(model) {
            const ranges = {
                'P-20': [2, 10, 20],
                'P-100': [10, 50, 100]
            };
            return ranges[model] || [100];
        }

        function updatePipetteModel(pipetteId, newModel) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                pipette.model = newModel;
                document.getElementById(`pipette-${pipetteId}`).remove();
                renderPipette(pipette);
            }
        }

        function updatePipetteInfo(pipetteId, field, value) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                pipette[field] = value;
            }
        }

        function updateMeasurement(pipetteId, condition, point, reading, value) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                pipette.measurements[condition][point][reading] = parseFloat(value) || '';
                validateMeasurement(pipetteId, condition, point);
            }
        }

        function validateMeasurement(pipetteId, condition, point) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (!pipette) return;

            const measurements = pipette.measurements[condition][point];
            if (measurements.filter(m => m !== '').length < 4) return;

            const testVols = getTestVolumes(pipette.model);
            const nominalVolume = testVols[point === 'low' ? 0 : point === 'mid' ? 1 : 2];
            const specs = getSpecifications(pipette.model, nominalVolume);
            
            if (!specs) return;

            const mean = measurements.reduce((a, b) => a + b, 0) / 4;
            const cv = calculateCV(measurements);
            
            const accuracyPass = measurements.every(reading => reading >= specs.accuracy.from && reading <= specs.accuracy.to);
            const precisionPass = cv <= specs.precision.percent;
            const overallPass = accuracyPass && precisionPass;

            const statusElement = document.getElementById(`status-${point}-${pipetteId}`);
            statusElement.className = `status-badge status-${overallPass ? 'pass' : 'fail'}`;
            statusElement.textContent = overallPass ? 'PASS' : 'FAIL';
        }

        function getSpecifications(model, volume) {
            const modelSpecs = isoSpecs[model];
            if (!modelSpecs) return null;

            const volumes = Object.keys(modelSpecs).map(v => parseFloat(v));
            const closest = volumes.reduce((prev, curr) => 
                Math.abs(curr - volume) < Math.abs(prev - volume) ? curr : prev
            );

            return modelSpecs[closest];
        }

        function calculateCV(values) {
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            const stdDev = Math.sqrt(variance);
            return (stdDev / mean) * 100;
        }

        function removePipette(pipetteId) {
            pipettes = pipettes.filter(p => p.id !== pipetteId);
            document.getElementById(`pipette-${pipetteId}`).remove();
        }

        function updateAnalysis() {
            const total = pipettes.length;
            const passed = pipettes.filter(p => p.status === 'pass').length;
            const failed = pipettes.filter(p => p.status === 'fail').length;
            
            document.getElementById('totalPipettes').textContent = total;
            document.getElementById('passCount').textContent = passed;
            document.getElementById('failCount').textContent = failed;
            document.getElementById('passRate').textContent = `${total > 0 ? ((passed / total) * 100).toFixed(1) : 0}%`;
        }

        function autoFillSampleData() {
            pipettes = [];
            document.getElementById('pipettesContainer').innerHTML = '';
            currentPipetteId = 0;

            const sampleData = [
                {
                    number: 'EQ-CPL-PIPS-D-035',
                    brand: 'Eppendorf',
                    pipetteModel: 'Research Plus',
                    serial: '3151046',
                    model: 'P-100',
                    measurements: {
                        asFound: {
                            low: [19.96, 19.97, 19.98, 19.95],
                            mid: [49.8, 49.7, 49.9, 49.85],
                            high: [99.6, 99.7, 99.8, 99.65]
                        },
                        asLeft: {
                            low: [19.99, 19.98, 19.96, 19.97],
                            mid: [49.9, 50.1, 49.8, 49.95],
                            high: [99.9, 99.8, 99.6, 99.75]
                        }
                    },
                    comments: 'Fixed'
                }
            ];

            sampleData.forEach(data => {
                currentPipetteId++;
                const pipette = { id: currentPipetteId, ...data, status: 'pending' };
                pipettes.push(pipette);
                renderPipette(pipette);
                
                ['asFound', 'asLeft'].forEach(condition => {
                    ['low', 'mid', 'high'].forEach(point => {
                        validateMeasurement(pipette.id, condition, point);
                    });
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('calDate').value = today;
        });
    </script>

    <div class="container">
        <div class="header">
            <h1>Advanced Pipette Calibration System</h1>
            <p>ISO 8655 Compliant | Real-time Analysis | Comprehensive Reporting</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('session', this)">Session Info</button>
            <button class="nav-tab" onclick="showTab('calibration', this)">Calibration</button>
            <button class="nav-tab" onclick="showTab('analysis', this)">Analysis</button>
            <button class="nav-tab" onclick="showTab('report', this)">Report</button>
        </div>

        <!-- Session Info Tab -->
        <div id="session" class="tab-content active">
            <h2>Calibration Session Setup</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Service Provider</label>
                    <input type="text" id="serviceProvider" value="Platinum SC Data Intake Worksheets">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="location" value="Kansas State University Mosier F103">
                </div>
                <div class="form-group">
                    <label>Client</label>
                    <input type="text" id="client" value="Janice Muller - Cin Path">
                </div>
                <div class="form-group">
                    <label>Technician</label>
                    <input type="text" id="technician" value="TSD">
                </div>
                <div class="form-group">
                    <label>Calibration Date</label>
                    <input type="date" id="calDate">
                </div>
                <div class="form-group">
                    <label>Temperature (°C)</label>
                    <input type="number" id="temperature" step="0.1" value="21.8">
                </div>
            </div>

            <button class="btn btn-primary" onclick="showTab('calibration', document.querySelector('.nav-tab:nth-child(2)'))">Next: Start Calibration →</button>
        </div>

        <!-- Calibration Tab -->
        <div id="calibration" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Pipette Calibration</h2>
                <div>
                    <button class="btn btn-primary" onclick="addPipette()">+ Add Pipette</button>
                    <button class="btn btn-success" onclick="autoFillSampleData()">Load Sample Data</button>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div id="pipettesContainer">
                <!-- Pipettes will be added here dynamically -->
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <h2>Real-time Analysis</h2>
            
            <div class="statistics">
                <div class="stat-card">
                    <div class="stat-value" id="totalPipettes">0</div>
                    <div class="stat-label">Total Pipettes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="passCount">0</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="failCount">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="passRate">0%</div>
                    <div class="stat-label">Pass Rate</div>
                </div>
            </div>
        </div>

        <!-- Report Tab -->
        <div id="report" class="tab-content">
            <h2>Calibration Report</h2>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary">Generate Report</button>
                <button class="btn btn-success">Download PDF</button>
                <button class="btn btn-secondary">Print</button>
            </div>

            <div id="reportContent" class="report-section">
                <!-- Report content will be generated here -->
            </div>
        </div>
    </div>
</body>
</html>