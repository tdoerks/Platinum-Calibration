<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Calibration Service - Calibrations International</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî¨</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            color: #020202;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #223077; /* Cal Intl Navy */
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1em;
        }

        .header .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 9999px; /* Cal Intl style */
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #69B135; /* Cal Intl Green */
            color: white;
        }

        .btn-primary:hover {
            background: #5a9a2d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(105,177,53,0.3);
        }

        .btn-secondary {
            background: #32373c; /* Cal Intl Charcoal */
            color: white;
        }

        .btn-secondary:hover {
            background: #23282d;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-tabs {
            background: #f8f9fa;
            display: flex;
            border-bottom: 3px solid #223077;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #32373c;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(105,177,53,0.1);
            color: #223077;
        }

        .nav-tab.active {
            background: white;
            color: #223077;
            border-bottom-color: #69B135;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #223077;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #69B135;
        }

        .pipette-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .pipette-card:hover {
            box-shadow: 0 4px 12px rgba(34,48,119,0.1);
        }

        .pipette-header {
            background: #223077;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pipette-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .pipette-body {
            padding: 20px;
        }

        .pipette-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #69B135;
        }

        .volume-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .volume-inputs input {
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
        }

        .volume-inputs input:focus {
            outline: none;
            border-color: #69B135;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pass {
            background: #d4edda;
            color: #155724;
        }

        .status-fail {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #69B135 0%, #5a9a2d 100%);
            transition: width 0.3s ease;
        }

        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #69B135;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 9999;
        }

        .save-indicator.show {
            opacity: 1;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #dee2e6;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            color: #223077;
            margin-bottom: 10px;
        }

        .modal-message {
            font-size: 16px;
            color: #32373c;
            line-height: 1.5;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Table View Styles */
        .table-container {
            overflow-x: auto;
        }

        .pipette-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .pipette-table th {
            background: #223077;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        .pipette-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .pipette-table tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .pipette-table tr:nth-child(even) {
            background: #fafbfc;
        }

        .pipette-table tr:nth-child(even):hover {
            background: #f1f3f5;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .header .controls,
            .nav-tabs,
            .btn {
                display: none !important;
            }
            .container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div id="saveIndicator" class="save-indicator">Saved ‚úì</div>

    <!-- Modal -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" class="modal-title">Notice</h2>
            </div>
            <p id="modalMessage" class="modal-message"></p>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button id="modalConfirmBtn" class="btn btn-primary" style="display: none;">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let pipettes = [];
        let currentPipetteId = 0;
        let currentSessionId = null;
        let saveTimeout = null;
        let undoStack = [];
        let redoStack = [];
        const MAX_HISTORY = 20;

        // ========================================
        // MODAL FUNCTIONS
        // ========================================

        function showAlert(message, title = 'Notice') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalConfirmBtn').style.display = 'none';
            document.querySelector('.modal-footer .btn-secondary').textContent = 'OK';
            document.getElementById('customModal').style.display = 'flex';
        }

        function showConfirm(message, title = 'Confirm', onConfirm) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalConfirmBtn').style.display = 'block';
            document.querySelector('.modal-footer .btn-secondary').textContent = 'Cancel';

            const confirmBtn = document.getElementById('modalConfirmBtn');
            confirmBtn.onclick = () => {
                onConfirm();
                closeModal();
            };

            document.getElementById('customModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
        }

        // ========================================
        // PASSWORD PROTECTION
        // ========================================

        const CALIBRATION_PASSWORD = 'calintl2024';

        function checkPassword() {
            if (sessionStorage.getItem('basicCalAuth') === 'authenticated') {
                return true;
            }

            const password = prompt('Enter password to access Basic Calibration System:');

            if (password === CALIBRATION_PASSWORD) {
                sessionStorage.setItem('basicCalAuth', 'authenticated');
                return true;
            } else if (password === null) {
                document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-family: Arial; font-size: 24px; color: #666;">Access Denied - Password Required</div>';
                return false;
            } else {
                showAlert('Incorrect password. Access denied.', 'Access Denied');
                document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-family: Arial; font-size: 24px; color: #666;">Access Denied - Incorrect Password</div>';
                return false;
            }
        }

        function logout() {
            showConfirm("Logout and clear authentication?", "Logout", () => {
                sessionStorage.removeItem('basicCalAuth');
                location.reload();
            });
        }

        // ========================================
        // TAB NAVIGATION
        // ========================================

        function showTab(tabName, tabButton) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            if (tabButton) tabButton.classList.add('active');

            // Update table view if switching to summary
            if (tabName === 'summary') {
                updateSummaryTable();
            }

            // Update report if switching to report
            if (tabName === 'report') {
                generateReport();
            }
        }

        // ========================================
        // UNDO/REDO SYSTEM
        // ========================================

        function saveStateForUndo(actionDescription) {
            const state = {
                pipettes: JSON.parse(JSON.stringify(pipettes)),
                currentPipetteId: currentPipetteId,
                sessionInfo: getSessionInfo(),
                action: actionDescription,
                timestamp: Date.now()
            };

            undoStack.push(state);

            if (undoStack.length > MAX_HISTORY) {
                undoStack.shift();
            }

            redoStack = [];
            updateUndoRedoButtons();
        }

        function undo() {
            if (undoStack.length === 0) return;

            const currentState = {
                pipettes: JSON.parse(JSON.stringify(pipettes)),
                currentPipetteId: currentPipetteId,
                sessionInfo: getSessionInfo(),
                timestamp: Date.now()
            };
            redoStack.push(currentState);

            const previousState = undoStack.pop();
            pipettes = previousState.pipettes;
            currentPipetteId = previousState.currentPipetteId;

            Object.keys(previousState.sessionInfo).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = previousState.sessionInfo[key] || '';
                }
            });

            renderAllPipettes();
            updateProgress();
            autoSave();
            updateUndoRedoButtons();
        }

        function redo() {
            if (redoStack.length === 0) return;

            const currentState = {
                pipettes: JSON.parse(JSON.stringify(pipettes)),
                currentPipetteId: currentPipetteId,
                sessionInfo: getSessionInfo(),
                action: 'Redo',
                timestamp: Date.now()
            };
            undoStack.push(currentState);

            const nextState = redoStack.pop();
            pipettes = nextState.pipettes;
            currentPipetteId = nextState.currentPipetteId;

            Object.keys(nextState.sessionInfo).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = nextState.sessionInfo[key] || '';
                }
            });

            renderAllPipettes();
            updateProgress();
            autoSave();
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');

            if (undoBtn) {
                undoBtn.disabled = undoStack.length === 0;
                undoBtn.title = undoStack.length > 0 ? `Undo: ${undoStack[undoStack.length - 1].action}` : 'Nothing to undo';
            }

            if (redoBtn) {
                redoBtn.disabled = redoStack.length === 0;
                redoBtn.title = redoStack.length > 0 ? 'Redo last action' : 'Nothing to redo';
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
                e.preventDefault();
                redo();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                e.preventDefault();
                redo();
            }
        });

        // ========================================
        // AUTOSAVE SYSTEM
        // ========================================

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function autoSave() {
            if (!currentSessionId) {
                currentSessionId = generateSessionId();
            }

            const sessionData = {
                id: currentSessionId,
                sessionInfo: getSessionInfo(),
                pipettes: pipettes,
                currentPipetteId: currentPipetteId,
                timestamp: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };

            try {
                localStorage.setItem('currentBasicSession', JSON.stringify(sessionData));

                let sessions = JSON.parse(localStorage.getItem('basicCalSessions') || '[]');
                const existingIndex = sessions.findIndex(s => s.id === currentSessionId);

                if (existingIndex >= 0) {
                    sessions[existingIndex] = sessionData;
                } else {
                    sessions.unshift(sessionData);
                }

                if (sessions.length > 50) {
                    sessions = sessions.slice(0, 50);
                }

                localStorage.setItem('basicCalSessions', JSON.stringify(sessions));
                showSaveIndicator();
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    showAlert('Storage quota exceeded! Please download a backup.', 'Storage Warning');
                } else {
                    console.error('Error saving session:', error);
                }
            }
        }

        function debouncedAutoSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                autoSave();
            }, 500);
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        function loadCurrentSession() {
            const savedSession = localStorage.getItem('currentBasicSession');
            if (!savedSession) return false;

            try {
                const sessionData = JSON.parse(savedSession);
                currentSessionId = sessionData.id;
                pipettes = sessionData.pipettes || [];
                currentPipetteId = sessionData.currentPipetteId || 0;

                const sessionInfo = sessionData.sessionInfo || {};
                Object.keys(sessionInfo).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = sessionInfo[key] || '';
                    }
                });

                renderAllPipettes();
                updateProgress();
                return true;
            } catch (error) {
                console.error('Error loading session:', error);
                return false;
            }
        }

        // Save before window closes
        window.addEventListener('beforeunload', (e) => {
            if (pipettes.length > 0) {
                autoSave();
            }
        });

        // ========================================
        // BACKUP REMINDER SYSTEM
        // ========================================

        function checkBackupReminder() {
            const BACKUP_REMINDER_DAYS = 7;
            const DISMISS_DURATION_MS = 24 * 60 * 60 * 1000; // 24 hours

            const lastBackup = localStorage.getItem('lastBackupDate');
            const dismissedUntil = localStorage.getItem('backupReminderDismissedUntil');

            // Check if reminder is currently dismissed
            if (dismissedUntil && Date.now() < parseInt(dismissedUntil)) {
                return; // Don't show reminder yet
            }

            // Check if backup is needed
            const now = Date.now();
            const daysSinceBackup = lastBackup ? (now - parseInt(lastBackup)) / (1000 * 60 * 60 * 24) : 999;

            if (daysSinceBackup > BACKUP_REMINDER_DAYS) {
                showBackupReminder();
            }
        }

        function showBackupReminder() {
            // Remove any existing reminder
            const existing = document.getElementById('backupReminder');
            if (existing) existing.remove();

            const banner = document.createElement('div');
            banner.id = 'backupReminder';
            banner.style.cssText = `
                position: fixed;
                top: 70px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
                color: #2d3436;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 9999;
                display: flex;
                align-items: center;
                gap: 15px;
                max-width: 600px;
                animation: slideDown 0.3s ease;
                font-size: 14px;
                font-weight: 500;
            `;

            banner.innerHTML = `
                <span style="font-size: 24px;">‚ö†Ô∏è</span>
                <div style="flex: 1;">
                    <strong>Backup Reminder:</strong> It's been over 7 days since your last backup.
                    <br><small>Download your data to prevent loss.</small>
                </div>
                <button onclick="downloadBackupAndDismiss()" class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;">
                    üì• Download Backup
                </button>
                <button onclick="dismissBackupReminder()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">
                    Dismiss 24h
                </button>
                <button onclick="closeBackupReminder()" style="padding: 4px 8px; background: transparent; border: none; cursor: pointer; font-size: 18px;">
                    ‚úï
                </button>
            `;

            document.body.appendChild(banner);
        }

        function downloadBackupAndDismiss() {
            saveSession(); // Trigger download
            closeBackupReminder();
        }

        function dismissBackupReminder() {
            const dismissUntil = Date.now() + (24 * 60 * 60 * 1000); // 24 hours from now
            localStorage.setItem('backupReminderDismissedUntil', dismissUntil.toString());
            closeBackupReminder();
        }

        function closeBackupReminder() {
            const banner = document.getElementById('backupReminder');
            if (banner) {
                banner.remove();
            }
        }

        // ========================================
        // AUTOFILL SYSTEM FOR COMMON VALUES
        // ========================================

        function saveRecentValue(fieldName, value) {
            if (!value || value.trim() === '') return;

            const recentValues = JSON.parse(localStorage.getItem('recentBasicCalValues') || '{}');

            if (!recentValues[fieldName]) {
                recentValues[fieldName] = [];
            }

            // Remove duplicate if exists
            recentValues[fieldName] = recentValues[fieldName].filter(v => v !== value);

            // Add to front
            recentValues[fieldName].unshift(value);

            // Keep only last 5 unique values
            recentValues[fieldName] = recentValues[fieldName].slice(0, 5);

            localStorage.setItem('recentBasicCalValues', JSON.stringify(recentValues));
        }

        function getRecentValues(fieldName) {
            const recentValues = JSON.parse(localStorage.getItem('recentBasicCalValues') || '{}');
            return recentValues[fieldName] || [];
        }

        function setupAutofill() {
            const autofillFields = ['technician', 'pi', 'contact', 'company'];

            autofillFields.forEach(fieldName => {
                const input = document.getElementById(fieldName);
                if (!input) return;

                // Create datalist if doesn't exist
                let datalist = document.getElementById(`${fieldName}List`);
                if (!datalist) {
                    datalist = document.createElement('datalist');
                    datalist.id = `${fieldName}List`;
                    input.setAttribute('list', `${fieldName}List`);
                    input.parentNode.appendChild(datalist);
                }

                // Populate datalist with recent values
                const recentValues = getRecentValues(fieldName);
                datalist.innerHTML = recentValues.map(value =>
                    `<option value="${value}">`
                ).join('');

                // Save value when changed
                input.addEventListener('change', () => {
                    saveRecentValue(fieldName, input.value);
                    // Update datalist
                    const updated = getRecentValues(fieldName);
                    datalist.innerHTML = updated.map(value =>
                        `<option value="${value}">`
                    ).join('');
                });
            });

            // Also setup autofill for manufacturer and model on pipette cards (will apply to new cards)
            // This is handled when pipettes are created
        }

        // ========================================
        // PIPETTE MANAGEMENT
        // ========================================

        function addPipette() {
            saveStateForUndo('Add pipette');
            currentPipetteId++;

            const pipette = {
                id: currentPipetteId,
                number: String(currentPipetteId).padStart(2, '0'),
                manufacturer: '',
                model: '',
                maxVolume: '',
                inSpec: false,
                outSpec: false,
                adjustments: {
                    SE: false,  // Replace Seal
                    COR: false, // Corrosion
                    G: false,   // Grease
                    SH: false,  // Shaft
                    FR: false,  // Friction Ring
                    O: false,   // O Ring
                    OTHER: ''   // Other text field
                },
                finalVolumes: ['', '', '', ''],
                passFail: '',
                comments: ''
            };

            pipettes.push(pipette);
            renderPipette(pipette);
            updateProgress();
            updateEmptyState();
            debouncedAutoSave();
        }

        function renderPipette(pipette) {
            const container = document.getElementById('pipettesContainer');

            const card = document.createElement('div');
            card.className = 'pipette-card';
            card.id = `pipette-${pipette.id}`;

            card.innerHTML = `
                <div class="pipette-header">
                    <h3>Pipette #${pipette.number}</h3>
                    <button class="btn btn-danger" onclick="removePipette(${pipette.id})" style="padding: 6px 12px; font-size: 12px;">
                        ‚úï Remove
                    </button>
                </div>
                <div class="pipette-body">
                    <!-- Manufacturer and Model -->
                    <div class="pipette-row">
                        <div class="form-group">
                            <label>Manufacturer</label>
                            <input type="text" id="mfr-${pipette.id}" value="${pipette.manufacturer}"
                                   onchange="updatePipetteField(${pipette.id}, 'manufacturer', this.value)"
                                   list="manufacturerList" placeholder="e.g., Eppendorf">
                        </div>
                        <div class="form-group">
                            <label>Model</label>
                            <input type="text" id="model-${pipette.id}" value="${pipette.model}"
                                   onchange="updatePipetteField(${pipette.id}, 'model', this.value)"
                                   list="modelList" placeholder="e.g., Research Plus">
                        </div>
                        <div class="form-group">
                            <label>Max Volume (¬µL)</label>
                            <input type="number" id="vol-${pipette.id}" value="${pipette.maxVolume}"
                                   onchange="updatePipetteField(${pipette.id}, 'maxVolume', this.value)"
                                   placeholder="e.g., 100">
                        </div>
                    </div>

                    <!-- In Spec / Out Spec -->
                    <div class="pipette-row">
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="inspec-${pipette.id}"
                                       ${pipette.inSpec ? 'checked' : ''}
                                       onchange="updatePipetteCheckbox(${pipette.id}, 'inSpec', this.checked)">
                                <strong style="color: #69B135;">‚úì IN SPEC</strong>
                            </label>
                            <label>
                                <input type="checkbox" id="outspec-${pipette.id}"
                                       ${pipette.outSpec ? 'checked' : ''}
                                       onchange="updatePipetteCheckbox(${pipette.id}, 'outSpec', this.checked)">
                                <strong style="color: #dc3545;">‚úó OUT SPEC</strong>
                            </label>
                        </div>
                    </div>

                    <!-- Adjustments & Repairs -->
                    <div class="pipette-row">
                        <div style="grid-column: 1 / -1;">
                            <label style="font-weight: 600; color: #223077; margin-bottom: 8px; display: block;">
                                Adjustments & Repairs
                            </label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="adj-SE-${pipette.id}" ${pipette.adjustments.SE ? 'checked' : ''} onchange="updateAdjustment(${pipette.id}, 'SE', this.checked)"> SE</label>
                                <label><input type="checkbox" id="adj-COR-${pipette.id}" ${pipette.adjustments.COR ? 'checked' : ''} onchange="updateAdjustment(${pipette.id}, 'COR', this.checked)"> COR</label>
                                <label><input type="checkbox" id="adj-G-${pipette.id}" ${pipette.adjustments.G ? 'checked' : ''} onchange="updateAdjustment(${pipette.id}, 'G', this.checked)"> G</label>
                                <label><input type="checkbox" id="adj-SH-${pipette.id}" ${pipette.adjustments.SH ? 'checked' : ''} onchange="updateAdjustment(${pipette.id}, 'SH', this.checked)"> SH</label>
                                <label><input type="checkbox" id="adj-FR-${pipette.id}" ${pipette.adjustments.FR ? 'checked' : ''} onchange="updateAdjustment(${pipette.id}, 'FR', this.checked)"> FR</label>
                                <label><input type="checkbox" id="adj-O-${pipette.id}" ${pipette.adjustments.O ? 'checked' : ''} onchange="updateAdjustment(${pipette.id}, 'O', this.checked)"> O</label>
                                <input type="text" id="adj-OTHER-${pipette.id}" value="${pipette.adjustments.OTHER}"
                                       onchange="updateAdjustment(${pipette.id}, 'OTHER', this.value)"
                                       placeholder="Other..." style="padding: 6px 10px; border: 2px solid #e9ecef; border-radius: 6px; width: 120px;">
                            </div>
                        </div>
                    </div>

                    <!-- Final Corrected Volumes -->
                    <div class="pipette-row">
                        <div style="grid-column: 1 / -1;">
                            <label style="font-weight: 600; color: #223077; margin-bottom: 8px; display: block;">
                                Final Corrected Volumes (¬µL)
                            </label>
                            <div class="volume-inputs">
                                <input type="number" step="0.001" id="vol1-${pipette.id}" value="${pipette.finalVolumes[0]}"
                                       onchange="updateFinalVolume(${pipette.id}, 0, this.value)" placeholder="Sample 1">
                                <input type="number" step="0.001" id="vol2-${pipette.id}" value="${pipette.finalVolumes[1]}"
                                       onchange="updateFinalVolume(${pipette.id}, 1, this.value)" placeholder="Sample 2">
                                <input type="number" step="0.001" id="vol3-${pipette.id}" value="${pipette.finalVolumes[2]}"
                                       onchange="updateFinalVolume(${pipette.id}, 2, this.value)" placeholder="Sample 3">
                                <input type="number" step="0.001" id="vol4-${pipette.id}" value="${pipette.finalVolumes[3]}"
                                       onchange="updateFinalVolume(${pipette.id}, 3, this.value)" placeholder="Sample 4">
                            </div>
                        </div>
                    </div>

                    <!-- Pass/Fail and Comments -->
                    <div class="pipette-row">
                        <div class="form-group">
                            <label>Final Status</label>
                            <select id="pf-${pipette.id}" onchange="updatePipetteField(${pipette.id}, 'passFail', this.value)">
                                <option value="">-- Select --</option>
                                <option value="P" ${pipette.passFail === 'P' ? 'selected' : ''}>‚úì PASS</option>
                                <option value="F" ${pipette.passFail === 'F' ? 'selected' : ''}>‚úó FAIL</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label>Comments</label>
                            <input type="text" id="comments-${pipette.id}" value="${pipette.comments}"
                                   onchange="updatePipetteField(${pipette.id}, 'comments', this.value)"
                                   placeholder="Optional notes...">
                        </div>
                    </div>

                    ${pipette.passFail ? `<div style="margin-top: 10px; text-align: right;">
                        <span class="status-indicator status-${pipette.passFail === 'P' ? 'pass' : 'fail'}">
                            ${pipette.passFail === 'P' ? '‚úì PASS' : '‚úó FAIL'}
                        </span>
                    </div>` : ''}
                </div>
            `;

            container.appendChild(card);
        }

        function renderAllPipettes() {
            const container = document.getElementById('pipettesContainer');
            container.innerHTML = '';
            pipettes.forEach(pipette => renderPipette(pipette));
            updateEmptyState();
        }

        function removePipette(pipetteId) {
            saveStateForUndo('Remove pipette');
            pipettes = pipettes.filter(p => p.id !== pipetteId);
            const element = document.getElementById(`pipette-${pipetteId}`);
            if (element) element.remove();
            updateEmptyState();
            updateProgress();
            debouncedAutoSave();
        }

        function updatePipetteField(pipetteId, field, value) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                pipette[field] = value;

                // Re-render status indicator if Pass/Fail changed
                if (field === 'passFail') {
                    renderAllPipettes();
                }

                debouncedAutoSave();
            }
        }

        function updatePipetteCheckbox(pipetteId, field, checked) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                pipette[field] = checked;
                debouncedAutoSave();
            }
        }

        function updateAdjustment(pipetteId, adjustmentType, value) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                pipette.adjustments[adjustmentType] = value;
                debouncedAutoSave();
            }
        }

        function updateFinalVolume(pipetteId, index, value) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                pipette.finalVolumes[index] = value;
                debouncedAutoSave();
            }
        }

        function updateEmptyState() {
            const container = document.getElementById('pipettesContainer');
            if (pipettes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3 style="color: #6c757d; margin-bottom: 10px;">No Pipettes Added Yet</h3>
                        <p style="color: #adb5bd; margin-bottom: 30px;">Click "+ Add Pipette" to start your calibration</p>
                        <button class="btn btn-primary" onclick="addPipette()">
                            ‚ûï Add Your First Pipette
                        </button>
                    </div>
                `;
            }
        }

        function updateProgress() {
            if (pipettes.length === 0) {
                document.getElementById('progressFill').style.width = '0%';
                return;
            }

            const completed = pipettes.filter(p => p.passFail !== '').length;
            const progress = (completed / pipettes.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        function updateSummaryTable() {
            const tbody = document.getElementById('summaryTableBody');

            if (pipettes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #6c757d;">
                            No pipettes to display. Add pipettes in the Calibration tab.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pipettes.map(p => {
                const adjustments = Object.entries(p.adjustments)
                    .filter(([key, val]) => val === true || (key === 'OTHER' && val !== ''))
                    .map(([key, val]) => key === 'OTHER' ? val : key)
                    .join(', ') || 'None';

                const volumes = p.finalVolumes.filter(v => v !== '').join(', ') || '--';

                return `
                    <tr onclick="jumpToPipette(${p.id})">
                        <td><strong>${p.number}</strong></td>
                        <td>${p.manufacturer || '--'}</td>
                        <td>${p.model || '--'}</td>
                        <td>${p.maxVolume || '--'}</td>
                        <td>${p.inSpec ? '‚úì' : ''}</td>
                        <td>${p.outSpec ? '‚úì' : ''}</td>
                        <td><small>${adjustments}</small></td>
                        <td><small>${volumes}</small></td>
                        <td>
                            ${p.passFail ? `<span class="status-indicator status-${p.passFail === 'P' ? 'pass' : 'fail'}">
                                ${p.passFail}
                            </span>` : '--'}
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); jumpToPipette(${p.id})"
                                    style="padding: 4px 8px; font-size: 12px;">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function jumpToPipette(pipetteId) {
            // Switch to calibration tab
            showTab('calibration', document.querySelectorAll('.nav-tab')[1]);

            // Scroll to pipette card
            setTimeout(() => {
                const element = document.getElementById(`pipette-${pipetteId}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    element.style.boxShadow = '0 0 0 3px #69B135';
                    setTimeout(() => {
                        element.style.boxShadow = '';
                    }, 2000);
                }
            }, 100);
        }

        function newSession() {
            showConfirm("Start a new session? Current work will be saved.", "New Session", () => {
                // Auto-save current session
                autoSave();

                // Reset
                pipettes = [];
                currentPipetteId = 0;
                currentSessionId = null;

                // Clear form fields
                document.querySelectorAll('#session input').forEach(input => {
                    if (!['balanceModel', 'balanceSerial', 'technician'].includes(input.id)) {
                        input.value = '';
                    }
                });

                renderAllPipettes();
                updateProgress();
                showAlert('New session started', 'Success');
            });
        }

        function saveSession() {
            const sessionData = {
                sessionInfo: getSessionInfo(),
                pipettes: pipettes,
                timestamp: new Date().toISOString()
            };

            const dataStr = JSON.stringify(sessionData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `basic_calibration_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // Record backup timestamp
            localStorage.setItem('lastBackupDate', Date.now().toString());

            showAlert('Session saved successfully!', 'Success');
        }

        function getSessionInfo() {
            return {
                pi: document.getElementById('pi')?.value || '',
                contact: document.getElementById('contact')?.value || '',
                phone: document.getElementById('phone')?.value || '',
                invoiceNo: document.getElementById('invoiceNo')?.value || '',
                technician: document.getElementById('technician')?.value || '',
                company: document.getElementById('company')?.value || '',
                serviceDate: document.getElementById('serviceDate')?.value || '',
                nextServiceDue: document.getElementById('nextServiceDue')?.value || '',
                balanceModel: document.getElementById('balanceModel')?.value || '',
                balanceSerial: document.getElementById('balanceSerial')?.value || '',
                balanceCalDue: document.getElementById('balanceCalDue')?.value || ''
            };
        }

        function importFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const sessionData = JSON.parse(event.target.result);

                        if (!sessionData || !Array.isArray(sessionData.pipettes)) {
                            throw new Error('Invalid file format');
                        }

                        showConfirm("Load this session? Current work will be saved.", "Import Session", () => {
                            autoSave();

                            pipettes = sessionData.pipettes || [];
                            currentPipetteId = sessionData.currentPipetteId || pipettes.length;

                            const sessionInfo = sessionData.sessionInfo || {};
                            Object.keys(sessionInfo).forEach(key => {
                                const element = document.getElementById(key);
                                if (element) {
                                    element.value = sessionInfo[key] || '';
                                }
                            });

                            renderAllPipettes();
                            updateProgress();
                            autoSave();
                            showAlert('Session imported successfully!', 'Success');
                        });
                    } catch (error) {
                        showAlert('Error importing file: ' + error.message, 'Import Error');
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        function generateReport() {
            const reportContent = document.getElementById('reportContent');
            const sessionInfo = getSessionInfo();

            if (pipettes.length === 0) {
                reportContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <h3 style="color: #6c757d;">No Data to Display</h3>
                        <p style="color: #adb5bd;">Add pipettes in the Calibration tab to generate a report.</p>
                    </div>
                `;
                return;
            }

            // Calculate summary statistics
            const totalPipettes = pipettes.length;
            const passedPipettes = pipettes.filter(p => p.passFail === 'P').length;
            const failedPipettes = pipettes.filter(p => p.passFail === 'F').length;
            const inSpecCount = pipettes.filter(p => p.inSpec).length;
            const outSpecCount = pipettes.filter(p => p.outSpec).length;
            const adjustmentsCount = pipettes.filter(p =>
                Object.values(p.adjustments).some(v => v === true || (typeof v === 'string' && v !== ''))
            ).length;

            const certNumber = `BC-${new Date(sessionInfo.serviceDate || Date.now()).getFullYear()}-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`;

            reportContent.innerHTML = `
                <div style="max-width: 900px; margin: 0 auto; background: white; padding: 40px; border: 1px solid #e9ecef; border-radius: 8px;">

                    <!-- Professional Header -->
                    <div style="border-bottom: 4px solid #223077; padding-bottom: 20px; margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 20px;">
                            <div>
                                <h1 style="color: #223077; font-size: 28px; margin-bottom: 5px;">CALIBRATION INTERNATIONAL INC.</h1>
                                <p style="color: #69B135; font-size: 18px; font-weight: 600; margin: 0;">Basic Calibration Service Report</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #69B135;">
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">CERTIFICATE NO.</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #223077;">${certNumber}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Executive Summary -->
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; border-left: 5px solid #69B135;">
                        <h2 style="color: #223077; font-size: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            üìä Executive Summary
                        </h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="font-size: 32px; font-weight: bold; color: #223077; margin-bottom: 5px;">${totalPipettes}</div>
                                <div style="font-size: 12px; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px;">Total Pipettes</div>
                            </div>
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="font-size: 32px; font-weight: bold; color: #28a745; margin-bottom: 5px;">${passedPipettes}</div>
                                <div style="font-size: 12px; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px;">Passed</div>
                            </div>
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="font-size: 32px; font-weight: bold; color: #dc3545; margin-bottom: 5px;">${failedPipettes}</div>
                                <div style="font-size: 12px; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px;">Failed</div>
                            </div>
                            <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="font-size: 32px; font-weight: bold; color: #ffc107; margin-bottom: 5px;">${adjustmentsCount}</div>
                                <div style="font-size: 12px; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px;">Adjustments</div>
                            </div>
                        </div>
                    </div>

                    <!-- Session Information -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #223077; font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                            üìã Service Information
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 14px;">
                            <div><strong style="color: #223077;">PI:</strong> ${sessionInfo.pi || 'N/A'}</div>
                            <div><strong style="color: #223077;">Contact:</strong> ${sessionInfo.contact || 'N/A'}</div>
                            <div><strong style="color: #223077;">Phone:</strong> ${sessionInfo.phone || 'N/A'}</div>
                            <div><strong style="color: #223077;">Invoice #:</strong> ${sessionInfo.invoiceNo || 'N/A'}</div>
                            <div><strong style="color: #223077;">Company:</strong> ${sessionInfo.company || 'N/A'}</div>
                            <div><strong style="color: #223077;">Technician:</strong> ${sessionInfo.technician || 'N/A'}</div>
                            <div><strong style="color: #223077;">Service Date:</strong> ${sessionInfo.serviceDate ? new Date(sessionInfo.serviceDate).toLocaleDateString() : 'N/A'}</div>
                            <div><strong style="color: #223077;">Next Service Due:</strong> ${sessionInfo.nextServiceDue ? new Date(sessionInfo.nextServiceDue).toLocaleDateString() : 'N/A'}</div>
                        </div>
                    </div>

                    <!-- Balance Information -->
                    <div style="margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h3 style="color: #223077; font-size: 18px; margin-bottom: 15px;">‚öñÔ∏è Balance Information</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; font-size: 14px;">
                            <div><strong style="color: #223077;">Model:</strong> ${sessionInfo.balanceModel || 'N/A'}</div>
                            <div><strong style="color: #223077;">Serial #:</strong> ${sessionInfo.balanceSerial || 'N/A'}</div>
                            <div><strong style="color: #223077;">Cal Due:</strong> ${sessionInfo.balanceCalDue ? new Date(sessionInfo.balanceCalDue).toLocaleDateString() : 'N/A'}</div>
                        </div>
                        <p style="font-size: 12px; color: #6c757d; margin-top: 10px; margin-bottom: 0;">
                            ‚ÑπÔ∏è An Internal Q.C. Calibration check was performed by CALINTL Technician on Balance noted, prior to calibration of pipettes on this date.
                        </p>
                    </div>

                    <!-- Detailed Results Table -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #223077; font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                            üî¨ Detailed Calibration Results
                        </h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: #223077; color: white;">
                                        <th style="padding: 12px 8px; text-align: left; border: 1px solid #223077;">No.</th>
                                        <th style="padding: 12px 8px; text-align: left; border: 1px solid #223077;">Manufacturer/Model</th>
                                        <th style="padding: 12px 8px; text-align: center; border: 1px solid #223077;">Vol (¬µL)</th>
                                        <th style="padding: 12px 8px; text-align: center; border: 1px solid #223077;">Spec</th>
                                        <th style="padding: 12px 8px; text-align: left; border: 1px solid #223077;">Adjustments</th>
                                        <th style="padding: 12px 8px; text-align: left; border: 1px solid #223077;">Final Volumes (¬µL)</th>
                                        <th style="padding: 12px 8px; text-align: center; border: 1px solid #223077;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pipettes.map((p, index) => {
                                        const adjustments = Object.entries(p.adjustments)
                                            .filter(([key, val]) => val === true || (key === 'OTHER' && val !== ''))
                                            .map(([key, val]) => key === 'OTHER' ? val : key)
                                            .join(', ') || '--';

                                        const volumes = p.finalVolumes.filter(v => v !== '').join(', ') || '--';
                                        const specStatus = p.inSpec ? '‚úì In' : (p.outSpec ? '‚úó Out' : '--');
                                        const bgColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';

                                        return `
                                            <tr style="background: ${bgColor};">
                                                <td style="padding: 10px 8px; border: 1px solid #e9ecef;"><strong>${p.number}</strong></td>
                                                <td style="padding: 10px 8px; border: 1px solid #e9ecef;">${p.manufacturer || '--'} ${p.model || ''}</td>
                                                <td style="padding: 10px 8px; text-align: center; border: 1px solid #e9ecef;">${p.maxVolume || '--'}</td>
                                                <td style="padding: 10px 8px; text-align: center; border: 1px solid #e9ecef; color: ${p.inSpec ? '#28a745' : (p.outSpec ? '#dc3545' : '#6c757d')};">
                                                    ${specStatus}
                                                </td>
                                                <td style="padding: 10px 8px; border: 1px solid #e9ecef; font-size: 11px;">${adjustments}</td>
                                                <td style="padding: 10px 8px; border: 1px solid #e9ecef; font-size: 11px;">${volumes}</td>
                                                <td style="padding: 10px 8px; text-align: center; border: 1px solid #e9ecef;">
                                                    ${p.passFail ? `
                                                        <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 11px;
                                                                     background: ${p.passFail === 'P' ? '#d4edda' : '#f8d7da'};
                                                                     color: ${p.passFail === 'P' ? '#155724' : '#721c24'};">
                                                            ${p.passFail === 'P' ? '‚úì PASS' : '‚úó FAIL'}
                                                        </span>
                                                    ` : '--'}
                                                </td>
                                            </tr>
                                            ${p.comments ? `
                                                <tr style="background: ${bgColor};">
                                                    <td colspan="7" style="padding: 8px; border: 1px solid #e9ecef; font-size: 12px; color: #6c757d;">
                                                        <strong>Note:</strong> ${p.comments}
                                                    </td>
                                                </tr>
                                            ` : ''}
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Adjustments Legend -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h4 style="color: #223077; font-size: 14px; margin-bottom: 10px;">Adjustments & Repairs Legend:</h4>
                        <p style="font-size: 12px; color: #32373c; line-height: 1.6; margin: 0;">
                            <strong>SE</strong> = Seal Replacement |
                            <strong>COR</strong> = Corrosion |
                            <strong>G</strong> = Grease |
                            <strong>SH</strong> = Shaft |
                            <strong>FR</strong> = Friction Ring |
                            <strong>O</strong> = O-Ring
                        </p>
                    </div>

                    <!-- Certification Footer -->
                    <div style="border-top: 3px solid #69B135; padding-top: 20px; margin-top: 40px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <p style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Verified By:</p>
                                <div style="border-bottom: 2px solid #223077; padding-bottom: 5px; margin-bottom: 20px;">
                                    <strong style="color: #223077;">${sessionInfo.technician || '__________________'}</strong>
                                </div>
                            </div>
                            <div>
                                <p style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">Date:</p>
                                <div style="border-bottom: 2px solid #223077; padding-bottom: 5px; margin-bottom: 20px;">
                                    <strong style="color: #223077;">${sessionInfo.serviceDate ? new Date(sessionInfo.serviceDate).toLocaleDateString() : '__________'}</strong>
                                </div>
                            </div>
                        </div>

                        <div style="background: #e7f3ff; border-left: 4px solid #0066cc; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <p style="font-size: 11px; color: #004080; margin: 0; line-height: 1.5;">
                                <strong>ISO 8655-2:2002 Compliance:</strong> CALINTL Technician calibrated pipettes to meet ISO 8655-2:2002 standards.
                                Balance Calibration Certificate indicating NIST Traceable available upon request.
                            </p>
                        </div>

                        <div style="text-align: center; padding-top: 10px; border-top: 1px solid #e9ecef;">
                            <p style="font-size: 11px; color: #6c757d; margin: 0;">
                                <strong>CALIBRATIONS INTERNATIONAL INC.</strong><br>
                                2142 Chipset Street, Bozeman, Montana 59718<br>
                                Phone: 406-589-6025 | Toll Free: 1-877-225-4685<br>
                                theresa@calibrationsinternational.com
                            </p>
                        </div>
                    </div>

                </div>
            `;
        }

        function exportToCSV() {
            if (pipettes.length === 0) {
                showAlert('No pipettes to export.', 'Export CSV');
                return;
            }

            const sessionInfo = getSessionInfo();
            let csv = 'CALIBRATIONS INTERNATIONAL INC. - BASIC CALIBRATION SERVICE\n';
            csv += `Date: ${sessionInfo.serviceDate || new Date().toLocaleDateString()}\n`;
            csv += `Technician: ${sessionInfo.technician}\n`;
            csv += `Balance: ${sessionInfo.balanceModel} SN: ${sessionInfo.balanceSerial}\n\n`;

            csv += 'No.,Manufacturer,Model,Max Vol,In Spec,Out Spec,Adjustments,Sample 1,Sample 2,Sample 3,Sample 4,Pass/Fail,Comments\n';

            pipettes.forEach(p => {
                const adjustments = Object.entries(p.adjustments)
                    .filter(([key, val]) => val === true || (key === 'OTHER' && val !== ''))
                    .map(([key, val]) => key === 'OTHER' ? val : key)
                    .join('; ');

                csv += [
                    p.number,
                    p.manufacturer,
                    p.model,
                    p.maxVolume,
                    p.inSpec ? 'Yes' : 'No',
                    p.outSpec ? 'Yes' : 'No',
                    adjustments,
                    p.finalVolumes[0] || '',
                    p.finalVolumes[1] || '',
                    p.finalVolumes[2] || '',
                    p.finalVolumes[3] || '',
                    p.passFail,
                    p.comments
                ].map(val => `"${val}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `basic_calibration_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showAlert('CSV exported successfully!', 'Success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkPassword()) {
                return;
            }

            // Set up modal event listeners
            document.getElementById('customModal')?.addEventListener('click', (e) => {
                if (e.target.id === 'customModal') closeModal();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.getElementById('customModal')?.style.display === 'flex') {
                    closeModal();
                }
            });

            // Load saved session
            const sessionLoaded = loadCurrentSession();

            // Set default dates if no session
            if (!sessionLoaded) {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('serviceDate').value = today;

                const nextYear = new Date();
                nextYear.setFullYear(nextYear.getFullYear() + 1);
                document.getElementById('nextServiceDue').value = nextYear.toISOString().split('T')[0];

                const nextMonth = new Date();
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                document.getElementById('balanceCalDue').value = nextMonth.toISOString().split('T')[0];
            }

            // Setup autofill for common fields
            setupAutofill();

            // Check if backup reminder should be shown
            checkBackupReminder();

            // Load session history
            loadHistory();

            // Add autosave listeners to form fields
            document.querySelectorAll('#session input, #session select').forEach(input => {
                input.addEventListener('change', debouncedAutoSave);
            });

            console.log('Basic Calibration System initialized');
        });

        // ========================================
        // SESSION HISTORY
        // ========================================

        function loadHistory() {
            const sessions = JSON.parse(localStorage.getItem('basicCalSessions') || '[]');
            const historyContainer = document.getElementById('historyContainer');

            if (sessions.length === 0) {
                historyContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <h3 style="color: #6c757d;">No Previous Sessions</h3>
                        <p style="color: #adb5bd;">Your saved calibration sessions will appear here.</p>
                    </div>
                `;
                return;
            }

            historyContainer.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #6c757d; font-size: 14px;">
                        Found ${sessions.length} saved session${sessions.length > 1 ? 's' : ''}. Click any session to load it.
                    </p>
                </div>
                <div style="display: grid; gap: 15px;">
                    ${sessions.map((session, index) => {
                        const date = new Date(session.lastModified || session.timestamp);
                        const pipetteCount = session.pipettes?.length || 0;
                        const passCount = session.pipettes?.filter(p => p.passFail === 'P').length || 0;
                        const failCount = session.pipettes?.filter(p => p.passFail === 'F').length || 0;

                        return `
                            <div style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.3s ease;"
                                 onmouseover="this.style.borderColor='#69B135'; this.style.boxShadow='0 4px 12px rgba(105,177,53,0.2)'"
                                 onmouseout="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                                 onclick="loadSessionFromHistory('${session.id}')">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div>
                                        <h3 style="color: #223077; font-size: 16px; margin-bottom: 5px;">
                                            ${session.sessionInfo?.company || session.sessionInfo?.pi || `Session ${index + 1}`}
                                        </h3>
                                        <p style="color: #6c757d; font-size: 13px; margin: 0;">
                                            ${date.toLocaleString()}
                                        </p>
                                    </div>
                                    <button onclick="event.stopPropagation(); deleteSession('${session.id}')"
                                            class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 13px;">
                                    <div style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px;">
                                        <strong style="color: #223077;">${pipetteCount}</strong> Pipettes
                                    </div>
                                    ${passCount > 0 ? `
                                        <div style="background: #d4edda; padding: 8px 12px; border-radius: 6px; color: #155724;">
                                            <strong>${passCount}</strong> Passed
                                        </div>
                                    ` : ''}
                                    ${failCount > 0 ? `
                                        <div style="background: #f8d7da; padding: 8px 12px; border-radius: 6px; color: #721c24;">
                                            <strong>${failCount}</strong> Failed
                                        </div>
                                    ` : ''}
                                    ${session.sessionInfo?.technician ? `
                                        <div style="background: #e7f3ff; padding: 8px 12px; border-radius: 6px; color: #004080;">
                                            Tech: <strong>${session.sessionInfo.technician}</strong>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function loadSessionFromHistory(sessionId) {
            const sessions = JSON.parse(localStorage.getItem('basicCalSessions') || '[]');
            const session = sessions.find(s => s.id === sessionId);

            if (!session) {
                showAlert('Session not found.', 'Error');
                return;
            }

            showConfirm("Load this session? Current work will be saved.", "Load Session", () => {
                autoSave();

                currentSessionId = session.id;
                pipettes = session.pipettes || [];
                currentPipetteId = session.currentPipetteId || 0;

                const sessionInfo = session.sessionInfo || {};
                Object.keys(sessionInfo).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = sessionInfo[key] || '';
                    }
                });

                renderAllPipettes();
                updateProgress();
                autoSave();

                // Switch to calibration tab
                showTab('calibration', document.querySelectorAll('.nav-tab')[1]);

                showAlert('Session loaded successfully!', 'Success');
            });
        }

        function deleteSession(sessionId) {
            showConfirm("Delete this session permanently?", "Confirm Delete", () => {
                let sessions = JSON.parse(localStorage.getItem('basicCalSessions') || '[]');
                sessions = sessions.filter(s => s.id !== sessionId);
                localStorage.setItem('basicCalSessions', JSON.stringify(sessions));

                // Reload history
                loadHistory();

                showAlert('Session deleted.', 'Deleted');
            });
        }
    </script>
    </script>

    <div class="container">
        <div class="header">
            <h1>üî¨ Basic Calibration Service</h1>
            <p>CALIBRATIONS INTERNATIONAL INC. | ISO 8655-2:2002 Compliant</p>
            <div class="controls">
                <button id="undoBtn" onclick="undo()" disabled title="Nothing to undo" class="btn btn-secondary">‚Ü∂ Undo</button>
                <button id="redoBtn" onclick="redo()" disabled title="Nothing to redo" class="btn btn-secondary">‚Ü∑ Redo</button>
                <button onclick="logout()" class="btn btn-danger">üîí Logout</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('session', this)">üìã Session Info</button>
            <button class="nav-tab" onclick="showTab('calibration', this)">üîß Calibration</button>
            <button class="nav-tab" onclick="showTab('summary', this)">üìä Summary Table</button>
            <button class="nav-tab" onclick="showTab('report', this)">üìÑ Report</button>
            <button class="nav-tab" onclick="showTab('history', this)">üìö History</button>
        </div>

        <!-- Session Info Tab -->
        <div id="session" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #223077;">üìã Session Information</h2>
                <div>
                    <button class="btn btn-primary" onclick="newSession()">üÜï New Session</button>
                    <button class="btn btn-secondary" onclick="importFromFile()">üì• Import</button>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Principal Investigator</label>
                    <input type="text" id="pi" placeholder="PI Name">
                </div>
                <div class="form-group">
                    <label>Contact Person</label>
                    <input type="text" id="contact" placeholder="Contact Name">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="phone" placeholder="Phone Number">
                </div>
                <div class="form-group">
                    <label>Invoice Number</label>
                    <input type="text" id="invoiceNo" placeholder="Invoice #">
                </div>
                <div class="form-group">
                    <label>Technician</label>
                    <input type="text" id="technician" value="TSD" list="technicianList">
                </div>
                <div class="form-group">
                    <label>Company/University & Building</label>
                    <input type="text" id="company" placeholder="Company/Location">
                </div>
                <div class="form-group">
                    <label>Date of Service</label>
                    <input type="date" id="serviceDate">
                </div>
                <div class="form-group">
                    <label>Next Service Due</label>
                    <input type="date" id="nextServiceDue">
                </div>
            </div>

            <h3 style="color: #223077; margin: 30px 0 15px 0;">‚öñÔ∏è Balance Information</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Balance Model</label>
                    <input type="text" id="balanceModel" value="XS105DU">
                </div>
                <div class="form-group">
                    <label>Balance Serial Number</label>
                    <input type="text" id="balanceSerial" value="B621501811">
                </div>
                <div class="form-group">
                    <label>Balance Cal Due Date</label>
                    <input type="date" id="balanceCalDue">
                </div>
            </div>

            <button class="btn btn-primary" onclick="showTab('calibration', document.querySelectorAll('.nav-tab')[1])" style="margin-top: 20px;">
                Next: Start Calibration ‚Üí
            </button>
        </div>

        <!-- Calibration Tab -->
        <div id="calibration" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #223077;">üîß Pipette Calibration</h2>
                <button class="btn btn-primary" onclick="addPipette()">+ Add Pipette</button>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div id="pipettesContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <h3 style="color: #6c757d; margin-bottom: 10px;">No Pipettes Added Yet</h3>
                    <p style="color: #adb5bd; margin-bottom: 30px;">Click "+ Add Pipette" to start your calibration</p>
                    <button class="btn btn-primary" onclick="addPipette()">
                        ‚ûï Add Your First Pipette
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Table Tab -->
        <div id="summary" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #223077;">üìä Summary Table</h2>
                <button class="btn btn-secondary" onclick="exportToCSV()">üì• Export CSV</button>
            </div>

            <div class="table-container">
                <table class="pipette-table" id="summaryTable">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Manufacturer</th>
                            <th>Model</th>
                            <th>Max Vol</th>
                            <th>In Spec</th>
                            <th>Out Spec</th>
                            <th>Adjustments</th>
                            <th>Final Volumes</th>
                            <th>P/F</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 40px; color: #6c757d;">
                                No pipettes to display. Add pipettes in the Calibration tab.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Report Tab -->
        <div id="report" class="tab-content">
            <h2 style="color: #223077;">üìÑ Report</h2>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print Report</button>
                <button class="btn btn-secondary" onclick="saveSession()">üíæ Save JSON</button>
            </div>
            <div id="reportContent" style="margin-top: 30px;">
                <!-- Report will be generated here -->
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <h2 style="color: #223077;">üìö Session History</h2>
            <div id="historyContainer" style="margin-top: 20px;">
                <p style="color: #6c757d;">No previous sessions found.</p>
            </div>
        </div>
    </div>
</body>
</html>
