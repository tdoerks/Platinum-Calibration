<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calibrations International - Data Intake System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß™</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        body.dark-mode .container {
            background: #0f3460;
            color: #e6e6e6;
        }

        body.dark-mode .header {
            background: #16213e;
        }

        body.dark-mode .nav-tab {
            background: #1a1a2e;
            color: #e6e6e6;
        }

        body.dark-mode .nav-tab.active {
            background: #16537e;
            color: white;
        }

        body.dark-mode .tab-content {
            background: #0f3460;
            color: #e6e6e6;
        }

        body.dark-mode .pipette-card {
            background: #16213e;
            border-color: #1a1a2e;
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background: #1a1a2e;
            color: #e6e6e6;
            border-color: #2c3e50;
        }

        body.dark-mode table {
            background: #16213e;
            color: #e6e6e6;
        }

        body.dark-mode th {
            background: #1a1a2e;
        }

        body.dark-mode td {
            border-color: #2c3e50;
        }

        body.dark-mode .session-card {
            background: #16213e;
            border-color: #1a1a2e;
            color: #e6e6e6;
        }

        body.dark-mode .report-section {
            background: #16213e;
            color: #e6e6e6;
        }

        body.dark-mode .alert {
            background: #1a1a2e;
            color: #e6e6e6;
            border-color: #2c3e50;
        }

        body.dark-mode .btn {
            background: #16537e;
            color: #e6e6e6;
        }

        body.dark-mode .btn-primary {
            background: #69B135;
            color: white;
        }

        body.dark-mode .btn-secondary {
            background: #2c3e50;
            color: #e6e6e6;
        }

        body.dark-mode .btn-danger {
            background: #dc3545;
            color: white;
        }

        body.dark-mode .btn:disabled {
            background: #1a1a2e;
            color: #6c757d;
        }

        body.dark-mode .modal {
            background: rgba(0, 0, 0, 0.85);
        }

        body.dark-mode .modal-content {
            background: #16213e;
            color: #e6e6e6;
        }

        body.dark-mode .modal-header {
            border-color: #2c3e50;
        }

        body.dark-mode .modal-header h2,
        body.dark-mode .modal-header h3 {
            color: #69B135;
        }

        body.dark-mode .modal-footer {
            border-color: #2c3e50;
        }

        body.dark-mode .close-btn {
            color: #e6e6e6;
        }

        body.dark-mode .close-btn:hover {
            background: #2c3e50;
            color: #dc3545;
        }

        body.dark-mode .form-group label {
            color: #e6e6e6;
        }

        body.dark-mode .empty-state {
            color: #a0a0a0;
        }

        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode h4 {
            color: #e6e6e6;
        }

        body.dark-mode .status-badge {
            border-color: #2c3e50;
        }

        body.dark-mode .service-badge {
            background: #16537e;
            color: #e6e6e6;
        }

        /* Dark mode overrides for inline styled elements */
        body.dark-mode div[style*="background: white"],
        body.dark-mode div[style*="background: #fff"],
        body.dark-mode div[style*="background:#fff"] {
            background: #16213e !important;
        }

        body.dark-mode div[style*="background: #f8f9fa"] {
            background: #1a1a2e !important;
        }

        body.dark-mode div[style*="background: #fff3cd"] {
            background: #2c3e50 !important;
            color: #ffc107 !important;
        }

        body.dark-mode div[style*="color: #6c757d"],
        body.dark-mode p[style*="color: #6c757d"] {
            color: #a0a0a0 !important;
        }

        body.dark-mode strong[style*="color: #856404"] {
            color: #ffc107 !important;
        }

        /* Fix dark inline text colors that are unreadable in dark mode */
        body.dark-mode h1[style*="color: #2c5282"],
        body.dark-mode h2[style*="color: #2c5282"],
        body.dark-mode h3[style*="color: #2c5282"],
        body.dark-mode h4[style*="color: #2c5282"],
        body.dark-mode h5[style*="color: #2c5282"] {
            color: #9fa8da !important; /* Light purple-blue for headings */
        }

        body.dark-mode p[style*="color: #adb5bd"],
        body.dark-mode p[style*="color: #6c757d"] {
            color: #c0c0c0 !important; /* Lighter gray for paragraphs */
        }

        body.dark-mode span[style*="color: #666"],
        body.dark-mode span[style*="color: #6c757d"] {
            color: #b0b0b0 !important; /* Lighter gray for spans */
        }

        body.dark-mode strong[style*="color: #2e7d32"],
        body.dark-mode p[style*="color: #2e7d32"] {
            color: #81c784 !important; /* Lighter green */
        }

        body.dark-mode div[style*="color: #6c757d"] {
            color: #c0c0c0 !important; /* Lighter gray for divs */
        }

        /* Dark mode for autofill/datalist dropdowns */
        body.dark-mode input::-webkit-calendar-picker-indicator,
        body.dark-mode input::-webkit-list-button {
            filter: invert(1);
        }

        body.dark-mode option {
            background: #1a1a2e;
            color: #e6e6e6;
        }

        body.dark-mode a {
            color: #69B135;
        }

        body.dark-mode a:hover {
            color: #223077;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #69B135;
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: #34495e;
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: white;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        /* Form Validation Styles */
        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        .form-group input.error:focus,
        .form-group select.error:focus,
        .form-group textarea.error:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        .form-group input.success,
        .form-group select.success,
        .form-group textarea.success {
            border-color: #69B135;
            background-color: #f6faf4;
        }

        .form-group input.success:focus,
        .form-group select.success:focus,
        .form-group textarea.success:focus {
            border-color: #69B135;
            box-shadow: 0 0 0 3px rgba(105, 177, 53, 0.1);
        }

        .form-group .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .form-group .error-message.show {
            display: block;
        }

        .form-group label.required::after {
            content: ' *';
            color: #dc3545;
            font-weight: bold;
        }

        .form-group input:invalid:not(:placeholder-shown),
        .form-group select:invalid:not(:placeholder-shown) {
            border-color: #ffc107;
        }

        .pipette-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .pipette-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .pipette-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .pipette-header h3 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pass {
            background: #28a745;
            color: #ffffff;
            border: 2px solid #1e7e34;
        }

        .status-pass::before {
            content: '‚úì ';
            font-weight: bold;
        }

        .status-fail {
            background: #dc3545;
            color: #ffffff;
            border: 2px solid #bd2130;
        }

        .status-fail::before {
            content: '‚úó ';
            font-weight: bold;
        }

        .status-pending {
            background: #ffc107;
            color: #000000;
            border: 2px solid #e0a800;
        }

        .status-pending::before {
            content: '‚è≥ ';
        }

        .measurement-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .measurement-table th {
            background: #69B135;
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
        }

        .measurement-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        .measurement-input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .measurement-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .measurement-input.pass {
            background-color: #e7f5e9;
            border-color: #28a745;
            border-width: 2px;
        }

        .measurement-input.fail {
            background-color: #ffe6e6;
            border-color: #dc3545;
            border-width: 3px;
            font-weight: bold;
        }

        /* Input Validation Styles */
        .measurement-input.error,
        input.error {
            border: 3px solid #dc3545 !important;
            background-color: #ffe6e6;
            animation: shake 0.3s;
        }

        .measurement-input.valid,
        input.valid {
            border: 2px solid #28a745;
            background-color: #e7f5e9;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .error-message {
            color: #dc3545;
            font-size: 11px;
            margin-top: 3px;
            font-weight: 600;
            display: block;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-5px); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        @keyframes slideUp {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -20px); }
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(40, 167, 69, 0.5); }
            100% { transform: scale(1); }
        }

        .success-animation {
            animation: successPulse 0.6s ease;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.5s ease;
        }

        .environmental-data {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .measurement-table {
                font-size: 12px;
            }
            
            .measurement-input {
                width: 60px;
            }
        }

        .report-section {
            background: white;
            padding: 30px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        @media print {
            /* Hide UI elements */
            .header,
            .nav-tabs,
            .btn,
            .save-indicator,
            .pipette-card .pipette-header button,
            .tab-content:not(.active) {
                display: none !important;
            }

            /* Clean backgrounds */
            body {
                background: white;
                padding: 0;
                margin: 0;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
                max-width: 100%;
                margin: 0;
                padding: 0;
            }

            /* Page setup */
            @page {
                margin: 0.75in 0.5in;
                size: letter portrait;
            }

            /* Page breaks */
            .pipette-card,
            .report-section,
            h2 {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            /* Optimize tables for print */
            .measurement-table {
                font-size: 9pt;
                border-collapse: collapse;
                width: 100%;
            }

            .measurement-table th {
                background: #f0f0f0 !important;
                color: black !important;
                border: 1px solid #000;
                padding: 6px 4px;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .measurement-table td {
                border: 1px solid #666;
                padding: 4px;
            }

            /* Black & white friendly status badges */
            .status-badge {
                border: 2px solid #000 !important;
                background: white !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .status-pass::before {
                content: '‚úì ';
                font-weight: bold;
            }

            .status-fail::before {
                content: '‚úó ';
                font-weight: bold;
            }

            /* Ensure gradient headers print properly */
            .pipette-card h3,
            table tr[style*="background"] {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Improve text readability */
            body {
                font-size: 11pt;
                line-height: 1.4;
            }

            h1 { font-size: 18pt; }
            h2 { font-size: 16pt; }
            h3 { font-size: 14pt; }
            h4 { font-size: 12pt; }

            /* Compact spacing for print */
            .form-grid,
            .statistics {
                gap: 10px;
            }

            /* Remove unnecessary padding */
            .tab-content {
                padding: 0 !important;
            }
        }

        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #69B135;
            color: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 9999;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .save-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .save-indicator::before {
            content: '‚úì';
            font-size: 18px;
            font-weight: bold;
        }

        body.dark-mode .save-indicator {
            background: #69B135;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-dialog {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Modal styles for Templates and Inventory modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-height: 85vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6c757d;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #f8f9fa;
            color: #dc3545;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2,
        .modal-header h3 {
            margin: 0;
            color: #2c5282;
            font-size: 20px;
        }

        .modal-body {
            padding: 24px;
            font-size: 16px;
            line-height: 1.5;
            color: #495057;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        @media print {
            .modal-overlay {
                display: none !important;
            }
        }

        .session-card {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .session-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .session-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .session-date {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .session-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .session-stat {
            font-size: 14px;
            color: #6c757d;
        }

        /* Voice Input Styles */
        .voice-button {
            padding: 6px 12px;
            border: 2px solid #28a745;
            background: #28a745;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .voice-button:hover {
            background: #218838;
            border-color: #218838;
            transform: translateY(-1px);
        }

        .voice-button.listening {
            background: #dc3545;
            border-color: #dc3545;
            animation: pulse-button 1.5s ease-in-out infinite;
        }

        .voice-button.listening:hover {
            background: #c82333;
            border-color: #c82333;
        }

        .voice-button:disabled {
            background: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .voice-status {
            font-size: 12px;
            color: #28a745;
            font-weight: 600;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .voice-status.error {
            color: #dc3545;
        }

        .volume-inputs input.voice-active {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
            animation: pulse-border 1.5s ease-in-out infinite;
        }

        @keyframes pulse-button {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        }

        @keyframes pulse-border {
            0%, 100% { border-color: #28a745; }
            50% { border-color: #5cb85c; }
        }

        /* Barcode Scanner Styles */
        .scan-success {
            animation: scanFlash 0.6s ease;
        }

        @keyframes scanFlash {
            0%, 100% {
                background-color: white;
                border-color: #ced4da;
            }
            50% {
                background-color: #d4edda;
                border-color: #28a745;
                box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
            }
        }

        body.dark-mode .scan-success {
            animation: scanFlashDark 0.6s ease;
        }

        @keyframes scanFlashDark {
            0%, 100% {
                background-color: #1a1a2e;
                border-color: #2c3e50;
            }
            50% {
                background-color: #28a745;
                border-color: #28a745;
                box-shadow: 0 0 10px rgba(40, 167, 69, 0.7);
            }
        }

        /* Global Voice Navigation Styles */
        #globalVoiceBtn {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        #globalVoiceBtn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        #globalVoiceBtn.listening {
            background: #dc3545;
            animation: pulse-mic 1.5s ease-in-out infinite;
        }

        #globalVoiceBtn.listening:hover {
            background: #c82333;
        }

        @keyframes pulse-mic {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
                transform: scale(1.05);
            }
        }

        #globalVoiceStatus {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(40, 167, 69, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        #globalVoiceStatus.show {
            display: block;
            animation: slideInRight 0.3s ease;
        }

        #globalVoiceStatus.error {
            background: rgba(220, 53, 69, 0.95);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .voice-highlight {
            animation: highlightPulse 1.5s ease;
            border: 3px solid #28a745 !important;
            box-shadow: 0 0 0 5px rgba(40, 167, 69, 0.3) !important;
        }

        @keyframes highlightPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            50% {
                box-shadow: 0 0 0 15px rgba(40, 167, 69, 0);
            }
        }

        /* Voice Help Panel */
        #voiceHelpPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10001;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }

        #voiceHelpPanel.show {
            display: block;
        }

        .voice-help-category {
            margin-bottom: 25px;
        }

        .voice-help-category h3 {
            color: #28a745;
            margin-bottom: 10px;
            border-bottom: 2px solid #28a745;
            padding-bottom: 5px;
        }

        .voice-help-command {
            padding: 8px 12px;
            background: #f8f9fa;
            margin: 5px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        /* Toast Notification Styles */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10002;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 500px;
            pointer-events: auto;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
            border-left: 4px solid #69B135;
        }

        .toast.success {
            border-left-color: #69B135;
        }

        .toast.error {
            border-left-color: #dc3545;
        }

        .toast.warning {
            border-left-color: #ffc107;
        }

        .toast.info {
            border-left-color: #223077;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .toast-message {
            font-size: 14px;
            color: #666;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .toast-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        body.dark-mode .toast {
            background: #16213e;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        body.dark-mode .toast-title {
            color: #e6e6e6;
        }

        body.dark-mode .toast-message {
            color: #b0b0b0;
        }

        body.dark-mode .toast-close {
            color: #999;
        }

        body.dark-mode .toast-close:hover {
            background: #1a1a2e;
            color: #e6e6e6;
        }

        /* Loading Spinner Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(3px);
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 20px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #69B135;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #333;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        body.dark-mode .loading-spinner {
            background: #16213e;
        }

        body.dark-mode .loading-text {
            color: #e6e6e6;
        }

        body.dark-mode .spinner {
            border-color: #2c3e50;
            border-top-color: #69B135;
        }

        /* Inline loading spinner for buttons */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        /* Print Optimization */
        @media print {
            body {
                background: white !important;
                padding: 0;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
                max-width: 100%;
            }

            .header {
                break-after: avoid;
            }

            .nav-tabs,
            #darkModeToggle,
            #undoBtn,
            #redoBtn,
            button:not(.print-keep) {
                display: none !important;
            }

            .tab-content {
                display: block !important;
                page-break-inside: avoid;
            }

            .pipette-card {
                page-break-inside: avoid;
                border: 1px solid #000;
                margin-bottom: 20px;
            }

            table {
                page-break-inside: avoid;
            }

            .no-print {
                display: none !important;
            }

            @page {
                margin: 1cm;
                size: letter;
            }
        }
    </style>
</head>
<body>
    <div id="saveIndicator" class="save-indicator">Saved</div>

    <!-- Global Voice Status -->
    <div id="globalVoiceStatus"></div>

    <!-- Voice Help Panel -->
    <div id="voiceHelpPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 3px solid #28a745; padding-bottom: 15px;">
            <h2 style="margin: 0; color: #28a745;">üéôÔ∏è Voice Control Commands</h2>
            <button onclick="closeVoiceHelp()" style="background: #dc3545; color: white; border: none; border-radius: 5px; padding: 8px 16px; cursor: pointer; font-size: 16px; font-weight: 600;">&times; Close</button>
        </div>

        <div class="voice-help-category">
            <h3>üìë Tab Navigation</h3>
            <div class="voice-help-command">"Go to session" or "Show session info"</div>
            <div class="voice-help-command">"Go to calibration"</div>
            <div class="voice-help-command">"Go to analysis" or "Show analysis"</div>
            <div class="voice-help-command">"Go to summary" or "Show summary table"</div>
            <div class="voice-help-command">"Go to report"</div>
            <div class="voice-help-command">"Go to labels"</div>
            <div class="voice-help-command">"Go to inventory"</div>
            <div class="voice-help-command">"Go to history"</div>
        </div>

        <div class="voice-help-category">
            <h3>üìù Field Navigation</h3>
            <div class="voice-help-command">"Service provider" - Jump to service provider field</div>
            <div class="voice-help-command">"Location" - Jump to location field</div>
            <div class="voice-help-command">"Technician" - Jump to technician field</div>
            <div class="voice-help-command">"Temperature" - Jump to temperature field</div>
            <div class="voice-help-command">"Humidity" - Jump to humidity field</div>
            <div class="voice-help-command">"Pressure" - Jump to pressure field</div>
            <div class="voice-help-command">"PI name" or "Principal investigator"</div>
        </div>

        <div class="voice-help-category">
            <h3>üß™ Pipette Navigation</h3>
            <div class="voice-help-command">"Pipette [number]" - Navigate to specific pipette (e.g., "Pipette three")</div>
            <div class="voice-help-command">"Reading [1-4] pipette [number]" - Jump to specific reading field</div>
            <div class="voice-help-command">"Serial number pipette [number]" - Jump to serial field</div>
            <div class="voice-help-command">"First pipette" - Go to first pipette</div>
            <div class="voice-help-command">"Last pipette" - Go to last pipette</div>
        </div>

        <div class="voice-help-category">
            <h3>‚ö° Action Commands</h3>
            <div class="voice-help-command">"Add pipette" or "New pipette"</div>
            <div class="voice-help-command">"New session"</div>
            <div class="voice-help-command">"Generate report"</div>
            <div class="voice-help-command">"Scroll up" / "Scroll down"</div>
        </div>

        <div class="voice-help-category">
            <h3>üéõÔ∏è Control Commands</h3>
            <div class="voice-help-command">"Help" or "What can I say" - Show this panel</div>
            <div class="voice-help-command">"Stop listening" or "Turn off voice" - Disable voice control</div>
        </div>

        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #28a745;">
            <strong style="color: #2e7d32;">üí° Pro Tips:</strong>
            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                <li>Voice control works system-wide for navigation</li>
                <li>Click üé§ Voice Input on individual pipettes for hands-free volume entry</li>
                <li>Both systems work together - navigation commands won't interfere with volume entry</li>
                <li>Best used in Chrome, Edge, or Safari browsers</li>
            </ul>
        </div>
    </div>

    <script>
        // Define ALL functions first to avoid reference errors
        let pipettes = [];
        let currentPipetteId = 0;
        let currentSessionId = null;
        let saveTimeout = null;
        let inventoryUsage = [];

        // Multi-Equipment Support
        let balances = [];
        let currentBalanceId = 0;
        let timers = [];
        let currentTimerId = 0;
        let centrifuges = [];
        let currentCentrifugeId = 0;
        let temperatureDevices = [];
        let currentTemperatureDeviceId = 0;

        // Voice Recognition Variables (for volume entry)
        let voiceRecognition = null;
        let currentVoicePipetteId = null;
        let currentReadingIndex = 0;
        let voiceSupported = false;

        // Global Voice Navigation Variables
        let globalVoiceRecognition = null;
        let globalVoiceActive = false;
        let globalVoiceStatusTimeout = null;

        // Barcode Scanner Variables
        let barcodeBuffer = '';
        let lastKeyTime = 0;
        let barcodeScansToday = 0;
        const BARCODE_SCAN_SPEED_MS = 50; // Keys <50ms apart = scanner

        // Dymo Label Printer Variables
        let dymoAvailable = false;
        let dymoPrinters = [];

        // ========================================
        // CUSTOM MODAL FUNCTIONS
        // ========================================

        function showAlert(message, title = 'Notice') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalConfirmBtn').style.display = 'none';
            document.querySelector('.modal-footer .btn-secondary').textContent = 'OK';
            document.getElementById('customModal').style.display = 'flex';
        }

        function showConfirm(message, title = 'Confirm', onConfirm) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalConfirmBtn').style.display = 'block';
            document.querySelector('.modal-footer .btn-secondary').textContent = 'Cancel';

            const confirmBtn = document.getElementById('modalConfirmBtn');
            // Remove old onclick and add new one
            confirmBtn.onclick = () => {
                onConfirm();
                closeModal();
            };

            document.getElementById('customModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
        }

        // Modal event listeners will be set up in main DOMContentLoaded below

        // ========================================
        // VOICE INPUT SYSTEM (FOR BASIC MODE)
        // ========================================

        // Check if voice recognition is supported
        function checkVoiceSupport() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            voiceSupported = !!SpeechRecognition;

            if (!voiceSupported) {
                console.warn('Speech Recognition not supported in this browser');
            }

            return voiceSupported;
        }

        // Initialize speech recognition
        function initVoiceRecognition() {
            if (!checkVoiceSupport()) {
                return null;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();

            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                const lastResult = event.results[event.results.length - 1];
                if (lastResult.isFinal) {
                    const transcript = lastResult[0].transcript.trim();
                    handleVoiceResult(transcript);
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                const statusEl = document.getElementById(`voice-status-${currentVoicePipetteId}`);

                if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    updateVoiceStatus('‚ùå Microphone access denied', true);
                    stopVoiceInput();
                } else if (event.error === 'no-speech') {
                    updateVoiceStatus('‚è±Ô∏è No speech detected. Try again.', true);
                } else if (event.error === 'network') {
                    updateVoiceStatus('üì° Network error. Check connection.', true);
                    stopVoiceInput();
                } else {
                    updateVoiceStatus(`‚ùå Error: ${event.error}`, true);
                }
            };

            recognition.onend = () => {
                // If we're still in voice mode, restart recognition
                if (currentVoicePipetteId && currentReadingIndex < 4) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Failed to restart recognition:', e);
                        stopVoiceInput();
                    }
                }
            };

            return recognition;
        }

        // Parse spoken number to float
        function parseSpokenNumber(transcript) {
            // Clean up transcript
            let text = transcript.toLowerCase()
                .replace(/point/g, '.')
                .replace(/decimal/g, '.')
                .trim();

            // Try to parse as a direct number first
            let number = parseFloat(text);
            if (!isNaN(number)) {
                return number;
            }

            // Handle word numbers (basic support)
            const wordNumbers = {
                'zero': 0, 'one': 1, 'two': 2, 'three': 3, 'four': 4,
                'five': 5, 'six': 6, 'seven': 7, 'eight': 8, 'nine': 9,
                'ten': 10, 'eleven': 11, 'twelve': 12, 'thirteen': 13,
                'fourteen': 14, 'fifteen': 15, 'sixteen': 16, 'seventeen': 17,
                'eighteen': 18, 'nineteen': 19, 'twenty': 20, 'thirty': 30,
                'forty': 40, 'fifty': 50, 'sixty': 60, 'seventy': 70,
                'eighty': 80, 'ninety': 90, 'hundred': 100, 'thousand': 1000
            };

            // Simple word-to-number conversion
            for (const [word, value] of Object.entries(wordNumbers)) {
                text = text.replace(new RegExp(word, 'g'), value.toString());
            }

            // Try parsing again
            number = parseFloat(text);
            if (!isNaN(number) && number >= 0 && number <= 100000) {
                return number;
            }

            return null;
        }

        // Update voice status message
        function updateVoiceStatus(message, isError = false) {
            if (!currentVoicePipetteId) return;

            const statusEl = document.getElementById(`voice-status-${currentVoicePipetteId}`);
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = isError ? 'voice-status error' : 'voice-status';
            }
        }

        // Handle voice recognition result
        function handleVoiceResult(transcript) {
            if (!currentVoicePipetteId || currentReadingIndex >= 4) {
                stopVoiceInput();
                return;
            }

            const lowerTranscript = transcript.toLowerCase().trim();

            // Check for voice commands first (commands take priority over numbers)
            if (executeVoiceCommand(lowerTranscript, currentVoicePipetteId)) {
                return; // Command was executed
            }

            // Try to parse as number
            const number = parseSpokenNumber(transcript);

            if (number === null) {
                updateVoiceStatus(`‚ùì Didn't understand "${transcript}". Try again or say "help"`, true);
                return;
            }

            // Round to 3 decimal places
            const roundedNumber = Math.round(number * 1000) / 1000;

            // Update the field (for Basic mode)
            updateFinalVolume(currentVoicePipetteId, currentReadingIndex, roundedNumber.toString());

            // Update UI
            const inputField = document.getElementById(`vol${currentReadingIndex + 1}-${currentVoicePipetteId}`);
            if (inputField) {
                inputField.value = roundedNumber;
                inputField.classList.remove('voice-active');
            }

            updateVoiceStatus(`‚úì Heard: ${roundedNumber} ¬µL`, false);

            // Move to next reading
            currentReadingIndex++;

            if (currentReadingIndex >= 4) {
                // All readings captured
                setTimeout(() => {
                    updateVoiceStatus('‚úÖ All readings captured!', false);
                    stopVoiceInput();
                }, 500);
            } else {
                // Highlight next reading
                setTimeout(() => {
                    const nextField = document.getElementById(`vol${currentReadingIndex + 1}-${currentVoicePipetteId}`);
                    if (nextField) {
                        nextField.classList.add('voice-active');
                    }
                    updateVoiceStatus(`üé§ Listening for Reading ${currentReadingIndex + 1}...`, false);
                }, 600);
            }
        }

        // Execute voice command
        function executeVoiceCommand(transcript, pipetteId) {
            // Help command
            if (transcript.includes('help') || transcript.includes('commands')) {
                updateVoiceStatus(`üìã Commands: "stop", "repeat", "mark pass", "mark fail"`, false);
                return true;
            }

            // Stop/cancel
            if (transcript.includes('stop') || transcript.includes('cancel') || transcript.includes('quit')) {
                updateVoiceStatus('‚èπÔ∏è Stopped listening', false);
                stopVoiceInput();
                return true;
            }

            // Repeat last reading
            if (transcript.includes('repeat') || transcript.includes('redo') || transcript.includes('again')) {
                if (currentReadingIndex > 0) {
                    currentReadingIndex--;
                    const field = document.getElementById(`vol${currentReadingIndex + 1}-${pipetteId}`);
                    if (field) {
                        field.value = '';
                        field.classList.add('voice-active');
                        // Clear previous field highlight
                        for (let i = 1; i <= 4; i++) {
                            if (i !== currentReadingIndex + 1) {
                                document.getElementById(`vol${i}-${pipetteId}`)?.classList.remove('voice-active');
                            }
                        }
                    }
                    updateVoiceStatus(`üîÑ Ready to re-enter Reading ${currentReadingIndex + 1}`, false);
                } else {
                    updateVoiceStatus('‚ö†Ô∏è No reading to repeat yet', true);
                }
                return true;
            }

            // Mark as PASS
            if (transcript.includes('mark pass') || transcript.includes('passed') || transcript.includes('mark as pass')) {
                updateBasicStatus(pipetteId, 'PASS');
                const selectField = document.getElementById(`pf-${pipetteId}`);
                if (selectField) selectField.value = 'PASS';
                updateVoiceStatus('‚úÖ Marked as PASS', false);
                return true;
            }

            // Mark as FAIL
            if (transcript.includes('mark fail') || transcript.includes('failed') || transcript.includes('mark as fail')) {
                updateBasicStatus(pipetteId, 'FAIL');
                const selectField = document.getElementById(`pf-${pipetteId}`);
                if (selectField) selectField.value = 'FAIL';
                updateVoiceStatus('‚ùå Marked as FAIL', false);
                return true;
            }

            return false; // No command matched
        }

        // Start voice input
        function startVoiceInput(pipetteId) {
            if (!checkVoiceSupport()) {
                showAlert('Voice input is not supported in your browser. Please use Chrome, Edge, or Safari.', 'Info');
                return;
            }

            currentVoicePipetteId = pipetteId;
            currentReadingIndex = 0;

            // Initialize recognition if needed
            if (!voiceRecognition) {
                voiceRecognition = initVoiceRecognition();
            }

            try {
                voiceRecognition.start();

                // Update button state
                const button = document.getElementById(`voice-btn-${pipetteId}`);
                if (button) {
                    button.classList.add('listening');
                    button.innerHTML = '‚èπÔ∏è Stop';
                }

                // Highlight first reading field
                const firstField = document.getElementById(`vol1-${pipetteId}`);
                if (firstField) {
                    firstField.classList.add('voice-active');
                }

                updateVoiceStatus('üé§ Listening for Reading 1... (Say "help" for commands)', false);
            } catch (error) {
                console.error('Failed to start voice recognition:', error);
                showAlert('Failed to start voice input. Please check microphone permissions.', 'Error');
                stopVoiceInput();
            }
        }

        // Stop voice input
        function stopVoiceInput() {
            if (voiceRecognition) {
                try {
                    voiceRecognition.stop();
                } catch (e) {
                    console.error('Error stopping recognition:', e);
                }
            }

            if (currentVoicePipetteId) {
                // Update button state
                const button = document.getElementById(`voice-btn-${currentVoicePipetteId}`);
                if (button) {
                    button.classList.remove('listening');
                    button.innerHTML = 'üé§ Voice Input';
                }

                // Remove voice-active class from all fields
                for (let i = 1; i <= 4; i++) {
                    const field = document.getElementById(`vol${i}-${currentVoicePipetteId}`);
                    if (field) {
                        field.classList.remove('voice-active');
                    }
                }

                // Clear status after a delay if not error
                const statusEl = document.getElementById(`voice-status-${currentVoicePipetteId}`);
                if (statusEl && !statusEl.classList.contains('error')) {
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 3000);
                }
            }

            currentVoicePipetteId = null;
            currentReadingIndex = 0;
        }

        // Toggle voice input on/off
        function toggleVoiceInput(pipetteId) {
            if (currentVoicePipetteId === pipetteId) {
                stopVoiceInput();
            } else {
                if (currentVoicePipetteId) {
                    stopVoiceInput();
                }
                startVoiceInput(pipetteId);
            }
        }

        // ========================================
        // BARCODE SCANNER SYSTEM
        // ========================================

        function showScanFeedback(field, value) {
            // Visual feedback - green flash
            field.classList.add('scan-success');
            setTimeout(() => field.classList.remove('scan-success'), 600);

            // Update scan counter
            barcodeScansToday++;

            // Status message (if there's a status area)
            console.log(`‚úÖ Barcode scanned: ${value}`);
        }

        function autoAdvanceAfterScan(currentField) {
            // Determine which field was scanned
            const fieldId = currentField.id;

            // If it's a serial number field in Basic mode
            if (fieldId.startsWith('serial-')) {
                const pipetteId = fieldId.replace('serial-', '');

                // Try to focus on make/model field
                const makeModelField = document.getElementById(`makeModel-${pipetteId}`);
                if (makeModelField) {
                    setTimeout(() => {
                        makeModelField.focus();
                        makeModelField.select();
                    }, 100);
                    return;
                }

                // If make/model already filled, focus on max volume
                const maxVolumeField = document.getElementById(`maxVolume-${pipetteId}`);
                if (maxVolumeField) {
                    setTimeout(() => {
                        maxVolumeField.focus();
                        maxVolumeField.select();
                    }, 100);
                }
            }
        }

        // ========================================
        // DYMO LABELWRITER 450 INTEGRATION
        // ========================================

        // Check if Dymo Connect service is running
        async function checkDymoService() {
            const statusDiv = document.getElementById('printerStatus');
            const infoDiv = document.getElementById('printerInfo');
            const instructionsDiv = document.getElementById('dymoInstructions');

            if (!statusDiv) return;

            statusDiv.innerHTML = 'üîÑ Checking...';
            if (infoDiv) infoDiv.innerHTML = '';

            try {
                const response = await fetch('http://127.0.0.1:41951/DYMO/DLS/Printing/StatusConnected', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    const isConnected = await response.text();
                    if (isConnected === 'true') {
                        dymoAvailable = true;
                        statusDiv.innerHTML = '‚úÖ <span style="color: #28a745; font-weight: 600;">Dymo Connect Running</span>';
                        if (instructionsDiv) instructionsDiv.style.display = 'none';
                        await getDymoPrinters();
                    } else {
                        throw new Error('Not connected');
                    }
                } else {
                    throw new Error('Service not available');
                }
            } catch (error) {
                dymoAvailable = false;
                statusDiv.innerHTML = '‚ùå <span style="color: #dc3545; font-weight: 600;">Dymo Connect Not Running</span>';
                if (infoDiv) infoDiv.innerHTML = '';
                if (instructionsDiv) instructionsDiv.style.display = 'block';
            }
        }

        // Get available Dymo printers
        async function getDymoPrinters() {
            const infoDiv = document.getElementById('printerInfo');
            if (!infoDiv) return;

            try {
                const response = await fetch('http://127.0.0.1:41951/DYMO/DLS/Printing/GetPrinters', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    const printers = await response.json();
                    dymoPrinters = printers;

                    if (printers && printers.length > 0) {
                        const labelWriters = printers.filter(p => p.name.includes('LabelWriter') || p.name.includes('450'));
                        if (labelWriters.length > 0) {
                            infoDiv.innerHTML = `üìü Found: <strong>${labelWriters[0].name}</strong>`;
                            infoDiv.style.color = '#28a745';
                        } else {
                            infoDiv.innerHTML = '‚ö†Ô∏è No LabelWriter 450 detected. Printers found: ' + printers.map(p => p.name).join(', ');
                            infoDiv.style.color = '#ffc107';
                        }
                    } else {
                        infoDiv.innerHTML = '‚ö†Ô∏è No printers detected. Make sure your LabelWriter 450 is connected and turned on.';
                        infoDiv.style.color = '#ffc107';
                    }
                }
            } catch (error) {
                infoDiv.innerHTML = '‚ùå Could not retrieve printer list: ' + error.message;
                infoDiv.style.color = '#dc3545';
            }
        }

        // Create Dymo label XML template
        function createDymoLabelXML(pipette, sessionInfo) {
            const serialNumber = pipette.serial || 'N/A';
            const volume = pipette.maxVolume || pipette.volume || 'N/A';
            const brand = pipette.brand || pipette.makeModel || 'N/A';
            const status = pipette.serviceLevel === 'basic'
                ? (pipette.passFail === 'PASS' ? 'PASS' : pipette.passFail === 'FAIL' ? 'FAIL' : 'PENDING')
                : (pipette.statusAsLeft === 'pass' ? 'PASS' : pipette.statusAsLeft === 'fail' ? 'FAIL' : 'PENDING');
            const calDate = sessionInfo.calDate || new Date().toISOString().split('T')[0];
            const serviceType = pipette.serviceLevel === 'basic' ? 'Basic' : 'Platinum';

            // QR code data includes all info
            const qrData = `SN:${serialNumber}|VOL:${volume}|DATE:${calDate}|STATUS:${status}|SERVICE:${serviceType}`;

            // Dymo 30334 label template (2-1/4" x 1-1/4")
            return `<?xml version="1.0" encoding="utf-8"?>
<DieCutLabel Version="8.0" Units="twips">
    <PaperOrientation>Landscape</PaperOrientation>
    <Id>Small30334</Id>
    <PaperName>30334 2-1/4 in x 1-1/4 in</PaperName>
    <DrawCommands>
        <RoundRectangle X="0" Y="0" Width="1440" Height="1800" Rx="0" Ry="0"/>
    </DrawCommands>
    <ObjectInfo>
        <BarcodeObject>
            <Name>BARCODE_QR</Name>
            <ForeColor Alpha="255" Red="0" Green="0" Blue="0"/>
            <BackColor Alpha="0" Red="255" Green="255" Blue="255"/>
            <LinkedObjectName></LinkedObjectName>
            <Rotation>Rotation0</Rotation>
            <IsMirrored>False</IsMirrored>
            <IsVariable>True</IsVariable>
            <Text>${qrData}</Text>
            <Type>QRCode</Type>
            <Size>Small</Size>
            <TextPosition>None</TextPosition>
            <TextFont Family="Arial" Size="8" Bold="False" Italic="False" Underline="False" Strikeout="False"/>
            <CheckSumFont Family="Arial" Size="8" Bold="False" Italic="False" Underline="False" Strikeout="False"/>
            <TextEmbedding>None</TextEmbedding>
            <ECLevel>0</ECLevel>
            <HorizontalAlignment>Center</HorizontalAlignment>
            <QuietZonesPadding Left="0" Right="0" Top="0" Bottom="0"/>
        </BarcodeObject>
        <Bounds X="60" Y="300" Width="900" Height="900"/>
    </ObjectInfo>
    <ObjectInfo>
        <TextObject>
            <Name>TEXT_STATUS</Name>
            <ForeColor Alpha="255" Red="0" Green="0" Blue="0"/>
            <BackColor Alpha="0" Red="255" Green="255" Blue="255"/>
            <LinkedObjectName></LinkedObjectName>
            <Rotation>Rotation0</Rotation>
            <IsMirrored>False</IsMirrored>
            <IsVariable>True</IsVariable>
            <HorizontalAlignment>Center</HorizontalAlignment>
            <VerticalAlignment>Middle</VerticalAlignment>
            <TextFitMode>ShrinkToFit</TextFitMode>
            <UseFullFontHeight>True</UseFullFontHeight>
            <Verticalized>False</Verticalized>
            <StyledText>
                <Element>
                    <String>${status === 'PASS' ? '‚úì PASS' : status === 'FAIL' ? '‚úó FAIL' : '‚è≥ PEND'}</String>
                    <Attributes>
                        <Font Family="Arial" Size="9" Bold="True" Italic="False" Underline="False" Strikeout="False"/>
                        <ForeColor Alpha="255" Red="0" Green="0" Blue="0"/>
                    </Attributes>
                </Element>
            </StyledText>
        </TextObject>
        <Bounds X="1000" Y="280" Width="740" Height="280"/>
    </ObjectInfo>
    <ObjectInfo>
        <TextObject>
            <Name>TEXT_SERIAL</Name>
            <ForeColor Alpha="255" Red="0" Green="0" Blue="0"/>
            <BackColor Alpha="0" Red="255" Green="255" Blue="255"/>
            <LinkedObjectName></LinkedObjectName>
            <Rotation>Rotation0</Rotation>
            <IsMirrored>False</IsMirrored>
            <IsVariable>True</IsVariable>
            <HorizontalAlignment>Center</HorizontalAlignment>
            <VerticalAlignment>Middle</VerticalAlignment>
            <TextFitMode>ShrinkToFit</TextFitMode>
            <UseFullFontHeight>True</UseFullFontHeight>
            <Verticalized>False</Verticalized>
            <StyledText>
                <Element>
                    <String>${serialNumber}</String>
                    <Attributes>
                        <Font Family="Arial" Size="8" Bold="True" Italic="False" Underline="False" Strikeout="False"/>
                        <ForeColor Alpha="255" Red="0" Green="0" Blue="0"/>
                    </Attributes>
                </Element>
            </StyledText>
        </TextObject>
        <Bounds X="1000" Y="600" Width="740" Height="250"/>
    </ObjectInfo>
    <ObjectInfo>
        <TextObject>
            <Name>TEXT_VOLUME</Name>
            <ForeColor Alpha="255" Red="0" Green="0" Blue="0"/>
            <BackColor Alpha="0" Red="255" Green="255" Blue="255"/>
            <LinkedObjectName></LinkedObjectName>
            <Rotation>Rotation0</Rotation>
            <IsMirrored>False</IsMirrored>
            <IsVariable>True</IsVariable>
            <HorizontalAlignment>Center</HorizontalAlignment>
            <VerticalAlignment>Middle</VerticalAlignment>
            <TextFitMode>ShrinkToFit</TextFitMode>
            <UseFullFontHeight>True</UseFullFontHeight>
            <Verticalized>False</Verticalized>
            <StyledText>
                <Element>
                    <String>${volume} ¬µL</String>
                    <Attributes>
                        <Font Family="Arial" Size="7" Bold="False" Italic="False" Underline="False" Strikeout="False"/>
                        <ForeColor Alpha="255" Red="0" Green="0" Blue="0"/>
                    </Attributes>
                </Element>
            </StyledText>
        </TextObject>
        <Bounds X="1000" Y="880" Width="740" Height="230"/>
    </ObjectInfo>
    <ObjectInfo>
        <TextObject>
            <Name>TEXT_DATE</Name>
            <ForeColor Alpha="255" Red="0" Green="0" Blue="0"/>
            <BackColor Alpha="0" Red="255" Green="255" Blue="255"/>
            <LinkedObjectName></LinkedObjectName>
            <Rotation>Rotation0</Rotation>
            <IsMirrored>False</IsMirrored>
            <IsVariable>True</IsVariable>
            <HorizontalAlignment>Center</HorizontalAlignment>
            <VerticalAlignment>Middle</VerticalAlignment>
            <TextFitMode>ShrinkToFit</TextFitMode>
            <UseFullFontHeight>True</UseFullFontHeight>
            <Verticalized>False</Verticalized>
            <StyledText>
                <Element>
                    <String>${calDate}</String>
                    <Attributes>
                        <Font Family="Arial" Size="6" Bold="False" Italic="False" Underline="False" Strikeout="False"/>
                        <ForeColor Alpha="255" Red="0" Green="0" Blue="0"/>
                    </Attributes>
                </Element>
            </StyledText>
        </TextObject>
        <Bounds X="1000" Y="1140" Width="740" Height="200"/>
    </ObjectInfo>
    <ObjectInfo>
        <TextObject>
            <Name>TEXT_SERVICE</Name>
            <ForeColor Alpha="255" Red="0" Green="0" Blue="0"/>
            <BackColor Alpha="0" Red="255" Green="255" Blue="255"/>
            <LinkedObjectName></LinkedObjectName>
            <Rotation>Rotation0</Rotation>
            <IsMirrored>False</IsMirrored>
            <IsVariable>True</IsVariable>
            <HorizontalAlignment>Center</HorizontalAlignment>
            <VerticalAlignment>Middle</VerticalAlignment>
            <TextFitMode>ShrinkToFit</TextFitMode>
            <UseFullFontHeight>True</UseFullFontHeight>
            <Verticalized>False</Verticalized>
            <StyledText>
                <Element>
                    <String>${serviceType === 'Basic' ? '‚ö° Basic' : 'üèÜ Plat'}</String>
                    <Attributes>
                        <Font Family="Arial" Size="6" Bold="False" Italic="False" Underline="False" Strikeout="False"/>
                        <ForeColor Alpha="255" Red="0" Green="0" Blue="0"/>
                    </Attributes>
                </Element>
            </StyledText>
        </TextObject>
        <Bounds X="1000" Y="1360" Width="740" Height="200"/>
    </ObjectInfo>
</DieCutLabel>`;
        }

        // Print selected pipettes to Dymo
        async function printSelectedToDymo() {
            if (!dymoAvailable) {
                showAlert('Dymo Connect is not running. Please start Dymo Connect and click Refresh.', 'Error');
                return;
            }

            const checkboxes = document.querySelectorAll('.dymo-label-checkbox:checked');
            if (checkboxes.length === 0) {
                showAlert('Please select at least one pipette to print labels for.', 'Notice');
                return;
            }

            const sessionInfo = getSessionInfo();
            let printedCount = 0;
            let failedCount = 0;

            for (const checkbox of checkboxes) {
                const pipetteId = parseInt(checkbox.getAttribute('data-pipette-id'));
                const pipette = pipettes.find(p => p.id === pipetteId);

                if (!pipette) continue;

                const labelXML = createDymoLabelXML(pipette, sessionInfo);

                try {
                    let printerName = '';
                    if (dymoPrinters && dymoPrinters.length > 0) {
                        const labelWriter = dymoPrinters.find(p => p.name.includes('LabelWriter') || p.name.includes('450'));
                        printerName = labelWriter ? labelWriter.name : dymoPrinters[0].name;
                    }

                    const response = await fetch('http://127.0.0.1:41951/DYMO/DLS/Printing/PrintLabel', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `printerName=${encodeURIComponent(printerName)}&printParamsXml=&labelXml=${encodeURIComponent(labelXML)}&labelSetXml=`
                    });

                    if (response.ok) {
                        printedCount++;
                    } else {
                        failedCount++;
                    }

                    // Small delay between prints
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    console.error('Error printing label:', error);
                    failedCount++;
                }
            }

            if (failedCount > 0) {
                showAlert(`Printed ${printedCount} label(s). ${failedCount} failed. Check printer connection.`, 'Print Complete');
            } else {
                showAlert(`Successfully printed ${printedCount} label(s) to Dymo LabelWriter!`, 'Success');
            }
        }

        // Render pipette selection list for Dymo printing
        function renderDymoLabelList() {
            const container = document.getElementById('dymoLabelPipetteList');
            if (!container) return;

            if (pipettes.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">No pipettes added yet. Go to Calibration tab to add pipettes.</p>';
                return;
            }

            container.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="margin: 0 0 15px 0;">Select Pipettes to Print:</h4>
                    ${pipettes.map(p => {
                        const serial = p.serial || 'No Serial';
                        const volume = p.maxVolume || p.volume || 'N/A';
                        const status = p.serviceLevel === 'basic'
                            ? (p.passFail || 'PENDING')
                            : (p.statusAsLeft ? p.statusAsLeft.toUpperCase() : 'PENDING');
                        return `
                            <label style="display: flex; align-items: center; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; margin-bottom: 8px; cursor: pointer; background: #f8f9fa;">
                                <input type="checkbox" class="dymo-label-checkbox" data-pipette-id="${p.id}" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                                <div style="flex: 1;">
                                    <strong>Pipette #${String(p.id).padStart(2, '0')}</strong> -
                                    ${serial} -
                                    ${volume} ¬µL -
                                    <span style="color: ${status === 'PASS' ? '#28a745' : status === 'FAIL' ? '#dc3545' : '#ffc107'};">${status}</span>
                                </div>
                            </label>
                        `;
                    }).join('')}
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="printSelectedToDymo()">üñ®Ô∏è Print Selected to Dymo</button>
                        <button class="btn btn-secondary" onclick="selectAllDymoLabels()">‚òëÔ∏è Select All</button>
                        <button class="btn btn-secondary" onclick="deselectAllDymoLabels()">‚òê Deselect All</button>
                    </div>
                </div>
            `;
        }

        // Select all Dymo labels
        function selectAllDymoLabels() {
            document.querySelectorAll('.dymo-label-checkbox').forEach(cb => cb.checked = true);
        }

        // Deselect all Dymo labels
        function deselectAllDymoLabels() {
            document.querySelectorAll('.dymo-label-checkbox').forEach(cb => cb.checked = false);
        }

        // ========================================
        // GLOBAL VOICE NAVIGATION SYSTEM
        // ========================================

        // Show global voice status message
        function showGlobalVoiceStatus(message, isError = false) {
            const statusEl = document.getElementById('globalVoiceStatus');
            if (!statusEl) return;

            statusEl.textContent = message;
            statusEl.className = 'show' + (isError ? ' error' : '');

            // Clear previous timeout
            if (globalVoiceStatusTimeout) {
                clearTimeout(globalVoiceStatusTimeout);
            }

            // Auto-hide after 3 seconds
            globalVoiceStatusTimeout = setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }

        // Parse spoken numbers from words
        function parseSpokenNumberGlobal(text) {
            const wordToNumber = {
                'zero': 0, 'one': 1, 'two': 2, 'three': 3, 'four': 4,
                'five': 5, 'six': 6, 'seven': 7, 'eight': 8, 'nine': 9,
                'ten': 10, 'eleven': 11, 'twelve': 12, 'thirteen': 13,
                'fourteen': 14, 'fifteen': 15, 'sixteen': 16, 'seventeen': 17,
                'eighteen': 18, 'nineteen': 19, 'twenty': 20
            };

            // Try direct number first
            const directNum = parseInt(text);
            if (!isNaN(directNum)) return directNum;

            // Try word conversion
            const lower = text.toLowerCase().trim();
            return wordToNumber[lower] || null;
        }

        // Focus and highlight a field
        function focusAndHighlight(element) {
            if (!element) return;

            // Scroll to element
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Add highlight
            element.classList.add('voice-highlight');
            setTimeout(() => {
                element.classList.remove('voice-highlight');
            }, 1500);

            // Focus if it's an input
            if (element.tagName === 'INPUT' || element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') {
                setTimeout(() => {
                    element.focus();
                    if (element.type === 'text' || element.tagName === 'TEXTAREA') {
                        element.select();
                    }
                }, 500);
            }
        }

        // Navigate to a specific pipette
        function navigateToPipette(pipetteNumber) {
            const pipetteCard = document.getElementById(`pipette-${pipetteNumber}`);
            if (pipetteCard) {
                focusAndHighlight(pipetteCard);
                showGlobalVoiceStatus(`Navigated to Pipette #${pipetteNumber}`);
                return true;
            }
            showGlobalVoiceStatus(`Pipette #${pipetteNumber} not found`, true);
            return false;
        }

        // Execute global voice navigation command
        function executeGlobalVoiceCommand(transcript) {
            const lower = transcript.toLowerCase().trim();

            // Help command
            if (lower.includes('help') || lower.includes('what can i say') || lower.includes('commands')) {
                showVoiceHelp();
                return true;
            }

            // Stop listening
            if (lower.includes('stop listening') || lower.includes('turn off voice') || lower.includes('disable voice')) {
                showGlobalVoiceStatus('Voice control disabled');
                stopGlobalVoice();
                return true;
            }

            // Tab navigation
            if (lower.includes('go to') || lower.includes('show')) {
                if (lower.includes('session')) {
                    showTab('session', document.querySelector('.nav-tab:nth-child(1)'));
                    showGlobalVoiceStatus('Switched to Session Info');
                    return true;
                }
                if (lower.includes('calibration')) {
                    showTab('calibrations', document.querySelector('.nav-tab:nth-child(2)'));
                    showGlobalVoiceStatus('Switched to Calibrations');
                    return true;
                }
                if (lower.includes('analysis')) {
                    showTab('analysis', document.querySelector('.nav-tab:nth-child(3)'));
                    showGlobalVoiceStatus('Switched to Analysis');
                    return true;
                }
                if (lower.includes('summary')) {
                    showTab('summary', document.querySelector('.nav-tab:nth-child(4)'));
                    showGlobalVoiceStatus('Switched to Summary Table');
                    return true;
                }
                if (lower.includes('report')) {
                    showTab('report', document.querySelector('.nav-tab:nth-child(5)'));
                    showGlobalVoiceStatus('Switched to Report');
                    return true;
                }
                if (lower.includes('label')) {
                    showTab('labels', document.querySelector('.nav-tab:nth-child(6)'));
                    showGlobalVoiceStatus('Switched to Labels');
                    return true;
                }
                if (lower.includes('inventory')) {
                    showTab('inventory', document.querySelector('.nav-tab:nth-child(7)'));
                    showGlobalVoiceStatus('Switched to Inventory');
                    return true;
                }
                if (lower.includes('history')) {
                    showTab('history', document.querySelector('.nav-tab:nth-child(8)'));
                    showGlobalVoiceStatus('Switched to History');
                    return true;
                }
            }

            // Field navigation - Session Info fields
            if (lower.includes('service provider')) {
                const field = document.getElementById('serviceProvider');
                focusAndHighlight(field);
                showGlobalVoiceStatus('Service Provider field');
                return true;
            }
            if (lower.includes('location')) {
                const field = document.getElementById('location');
                focusAndHighlight(field);
                showGlobalVoiceStatus('Location field');
                return true;
            }
            if (lower.includes('address')) {
                const field = document.getElementById('address');
                focusAndHighlight(field);
                showGlobalVoiceStatus('Address field');
                return true;
            }
            if (lower.includes('client')) {
                const field = document.getElementById('client');
                focusAndHighlight(field);
                showGlobalVoiceStatus('Client field');
                return true;
            }
            if (lower.includes('technician')) {
                const field = document.getElementById('technician');
                focusAndHighlight(field);
                showGlobalVoiceStatus('Technician field');
                return true;
            }
            if (lower.includes('temperature')) {
                const field = document.getElementById('temperature');
                focusAndHighlight(field);
                showGlobalVoiceStatus('Temperature field');
                return true;
            }
            if (lower.includes('humidity')) {
                const field = document.getElementById('humidity');
                focusAndHighlight(field);
                showGlobalVoiceStatus('Humidity field');
                return true;
            }
            if (lower.includes('pressure')) {
                const field = document.getElementById('pressure');
                focusAndHighlight(field);
                showGlobalVoiceStatus('Pressure field');
                return true;
            }
            if (lower.includes('pi name') || lower.includes('principal investigator')) {
                const field = document.getElementById('pi');
                focusAndHighlight(field);
                showGlobalVoiceStatus('PI Name field');
                return true;
            }

            // Pipette navigation
            if (lower.includes('pipette')) {
                // Extract pipette number
                const words = lower.split(' ');
                const pipetteIndex = words.indexOf('pipette');
                if (pipetteIndex !== -1 && pipetteIndex < words.length - 1) {
                    const numberWord = words[pipetteIndex + 1];
                    const pipetteNum = parseSpokenNumberGlobal(numberWord);
                    if (pipetteNum !== null) {
                        // Check for reading number
                        if (lower.includes('reading')) {
                            const readingIndex = words.indexOf('reading');
                            if (readingIndex !== -1 && readingIndex < words.length - 1) {
                                const readingWord = words[readingIndex + 1];
                                const readingNum = parseSpokenNumberGlobal(readingWord);
                                if (readingNum !== null && readingNum >= 1 && readingNum <= 4) {
                                    const field = document.getElementById(`vol${readingNum}-${pipetteNum}`);
                                    if (field) {
                                        focusAndHighlight(field);
                                        showGlobalVoiceStatus(`Pipette #${pipetteNum}, Reading ${readingNum}`);
                                        return true;
                                    }
                                }
                            }
                        }
                        // Check for serial number
                        if (lower.includes('serial')) {
                            const field = document.getElementById(`serial-${pipetteNum}`);
                            if (field) {
                                focusAndHighlight(field);
                                showGlobalVoiceStatus(`Pipette #${pipetteNum}, Serial Number`);
                                return true;
                            }
                        }
                        // Just pipette number - navigate to card
                        return navigateToPipette(pipetteNum);
                    }
                }

                // Next/Previous pipette
                if (lower.includes('next')) {
                    if (pipettes.length > 0) {
                        // Find first visible pipette or first pipette
                        const firstPipette = pipettes[0];
                        navigateToPipette(firstPipette.id);
                    }
                    return true;
                }
                if (lower.includes('previous')) {
                    if (pipettes.length > 0) {
                        const lastPipette = pipettes[pipettes.length - 1];
                        navigateToPipette(lastPipette.id);
                    }
                    return true;
                }
                if (lower.includes('first')) {
                    if (pipettes.length > 0) {
                        navigateToPipette(pipettes[0].id);
                    }
                    return true;
                }
                if (lower.includes('last')) {
                    if (pipettes.length > 0) {
                        navigateToPipette(pipettes[pipettes.length - 1].id);
                    }
                    return true;
                }
            }

            // Action commands
            if (lower.includes('add pipette') || lower.includes('new pipette')) {
                addPipette();
                showGlobalVoiceStatus('Added new pipette');
                return true;
            }
            if (lower.includes('new session')) {
                newSession();
                showGlobalVoiceStatus('Starting new session');
                return true;
            }
            if (lower.includes('generate report')) {
                generateReport();
                showGlobalVoiceStatus('Generating report');
                return true;
            }

            // Scroll commands
            if (lower.includes('scroll up')) {
                window.scrollBy({ top: -300, behavior: 'smooth' });
                showGlobalVoiceStatus('Scrolling up');
                return true;
            }
            if (lower.includes('scroll down')) {
                window.scrollBy({ top: 300, behavior: 'smooth' });
                showGlobalVoiceStatus('Scrolling down');
                return true;
            }

            return false; // No command matched
        }

        // Handle global voice recognition results
        function handleGlobalVoiceResult(transcript) {
            console.log('Global voice heard:', transcript);

            // If volume voice is active, ignore (let volume voice handle it)
            if (currentVoicePipetteId) {
                return;
            }

            // Try to execute command
            const handled = executeGlobalVoiceCommand(transcript);

            if (!handled) {
                showGlobalVoiceStatus(`‚ùì Didn't understand: "${transcript}". Say "help" for commands.`, true);
            }
        }

        // Initialize global voice recognition
        function initGlobalVoiceRecognition() {
            if (!checkVoiceSupport()) {
                return null;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();

            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                const lastResult = event.results[event.results.length - 1];
                if (lastResult.isFinal) {
                    const transcript = lastResult[0].transcript.trim();
                    handleGlobalVoiceResult(transcript);
                }
            };

            recognition.onerror = (event) => {
                console.error('Global voice recognition error:', event.error);
                if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    showGlobalVoiceStatus('‚ùå Microphone access denied', true);
                    stopGlobalVoice();
                } else if (event.error === 'no-speech') {
                    // Ignore no-speech errors for global voice
                } else if (event.error === 'network') {
                    showGlobalVoiceStatus('üì° Network error', true);
                }
            };

            recognition.onend = () => {
                // If still active, restart
                if (globalVoiceActive) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Failed to restart global voice:', e);
                    }
                }
            };

            return recognition;
        }

        // Start global voice control
        function startGlobalVoice() {
            if (!checkVoiceSupport()) {
                showAlert('Voice control is not supported in your browser. Please use Chrome, Edge, or Safari.', 'Info');
                return;
            }

            globalVoiceActive = true;

            // Initialize if needed
            if (!globalVoiceRecognition) {
                globalVoiceRecognition = initGlobalVoiceRecognition();
            }

            try {
                globalVoiceRecognition.start();

                // Update button
                const btn = document.getElementById('globalVoiceBtn');
                if (btn) {
                    btn.classList.add('listening');
                    btn.innerHTML = 'üî¥ Listening';
                }

                showGlobalVoiceStatus('üéôÔ∏è Voice control active. Say "help" for commands.');
            } catch (error) {
                console.error('Failed to start global voice:', error);
                showGlobalVoiceStatus('Failed to start voice control', true);
                globalVoiceActive = false;
            }
        }

        // Stop global voice control
        function stopGlobalVoice() {
            globalVoiceActive = false;

            if (globalVoiceRecognition) {
                try {
                    globalVoiceRecognition.stop();
                } catch (e) {
                    console.error('Error stopping global voice:', e);
                }
            }

            // Update button
            const btn = document.getElementById('globalVoiceBtn');
            if (btn) {
                btn.classList.remove('listening');
                btn.innerHTML = 'üéôÔ∏è Voice Control';
            }
        }

        // Toggle global voice control
        function toggleGlobalVoice() {
            if (globalVoiceActive) {
                stopGlobalVoice();
            } else {
                startGlobalVoice();
            }
        }

        // Show voice help panel
        function showVoiceHelp() {
            const panel = document.getElementById('voiceHelpPanel');
            if (panel) {
                panel.classList.add('show');
            }
        }

        // Close voice help panel
        function closeVoiceHelp() {
            const panel = document.getElementById('voiceHelpPanel');
            if (panel) {
                panel.classList.remove('show');
            }
        }

        // ========================================
        // UNDO/REDO SYSTEM
        // ========================================

        let undoStack = [];
        let redoStack = [];
        const MAX_HISTORY = 20;

        function saveStateForUndo(actionDescription) {
            const state = {
                pipettes: JSON.parse(JSON.stringify(pipettes)), // Deep copy
                currentPipetteId: currentPipetteId,
                sessionInfo: getSessionInfo(),
                action: actionDescription,
                timestamp: Date.now()
            };

            undoStack.push(state);

            // Limit history size
            if (undoStack.length > MAX_HISTORY) {
                undoStack.shift();
            }

            // Clear redo stack when new action is performed
            redoStack = [];

            updateUndoRedoButtons();
        }

        function undo() {
            if (undoStack.length === 0) return;

            // Save current state to redo stack
            const currentState = {
                pipettes: JSON.parse(JSON.stringify(pipettes)),
                currentPipetteId: currentPipetteId,
                sessionInfo: getSessionInfo(),
                timestamp: Date.now()
            };
            redoStack.push(currentState);

            // Restore previous state
            const previousState = undoStack.pop();
            pipettes = previousState.pipettes;
            currentPipetteId = previousState.currentPipetteId;

            // Restore session info
            Object.keys(previousState.sessionInfo).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = previousState.sessionInfo[key] || '';
                }
            });

            // Re-render everything
            renderAllPipettes();
            updateAnalysis();
            updateEmptyState();
            autoSave();
            updateUndoRedoButtons();

            // Show notification
            showUndoNotification(`Undid: ${previousState.action}`);
        }

        function redo() {
            if (redoStack.length === 0) return;

            // Save current state to undo stack
            const currentState = {
                pipettes: JSON.parse(JSON.stringify(pipettes)),
                currentPipetteId: currentPipetteId,
                sessionInfo: getSessionInfo(),
                action: 'Redo',
                timestamp: Date.now()
            };
            undoStack.push(currentState);

            // Restore next state
            const nextState = redoStack.pop();
            pipettes = nextState.pipettes;
            currentPipetteId = nextState.currentPipetteId;

            // Restore session info
            Object.keys(nextState.sessionInfo).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = nextState.sessionInfo[key] || '';
                }
            });

            // Re-render everything
            renderAllPipettes();
            updateAnalysis();
            updateEmptyState();
            autoSave();
            updateUndoRedoButtons();

            // Show notification
            showUndoNotification('Redid action');
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');

            if (undoBtn) {
                undoBtn.disabled = undoStack.length === 0;
                if (undoStack.length > 0) {
                    const lastAction = undoStack[undoStack.length - 1].action;
                    undoBtn.title = `Undo: ${lastAction}`;
                } else {
                    undoBtn.title = 'Nothing to undo';
                }
            }

            if (redoBtn) {
                redoBtn.disabled = redoStack.length === 0;
                redoBtn.title = redoStack.length > 0 ? 'Redo last action' : 'Nothing to redo';
            }
        }

        function showUndoNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #69B135;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: fadeIn 0.3s ease;
                font-size: 14px;
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Keyboard shortcuts for undo/redo
        document.addEventListener('keydown', (e) => {
            // Ctrl+Z or Cmd+Z for undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
            }
            // Ctrl+Shift+Z or Cmd+Shift+Z for redo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
                e.preventDefault();
                redo();
            }
            // Ctrl+Y or Cmd+Y for redo (alternative)
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                e.preventDefault();
                redo();
            }
        });

        // ========================================
        // BACKUP REMINDER SYSTEM
        // ========================================

        function checkBackupReminder() {
            const BACKUP_REMINDER_DAYS = 7;
            const DISMISS_DURATION_MS = 24 * 60 * 60 * 1000; // 24 hours

            const lastBackup = localStorage.getItem('lastBackupDate');
            const dismissedUntil = localStorage.getItem('backupReminderDismissedUntil');

            // Check if reminder is currently dismissed
            if (dismissedUntil && Date.now() < parseInt(dismissedUntil)) {
                return; // Don't show reminder yet
            }

            // Check if backup is needed
            const now = Date.now();
            const daysSinceBackup = lastBackup ? (now - parseInt(lastBackup)) / (1000 * 60 * 60 * 24) : 999;

            if (daysSinceBackup > BACKUP_REMINDER_DAYS) {
                showBackupReminder();
            }
        }

        function showBackupReminder() {
            // Remove any existing reminder
            const existing = document.getElementById('backupReminder');
            if (existing) existing.remove();

            const banner = document.createElement('div');
            banner.id = 'backupReminder';
            banner.style.cssText = `
                position: fixed;
                top: 70px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
                color: #2d3436;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 9999;
                display: flex;
                align-items: center;
                gap: 15px;
                max-width: 600px;
                animation: slideDown 0.3s ease;
                font-size: 14px;
                font-weight: 500;
            `;

            banner.innerHTML = `
                <span style="font-size: 24px;">‚ö†Ô∏è</span>
                <div style="flex: 1;">
                    <strong>Backup Reminder:</strong> It's been over 7 days since your last backup.
                    <br><small>Download your data to prevent loss.</small>
                </div>
                <button onclick="downloadBackupAndDismiss()" style="padding: 8px 16px; background: #00b894; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    üì• Download Backup
                </button>
                <button onclick="dismissBackupReminder()" style="padding: 8px 16px; background: #636e72; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Dismiss 24h
                </button>
                <button onclick="closeBackupReminder()" style="padding: 4px 8px; background: transparent; border: none; cursor: pointer; font-size: 18px;">
                    ‚úï
                </button>
            `;

            document.body.appendChild(banner);
        }

        function downloadBackupAndDismiss() {
            saveJSON(); // Trigger download
            localStorage.setItem('lastBackupDate', Date.now().toString());
            closeBackupReminder();
        }

        function dismissBackupReminder() {
            const dismissUntil = Date.now() + (24 * 60 * 60 * 1000); // 24 hours from now
            localStorage.setItem('backupReminderDismissedUntil', dismissUntil.toString());
            closeBackupReminder();
        }

        function closeBackupReminder() {
            const banner = document.getElementById('backupReminder');
            if (banner) {
                banner.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => banner.remove(), 300);
            }
        }

        // ========================================
        // AUTOFILL SYSTEM FOR COMMON VALUES
        // ========================================

        function saveRecentValue(fieldName, value) {
            if (!value || value.trim() === '') return;

            const recentValues = JSON.parse(localStorage.getItem('recentValues') || '{}');

            if (!recentValues[fieldName]) {
                recentValues[fieldName] = [];
            }

            // Remove duplicate if exists
            recentValues[fieldName] = recentValues[fieldName].filter(v => v !== value);

            // Add to front
            recentValues[fieldName].unshift(value);

            // Keep only last 5 unique values
            recentValues[fieldName] = recentValues[fieldName].slice(0, 5);

            localStorage.setItem('recentValues', JSON.stringify(recentValues));
        }

        function getRecentValues(fieldName) {
            const recentValues = JSON.parse(localStorage.getItem('recentValues') || '{}');
            return recentValues[fieldName] || [];
        }

        function setupAutofill() {
            const autofillFields = ['technician', 'location', 'client'];

            autofillFields.forEach(fieldName => {
                const input = document.getElementById(fieldName);
                if (!input) return;

                // Create datalist if doesn't exist
                let datalist = document.getElementById(`${fieldName}List`);
                if (!datalist) {
                    datalist = document.createElement('datalist');
                    datalist.id = `${fieldName}List`;
                    input.setAttribute('list', `${fieldName}List`);
                    input.parentNode.appendChild(datalist);
                }

                // Populate datalist with recent values
                const recentValues = getRecentValues(fieldName);
                datalist.innerHTML = recentValues.map(value =>
                    `<option value="${value}">`
                ).join('');

                // Save value when changed
                input.addEventListener('change', () => {
                    saveRecentValue(fieldName, input.value);
                    // Update datalist
                    const updated = getRecentValues(fieldName);
                    datalist.innerHTML = updated.map(value =>
                        `<option value="${value}">`
                    ).join('');
                });
            });
        }

        // ========================================
        // INPUT VALIDATION FUNCTIONS
        // ========================================

        function validateInput(input, min = 0, max = 10000) {
            const value = parseFloat(input.value);

            // Remove previous error
            clearValidationError(input);
            input.classList.remove('error', 'valid');

            // If empty, don't validate (allow optional fields)
            if (input.value === '') {
                return true;
            }

            // Check if not a number
            if (isNaN(value)) {
                showValidationError(input, 'Please enter a valid number');
                return false;
            }

            // Check minimum
            if (value < min) {
                showValidationError(input, `Value must be at least ${min}`);
                return false;
            }

            // Check maximum
            if (value > max) {
                showValidationError(input, `Value must be no more than ${max}`);
                return false;
            }

            // Valid!
            input.classList.add('valid');
            return true;
        }

        function showValidationError(input, message) {
            input.classList.add('error');

            // Check if error message already exists
            let errorMsg = input.parentElement.querySelector('.error-message');
            if (!errorMsg) {
                errorMsg = document.createElement('span');
                errorMsg.className = 'error-message';
                input.parentElement.appendChild(errorMsg);
            }
            errorMsg.textContent = '‚ö†Ô∏è ' + message;
        }

        function clearValidationError(input) {
            input.classList.remove('error');
            const errorMsg = input.parentElement.querySelector('.error-message');
            if (errorMsg) {
                errorMsg.remove();
            }
        }

        function validateMeasurementInput(input) {
            // Measurements should be 0-10000 ŒºL
            return validateInput(input, 0, 10000);
        }

        function validateTemperature(input) {
            // Lab temperature: 15-30¬∞C
            return validateInput(input, 15, 30);
        }

        function validateHumidity(input) {
            // Relative humidity: 20-80%
            return validateInput(input, 20, 80);
        }

        function validatePressure(input) {
            // Atmospheric pressure: 90-110 kPa
            return validateInput(input, 90, 110);
        }

        // ISO 8655 Specifications Database - Complete with all models
        const isoSpecs = {
            'P-2': {
                0.2: { accuracy: { from: 0.12, to: 0.28, percent: 40.0, ul: 0.08 }, precision: { percent: 20.0, ul: 0.04 } },
                0.5: { accuracy: { from: 0.42, to: 0.58, percent: 16.0, ul: 0.08 }, precision: { percent: 8.0, ul: 0.04 } },
                1: { accuracy: { from: 0.92, to: 1.08, percent: 8.0, ul: 0.08 }, precision: { percent: 4.0, ul: 0.04 } },
                2: { accuracy: { from: 1.92, to: 2.08, percent: 4.0, ul: 0.08 }, precision: { percent: 2.0, ul: 0.04 } }
            },
            'P-2.5': {
                0.5: { accuracy: { from: 0.42, to: 0.58, percent: 16.0, ul: 0.08 }, precision: { percent: 8.0, ul: 0.04 } },
                1.25: { accuracy: { from: 1.17, to: 1.33, percent: 6.4, ul: 0.08 }, precision: { percent: 3.2, ul: 0.04 } },
                2.5: { accuracy: { from: 2.42, to: 2.58, percent: 3.2, ul: 0.08 }, precision: { percent: 1.6, ul: 0.04 } }
            },
            'P-10': {
                1: { accuracy: { from: 0.88, to: 1.12, percent: 12.0, ul: 0.12 }, precision: { percent: 8.0, ul: 0.08 } },
                2: { accuracy: { from: 1.88, to: 2.12, percent: 6.0, ul: 0.12 }, precision: { percent: 4.0, ul: 0.08 } },
                5: { accuracy: { from: 4.88, to: 5.12, percent: 2.4, ul: 0.12 }, precision: { percent: 1.6, ul: 0.08 } },
                10: { accuracy: { from: 9.88, to: 10.12, percent: 1.2, ul: 0.12 }, precision: { percent: 0.8, ul: 0.08 } }
            },
            'P-20': {
                2: { accuracy: { from: 1.80, to: 2.20, percent: 10.0, ul: 0.2 }, precision: { percent: 5.0, ul: 0.1 } },
                5: { accuracy: { from: 4.80, to: 5.20, percent: 4.0, ul: 0.2 }, precision: { percent: 2.0, ul: 0.1 } },
                10: { accuracy: { from: 9.80, to: 10.20, percent: 2.0, ul: 0.2 }, precision: { percent: 1.0, ul: 0.1 } },
                20: { accuracy: { from: 19.80, to: 20.20, percent: 1.0, ul: 0.2 }, precision: { percent: 0.5, ul: 0.1 } }
            },
            'P-25': {
                5: { accuracy: { from: 4.50, to: 5.50, percent: 10.0, ul: 0.5 }, precision: { percent: 4.0, ul: 0.2 } },
                12.5: { accuracy: { from: 12.00, to: 13.00, percent: 4.0, ul: 0.5 }, precision: { percent: 1.6, ul: 0.2 } },
                25: { accuracy: { from: 24.50, to: 25.50, percent: 2.0, ul: 0.5 }, precision: { percent: 0.8, ul: 0.2 } }
            },
            'P-50': {
                10: { accuracy: { from: 9.50, to: 10.50, percent: 5.0, ul: 0.5 }, precision: { percent: 2.0, ul: 0.2 } },
                25: { accuracy: { from: 24.5, to: 25.5, percent: 2.0, ul: 0.5 }, precision: { percent: 0.8, ul: 0.2 } },
                50: { accuracy: { from: 49.5, to: 50.5, percent: 1.0, ul: 0.5 }, precision: { percent: 0.4, ul: 0.2 } }
            },
            'P-100': {
                10: { accuracy: { from: 9.2, to: 10.8, percent: 8.0, ul: 0.8 }, precision: { percent: 3.0, ul: 0.3 } },
                20: { accuracy: { from: 19.2, to: 20.8, percent: 4.0, ul: 0.8 }, precision: { percent: 1.5, ul: 0.3 } },
                50: { accuracy: { from: 49.2, to: 50.8, percent: 1.6, ul: 0.8 }, precision: { percent: 0.6, ul: 0.3 } },
                100: { accuracy: { from: 99.2, to: 100.8, percent: 0.8, ul: 0.8 }, precision: { percent: 0.3, ul: 0.3 } }
            },
            'P-200': {
                20: { accuracy: { from: 18.4, to: 21.6, percent: 8.0, ul: 1.6 }, precision: { percent: 3.0, ul: 0.6 } },
                50: { accuracy: { from: 48.4, to: 51.6, percent: 3.2, ul: 1.6 }, precision: { percent: 1.2, ul: 0.6 } },
                100: { accuracy: { from: 98.4, to: 101.6, percent: 1.6, ul: 1.6 }, precision: { percent: 0.6, ul: 0.6 } },
                200: { accuracy: { from: 198.4, to: 201.6, percent: 0.8, ul: 1.6 }, precision: { percent: 0.3, ul: 0.6 } }
            },
            'P-250': {
                25: { accuracy: { from: 21.0, to: 29.0, percent: 16.0, ul: 4.0 }, precision: { percent: 6.0, ul: 1.5 } },
                50: { accuracy: { from: 46.0, to: 54.0, percent: 8.0, ul: 4.0 }, precision: { percent: 3.0, ul: 1.5 } },
                125: { accuracy: { from: 121.0, to: 129.0, percent: 3.2, ul: 4.0 }, precision: { percent: 1.2, ul: 1.5 } },
                150: { accuracy: { from: 146.0, to: 154.0, percent: 2.7, ul: 4.0 }, precision: { percent: 1.0, ul: 1.5 } },
                250: { accuracy: { from: 246.0, to: 254.0, percent: 1.6, ul: 4.0 }, precision: { percent: 0.6, ul: 1.5 } }
            },
            'P-300': {
                30: { accuracy: { from: 26.0, to: 34.0, percent: 13.3, ul: 4.0 }, precision: { percent: 5.0, ul: 1.5 } },
                50: { accuracy: { from: 46.0, to: 54.0, percent: 8.0, ul: 4.0 }, precision: { percent: 3.0, ul: 1.5 } },
                200: { accuracy: { from: 196.0, to: 204.0, percent: 2.0, ul: 4.0 }, precision: { percent: 0.8, ul: 1.5 } },
                300: { accuracy: { from: 296.0, to: 304.0, percent: 1.3, ul: 4.0 }, precision: { percent: 0.5, ul: 1.5 } }
            },
            'P-500': {
                100: { accuracy: { from: 96.0, to: 104.0, percent: 4.0, ul: 4.0 }, precision: { percent: 1.5, ul: 1.5 } },
                250: { accuracy: { from: 246.0, to: 254.0, percent: 1.6, ul: 4.0 }, precision: { percent: 0.6, ul: 1.5 } },
                500: { accuracy: { from: 496.0, to: 504.0, percent: 0.8, ul: 4.0 }, precision: { percent: 0.3, ul: 1.5 } }
            },
            'P-1000': {
                100: { accuracy: { from: 92.0, to: 108.0, percent: 8.0, ul: 8.0 }, precision: { percent: 3.0, ul: 3.0 } },
                200: { accuracy: { from: 192.0, to: 208.0, percent: 4.0, ul: 8.0 }, precision: { percent: 1.5, ul: 3.0 } },
                500: { accuracy: { from: 492.0, to: 508.0, percent: 1.6, ul: 8.0 }, precision: { percent: 0.6, ul: 3.0 } },
                1000: { accuracy: { from: 992.0, to: 1008.0, percent: 0.8, ul: 8.0 }, precision: { percent: 0.3, ul: 3.0 } }
            },
            'P-1200': {
                250: { accuracy: { from: 234.0, to: 266.0, percent: 6.4, ul: 16.0 }, precision: { percent: 2.4, ul: 6.0 } },
                600: { accuracy: { from: 584.0, to: 616.0, percent: 2.7, ul: 16.0 }, precision: { percent: 1.0, ul: 6.0 } },
                1200: { accuracy: { from: 1184.0, to: 1216.0, percent: 1.3, ul: 16.0 }, precision: { percent: 0.5, ul: 6.0 } }
            },
            'P-1250': {
                250: { accuracy: { from: 234.0, to: 266.0, percent: 6.4, ul: 16.0 }, precision: { percent: 2.4, ul: 6.0 } },
                625: { accuracy: { from: 609.0, to: 641.0, percent: 2.6, ul: 16.0 }, precision: { percent: 1.0, ul: 6.0 } },
                1250: { accuracy: { from: 1234.0, to: 1266.0, percent: 1.3, ul: 16.0 }, precision: { percent: 0.5, ul: 6.0 } }
            },
            'P-2000': {
                500: { accuracy: { from: 484.0, to: 516.0, percent: 3.2, ul: 16.0 }, precision: { percent: 1.2, ul: 6.0 } },
                1000: { accuracy: { from: 984.0, to: 1016.0, percent: 1.6, ul: 16.0 }, precision: { percent: 0.6, ul: 6.0 } },
                2000: { accuracy: { from: 1984.0, to: 2016.0, percent: 0.8, ul: 16.0 }, precision: { percent: 0.3, ul: 6.0 } }
            },
            'P-5000': {
                1000: { accuracy: { from: 960.0, to: 1040.0, percent: 4.0, ul: 40.0 }, precision: { percent: 1.5, ul: 15.0 } },
                2500: { accuracy: { from: 2460.0, to: 2540.0, percent: 1.6, ul: 40.0 }, precision: { percent: 0.6, ul: 15.0 } },
                5000: { accuracy: { from: 4960.0, to: 5040.0, percent: 0.8, ul: 40.0 }, precision: { percent: 0.3, ul: 15.0 } }
            },
            'P-10000': {
                2000: { accuracy: { from: 1940.0, to: 2060.0, percent: 3.0, ul: 60.0 }, precision: { percent: 1.5, ul: 30.0 } },
                5000: { accuracy: { from: 4940.0, to: 5060.0, percent: 1.2, ul: 60.0 }, precision: { percent: 0.6, ul: 30.0 } },
                10000: { accuracy: { from: 9940.0, to: 10060.0, percent: 0.6, ul: 60.0 }, precision: { percent: 0.3, ul: 30.0 } }
            }
        };

        // ISO 8655 Multi-Channel Pipette Specifications
        const isoSpecsMulti = {
            'P-2': {
                0.2: { accuracy: { from: 0.04, to: 0.36, percent: 80.0, ul: 0.16 }, precision: { percent: 40.0, ul: 0.08 } },
                0.5: { accuracy: { from: 0.34, to: 0.66, percent: 32.0, ul: 0.16 }, precision: { percent: 16.0, ul: 0.08 } },
                1: { accuracy: { from: 0.84, to: 1.16, percent: 16.0, ul: 0.16 }, precision: { percent: 8.0, ul: 0.08 } },
                2: { accuracy: { from: 1.84, to: 2.16, percent: 8.0, ul: 0.16 }, precision: { percent: 4.0, ul: 0.08 } }
            },
            'P-10': {
                1: { accuracy: { from: 0.76, to: 1.24, percent: 24.0, ul: 0.24 }, precision: { percent: 16.0, ul: 0.16 } },
                2: { accuracy: { from: 1.76, to: 2.24, percent: 12.0, ul: 0.24 }, precision: { percent: 8.0, ul: 0.16 } },
                5: { accuracy: { from: 4.76, to: 5.24, percent: 4.8, ul: 0.24 }, precision: { percent: 3.2, ul: 0.16 } },
                10: { accuracy: { from: 9.76, to: 10.24, percent: 2.4, ul: 0.24 }, precision: { percent: 1.6, ul: 0.16 } }
            },
            'P-20': {
                2: { accuracy: { from: 1.60, to: 2.40, percent: 20.0, ul: 0.4 }, precision: { percent: 10.0, ul: 0.2 } },
                5: { accuracy: { from: 4.60, to: 5.40, percent: 8.0, ul: 0.4 }, precision: { percent: 4.0, ul: 0.2 } },
                10: { accuracy: { from: 9.60, to: 10.40, percent: 4.0, ul: 0.4 }, precision: { percent: 2.0, ul: 0.2 } },
                20: { accuracy: { from: 19.60, to: 20.40, percent: 2.0, ul: 0.4 }, precision: { percent: 1.0, ul: 0.2 } }
            },
            'P-25': {
                5: { accuracy: { from: 4.00, to: 6.00, percent: 20.0, ul: 1.0 }, precision: { percent: 8.0, ul: 0.4 } },
                12.5: { accuracy: { from: 11.50, to: 13.50, percent: 8.0, ul: 1.0 }, precision: { percent: 3.2, ul: 0.4 } },
                25: { accuracy: { from: 24.00, to: 26.00, percent: 4.0, ul: 1.0 }, precision: { percent: 1.6, ul: 0.4 } }
            },
            'P-50': {
                5: { accuracy: { from: 4.00, to: 6.00, percent: 20.0, ul: 1.0 }, precision: { percent: 8.0, ul: 0.4 } },
                10: { accuracy: { from: 9.00, to: 11.00, percent: 10.0, ul: 1.0 }, precision: { percent: 4.0, ul: 0.4 } },
                25: { accuracy: { from: 24.0, to: 26.0, percent: 4.0, ul: 1.0 }, precision: { percent: 1.6, ul: 0.4 } },
                50: { accuracy: { from: 49.0, to: 51.0, percent: 2.0, ul: 1.0 }, precision: { percent: 0.8, ul: 0.4 } }
            },
            'P-100': {
                10: { accuracy: { from: 8.4, to: 11.6, percent: 16.0, ul: 1.6 }, precision: { percent: 6.0, ul: 0.6 } },
                20: { accuracy: { from: 18.4, to: 21.6, percent: 8.0, ul: 1.6 }, precision: { percent: 3.0, ul: 0.6 } },
                50: { accuracy: { from: 48.4, to: 51.6, percent: 3.2, ul: 1.6 }, precision: { percent: 1.2, ul: 0.6 } },
                100: { accuracy: { from: 98.4, to: 101.6, percent: 1.6, ul: 1.6 }, precision: { percent: 0.6, ul: 0.6 } }
            },
            'P-200': {
                20: { accuracy: { from: 16.8, to: 23.2, percent: 16.0, ul: 3.2 }, precision: { percent: 6.0, ul: 1.2 } },
                50: { accuracy: { from: 46.8, to: 53.2, percent: 6.4, ul: 3.2 }, precision: { percent: 2.4, ul: 1.2 } },
                100: { accuracy: { from: 96.8, to: 103.2, percent: 3.2, ul: 3.2 }, precision: { percent: 1.2, ul: 1.2 } },
                200: { accuracy: { from: 196.8, to: 203.2, percent: 1.6, ul: 3.2 }, precision: { percent: 0.6, ul: 1.2 } }
            },
            'P-250': {
                25: { accuracy: { from: 17.0, to: 33.0, percent: 32.0, ul: 8.0 }, precision: { percent: 12.0, ul: 3.0 } },
                50: { accuracy: { from: 42.0, to: 58.0, percent: 16.0, ul: 8.0 }, precision: { percent: 6.0, ul: 3.0 } },
                150: { accuracy: { from: 142.0, to: 158.0, percent: 5.3, ul: 8.0 }, precision: { percent: 2.0, ul: 3.0 } },
                250: { accuracy: { from: 242.0, to: 258.0, percent: 3.2, ul: 8.0 }, precision: { percent: 1.2, ul: 3.0 } }
            },
            'P-300': {
                30: { accuracy: { from: 22.0, to: 38.0, percent: 26.7, ul: 8.0 }, precision: { percent: 10.0, ul: 3.0 } },
                50: { accuracy: { from: 42.0, to: 58.0, percent: 16.0, ul: 8.0 }, precision: { percent: 6.0, ul: 3.0 } },
                150: { accuracy: { from: 142.0, to: 158.0, percent: 5.3, ul: 8.0 }, precision: { percent: 2.0, ul: 3.0 } },
                200: { accuracy: { from: 192.0, to: 208.0, percent: 4.0, ul: 8.0 }, precision: { percent: 1.5, ul: 3.0 } },
                300: { accuracy: { from: 292.0, to: 308.0, percent: 2.7, ul: 8.0 }, precision: { percent: 1.0, ul: 3.0 } }
            },
            'P-500': {
                50: { accuracy: { from: 42.0, to: 58.0, percent: 16.0, ul: 8.0 }, precision: { percent: 6.0, ul: 3.0 } },
                100: { accuracy: { from: 92.0, to: 108.0, percent: 8.0, ul: 8.0 }, precision: { percent: 3.0, ul: 3.0 } },
                250: { accuracy: { from: 242.0, to: 258.0, percent: 3.2, ul: 8.0 }, precision: { percent: 1.2, ul: 3.0 } },
                500: { accuracy: { from: 492.0, to: 508.0, percent: 1.6, ul: 8.0 }, precision: { percent: 0.6, ul: 3.0 } }
            },
            'P-1000': {
                100: { accuracy: { from: 84.0, to: 116.0, percent: 16.0, ul: 16.0 }, precision: { percent: 6.0, ul: 6.0 } },
                200: { accuracy: { from: 184.0, to: 216.0, percent: 8.0, ul: 16.0 }, precision: { percent: 3.0, ul: 6.0 } },
                500: { accuracy: { from: 484.0, to: 516.0, percent: 3.2, ul: 16.0 }, precision: { percent: 1.2, ul: 6.0 } },
                1000: { accuracy: { from: 984.0, to: 1016.0, percent: 1.6, ul: 16.0 }, precision: { percent: 0.6, ul: 6.0 } }
            },
            'P-1200': {
                120: { accuracy: { from: 88.0, to: 152.0, percent: 26.7, ul: 32.0 }, precision: { percent: 10.0, ul: 12.0 } },
                250: { accuracy: { from: 218.0, to: 282.0, percent: 12.8, ul: 32.0 }, precision: { percent: 4.8, ul: 12.0 } },
                600: { accuracy: { from: 568.0, to: 632.0, percent: 5.3, ul: 32.0 }, precision: { percent: 2.0, ul: 12.0 } },
                1200: { accuracy: { from: 1168.0, to: 1232.0, percent: 2.7, ul: 32.0 }, precision: { percent: 1.0, ul: 12.0 } }
            },
            'P-1250': {
                125: { accuracy: { from: 93.0, to: 157.0, percent: 25.6, ul: 32.0 }, precision: { percent: 9.6, ul: 12.0 } },
                250: { accuracy: { from: 218.0, to: 282.0, percent: 12.8, ul: 32.0 }, precision: { percent: 4.8, ul: 12.0 } },
                625: { accuracy: { from: 593.0, to: 657.0, percent: 5.1, ul: 32.0 }, precision: { percent: 1.9, ul: 12.0 } },
                1250: { accuracy: { from: 1218.0, to: 1282.0, percent: 2.6, ul: 32.0 }, precision: { percent: 1.0, ul: 12.0 } }
            },
            'P-2000': {
                200: { accuracy: { from: 168.0, to: 232.0, percent: 16.0, ul: 32.0 }, precision: { percent: 6.0, ul: 12.0 } },
                400: { accuracy: { from: 368.0, to: 432.0, percent: 8.0, ul: 32.0 }, precision: { percent: 3.0, ul: 12.0 } },
                1000: { accuracy: { from: 968.0, to: 1032.0, percent: 3.2, ul: 32.0 }, precision: { percent: 1.2, ul: 12.0 } },
                2000: { accuracy: { from: 1968.0, to: 2032.0, percent: 1.6, ul: 32.0 }, precision: { percent: 0.6, ul: 12.0 } }
            },
            'P-5000': {
                500: { accuracy: { from: 420.0, to: 580.0, percent: 16.0, ul: 80.0 }, precision: { percent: 6.0, ul: 30.0 } },
                1000: { accuracy: { from: 920.0, to: 1080.0, percent: 8.0, ul: 80.0 }, precision: { percent: 3.0, ul: 30.0 } },
                2500: { accuracy: { from: 2420.0, to: 2580.0, percent: 3.2, ul: 80.0 }, precision: { percent: 1.2, ul: 30.0 } },
                5000: { accuracy: { from: 4920.0, to: 5080.0, percent: 1.6, ul: 80.0 }, precision: { percent: 0.6, ul: 30.0 } }
            },
            'P-10000': {
                500: { accuracy: { from: 380.0, to: 620.0, percent: 24.0, ul: 120.0 }, precision: { percent: 12.0, ul: 60.0 } },
                2000: { accuracy: { from: 1880.0, to: 2120.0, percent: 6.0, ul: 120.0 }, precision: { percent: 3.0, ul: 60.0 } },
                5000: { accuracy: { from: 4880.0, to: 5120.0, percent: 2.4, ul: 120.0 }, precision: { percent: 1.2, ul: 60.0 } },
                10000: { accuracy: { from: 9880.0, to: 10120.0, percent: 1.6, ul: 120.0 }, precision: { percent: 0.6, ul: 60.0 } }
            }
        };

        function getVolumePrecision(volume) {
            return volume <= 25 ? { step: 0.01, decimals: 2 } : { step: 0.1, decimals: 1 };
        }

        function formatVolume(value, decimals) {
            // Auto-determine decimal places based on volume if not specified
            if (decimals === undefined) {
                const precision = getVolumePrecision(parseFloat(value));
                decimals = precision.decimals;
            }
            return parseFloat(value).toFixed(decimals);
        }

        // ========== LocalStorage Persistence Functions ==========

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function autoSave() {
            if (!currentSessionId) {
                currentSessionId = generateSessionId();
            }

            const sessionData = {
                id: currentSessionId,
                sessionInfo: getSessionInfo(),
                pipettes: pipettes,
                balances: balances,
                timers: timers,
                centrifuges: centrifuges,
                temperatureDevices: temperatureDevices,
                inventoryUsage: inventoryUsage,
                currentPipetteId: currentPipetteId,
                currentBalanceId: currentBalanceId,
                currentTimerId: currentTimerId,
                currentCentrifugeId: currentCentrifugeId,
                currentTemperatureDeviceId: currentTemperatureDeviceId,
                timestamp: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };

            try {
                // Save current session
                localStorage.setItem('currentSession', JSON.stringify(sessionData));

                // Update sessions list
                let sessions = JSON.parse(localStorage.getItem('calibrationSessions') || '[]');
                const existingIndex = sessions.findIndex(s => s.id === currentSessionId);

                if (existingIndex >= 0) {
                    sessions[existingIndex] = sessionData;
                } else {
                    sessions.unshift(sessionData);
                }

                // Keep only last 50 sessions
                if (sessions.length > 50) {
                    sessions = sessions.slice(0, 50);
                }

                localStorage.setItem('calibrationSessions', JSON.stringify(sessions));

                showSaveIndicator();
                updateCalibrationTypeCounts();
            } catch (error) {
                // Handle localStorage errors (quota exceeded, disabled, etc.)
                if (error.name === 'QuotaExceededError') {
                    showAlert('Storage quota exceeded! Your data may not be saved. Please download a backup using the "Save JSON" button.', 'Storage Warning');
                } else if (error.name === 'SecurityError') {
                    showAlert('Browser storage is disabled. Data cannot be saved automatically. Please download backups regularly.', 'Storage Disabled');
                } else {
                    console.error('Error saving session:', error);
                    showAlert('An error occurred while saving your data. Please download a backup to prevent data loss.', 'Save Error');
                }
            }
        }

        function debouncedAutoSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                autoSave();
            }, 500); // Save 500ms after last change
        }

        // Save before window closes to prevent data loss
        window.addEventListener('beforeunload', (e) => {
            if (pipettes.length > 0 || balances.length > 0 || timers.length > 0 || centrifuges.length > 0 || temperatureDevices.length > 0) {
                autoSave();
            }
        });

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        function loadCurrentSession() {
            const savedSession = localStorage.getItem('currentSession');
            if (!savedSession) return false;

            try {
                const sessionData = JSON.parse(savedSession);
                currentSessionId = sessionData.id;
                pipettes = sessionData.pipettes || [];
                balances = sessionData.balances || [];
                timers = sessionData.timers || [];
                centrifuges = sessionData.centrifuges || [];
                temperatureDevices = sessionData.temperatureDevices || [];
                inventoryUsage = sessionData.inventoryUsage || [];
                currentPipetteId = sessionData.currentPipetteId || 0;
                currentBalanceId = sessionData.currentBalanceId || 0;
                currentTimerId = sessionData.currentTimerId || 0;
                currentCentrifugeId = sessionData.currentCentrifugeId || 0;
                currentTemperatureDeviceId = sessionData.currentTemperatureDeviceId || 0;

                // Restore session info
                const sessionInfo = sessionData.sessionInfo || {};
                Object.keys(sessionInfo).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = sessionInfo[key] || '';
                    }
                });

                // Render all pipettes (add backward compatibility for old sessions)
                pipettes.forEach(pipette => {
                    // Add default channelType for old sessions
                    if (!pipette.channelType) {
                        pipette.channelType = 'single';
                        pipette.channelCount = 1;
                    }
                    // Add default serviceLevel for old sessions
                    if (!pipette.serviceLevel) {
                        pipette.serviceLevel = 'platinum';
                    }
                    renderPipette(pipette);
                    ['asFound', 'asLeft'].forEach(condition => {
                        ['low', 'mid', 'high'].forEach(point => {
                            validateMeasurement(pipette.id, condition, point);
                        });
                    });
                    updateOverallStatus(pipette.id);
                });

                // Render all equipment types
                if (balances.length > 0) {
                    renderBalances();
                }
                if (timers.length > 0) {
                    renderTimers();
                }
                if (centrifuges.length > 0) {
                    renderCentrifuges();
                }
                if (temperatureDevices.length > 0) {
                    renderTemperatureDevices();
                }

                updateProgress();
                updateAnalysis();
                renderInventoryUsage();
                updateInventoryStats();
                updateSummaryTable();
                updateManifest();
                updateCalibrationTypeCounts();
                return true;
            } catch (e) {
                console.error('Error loading session:', e);
                return false;
            }
        }

        // ========================================
        // WORK ORDER & INVOICE GENERATION
        // ========================================

        function generateWorkOrderAndInvoice() {
            const client = document.getElementById('client')?.value || '';
            const technician = document.getElementById('technician')?.value || '';
            const serviceDateInput = document.getElementById('serviceDate')?.value;
            const frequency = document.getElementById('frequency')?.value || 'A';
            const counter = parseInt(document.getElementById('invoiceCounter')?.value || '1');

            // Use service date or calibration date or today's date
            let day, month, year;
            const dateToUse = serviceDateInput || document.getElementById('calDate')?.value;

            if (dateToUse) {
                // Parse YYYY-MM-DD directly to avoid timezone issues
                const parts = dateToUse.split('-');
                year = parts[0].slice(-2); // Last 2 digits of year
                month = parts[1]; // Already 2 digits (01-12)
                day = parseInt(parts[2]); // No leading zero (1-31)
            } else {
                // Use today's date
                const today = new Date();
                day = today.getDate();
                month = String(today.getMonth() + 1).padStart(2, '0');
                year = String(today.getFullYear()).slice(-2);
            }

            // Generate Work Order Number: "Doerksen 12-22 1#A" (MM-DD format)
            if (client) {
                const clientLastName = client.trim().split(' ').pop(); // Get last word as last name
                const workOrderNo = `${clientLastName} ${month}-${day} ${counter}#${frequency}`;
                document.getElementById('workOrderNo').value = workOrderNo;
            }

            // Generate Invoice Number: "TSD2112241A"
            if (technician) {
                const techInitials = technician.trim().toUpperCase();
                const invoiceNo = `${techInitials}${day}${month}${year}${counter}${frequency}`;
                document.getElementById('invoiceNo').value = invoiceNo;
            }

            debouncedAutoSave();
        }

        // ========================================
        // SERVICE LEVEL MANAGEMENT
        // ========================================

        function handleServiceLevelChange(newLevel) {
            const badge = document.getElementById('serviceLevelBadge');
            const description = document.getElementById('serviceLevelDescription');
            const envSection = document.getElementById('environmentalSection');

            if (newLevel === 'platinum') {
                badge.innerHTML = `
                    <div style="color: white; font-size: 28px; margin-bottom: 5px;">üèÜ</div>
                    <div style="color: white; font-weight: 600; font-size: 14px;">PLATINUM</div>
                `;
                description.textContent = 'Full gravimetric calibration with environmental corrections, multi-channel support, and ISO 8655 compliance';

                // Show Analysis tab, hide Summary Table tab
                updateTabVisibility('platinum');

                // Show environmental conditions (needed for Platinum)
                if (envSection) envSection.style.display = 'block';
            } else {
                badge.innerHTML = `
                    <div style="color: white; font-size: 28px; margin-bottom: 5px;">‚ö°</div>
                    <div style="color: white; font-weight: 600; font-size: 14px;">BASIC</div>
                `;
                description.textContent = 'Quick pass/fail calibration with adjustment tracking and final volume verification';

                // Hide Analysis tab, show Summary Table tab
                updateTabVisibility('basic');

                // Hide environmental conditions (not needed for Basic)
                if (envSection) envSection.style.display = 'none';
            }

            // Warn if switching with existing pipettes
            if (pipettes.length > 0) {
                showAlert(`‚ö†Ô∏è Changing service level with ${pipettes.length} pipette(s) already added. Existing data may not be compatible. Consider starting a new session.`, 'Warning');
            }

            // Save choice
            debouncedAutoSave();
        }

        function updateTabVisibility(serviceLevel) {
            const analysisTab = document.getElementById('analysisTab');
            const summaryTab = document.getElementById('summaryTab');

            if (serviceLevel === 'platinum') {
                // Show Analysis, hide Summary
                if (analysisTab) analysisTab.style.display = '';
                if (summaryTab) summaryTab.style.display = 'none';
            } else {
                // Hide Analysis, show Summary
                if (analysisTab) analysisTab.style.display = 'none';
                if (summaryTab) summaryTab.style.display = '';
            }

            // Labels and Inventory always visible
        }

        function newSession() {
            if (pipettes.length > 0) {
                showConfirm('Start a new session? Current data will be saved to history.', 'New Session', () => {
                    autoSave(); // Save current before starting new
                    executeNewSession();
                });
            } else {
                executeNewSession();
            }
        }

        function executeNewSession() {
            // Clear current session
            currentSessionId = null;
            pipettes = [];
            currentPipetteId = 0;
            document.getElementById('pipettesContainer').innerHTML = '';

            // Clear session form
            document.querySelectorAll('#session input, #session select').forEach(input => {
                if (input.type === 'date') {
                    // Keep default dates
                } else {
                    input.value = '';
                }
            });

            localStorage.removeItem('currentSession');
            updateProgress();
            updateAnalysis();

            showAlert('New session started!', 'Success');
        }

        function loadSessionFromHistory(sessionId) {
            const sessions = JSON.parse(localStorage.getItem('calibrationSessions') || '[]');
            const session = sessions.find(s => s.id === sessionId);

            if (!session) {
                showAlert('Session not found!', 'Error');
                return;
            }

            showConfirm('Load this session? Current work will be saved.', 'Load Session', () => {
                showLoading('Loading session...');

                // Use setTimeout to allow the loading spinner to render
                setTimeout(() => {
                    if (currentSessionId) {
                        autoSave();
                    }

                    // Clear current
                    document.getElementById('pipettesContainer').innerHTML = '';
                    document.getElementById('balancesList').innerHTML = '';
                    document.getElementById('timersList').innerHTML = '';
                    document.getElementById('centrifugesList').innerHTML = '';
                    document.getElementById('temperatureDevicesList').innerHTML = '';
                    pipettes = [];
                balances = [];
                timers = [];
                centrifuges = [];
                temperatureDevices = [];
                inventoryUsage = [];

                // Load selected session
                currentSessionId = session.id;
                pipettes = session.pipettes || [];
                balances = session.balances || [];
                timers = session.timers || [];
                centrifuges = session.centrifuges || [];
                temperatureDevices = session.temperatureDevices || [];
                inventoryUsage = session.inventoryUsage || [];
                currentPipetteId = session.currentPipetteId || 0;
                currentBalanceId = session.currentBalanceId || 0;
                currentTimerId = session.currentTimerId || 0;
                currentCentrifugeId = session.currentCentrifugeId || 0;
                currentTemperatureDeviceId = session.currentTemperatureDeviceId || 0;

                // Restore session info
                const sessionInfo = session.sessionInfo || {};
                Object.keys(sessionInfo).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = sessionInfo[key] || '';
                    }
                });

                // Render pipettes
                pipettes.forEach(pipette => {
                    // Add backward compatibility
                    if (!pipette.serviceLevel) {
                        pipette.serviceLevel = 'platinum';
                    }
                    renderPipette(pipette);
                    ['asFound', 'asLeft'].forEach(condition => {
                        ['low', 'mid', 'high'].forEach(point => {
                            validateMeasurement(pipette.id, condition, point);
                        });
                    });
                    updateOverallStatus(pipette.id);
                });

                // Render all equipment types
                if (balances.length > 0) {
                    renderBalances();
                }
                if (timers.length > 0) {
                    renderTimers();
                }
                if (centrifuges.length > 0) {
                    renderCentrifuges();
                }
                if (temperatureDevices.length > 0) {
                    renderTemperatureDevices();
                }

                    updateProgress();
                    updateAnalysis();
                    renderInventoryUsage();
                    updateInventoryStats();
                    updateSummaryTable();
                    updateManifest();
                    updateCalibrationTypeCounts();

                    // Save as current session
                    localStorage.setItem('currentSession', JSON.stringify(session));

                    hideLoading();
                    showTab('calibrations', document.querySelector('.nav-tab:nth-child(2)'));
                }, 100);
            });
        }

        function deleteSession(sessionId, event) {
            event.stopPropagation();

            showConfirm('Delete this session? This cannot be undone.', 'Delete Session', () => {
                executeDeleteSession(sessionId);
            });
        }

        function executeDeleteSession(sessionId) {

            let sessions = JSON.parse(localStorage.getItem('calibrationSessions') || '[]');
            sessions = sessions.filter(s => s.id !== sessionId);
            localStorage.setItem('calibrationSessions', JSON.stringify(sessions));

            if (currentSessionId === sessionId) {
                localStorage.removeItem('currentSession');
                currentSessionId = null;
            }

            loadHistory();
        }

        function importFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const sessionData = JSON.parse(event.target.result);

                        // Validate the imported data structure
                        if (!sessionData || typeof sessionData !== 'object') {
                            throw new Error('Invalid file format: Not a valid JSON object');
                        }

                        if (!Array.isArray(sessionData.pipettes)) {
                            throw new Error('Invalid file format: Missing or invalid pipettes data');
                        }

                        // Validate sessionInfo exists
                        if (!sessionData.sessionInfo || typeof sessionData.sessionInfo !== 'object') {
                            sessionData.sessionInfo = {}; // Create empty if missing
                        }

                        showConfirm("Load this session from file? Current work will be saved.", "Import Session", () => {
                            if (currentSessionId) {
                                autoSave();
                            }

                            // Assign new session ID
                            sessionData.id = generateSessionId();
                            sessionData.lastModified = new Date().toISOString();

                            // Clear and load
                            document.getElementById('pipettesContainer').innerHTML = '';
                            pipettes = sessionData.pipettes || [];
                            currentPipetteId = sessionData.currentPipetteId || (pipettes.length > 0 ? Math.max(...pipettes.map(p => p.id)) : 0);
                            currentSessionId = sessionData.id;

                            // Restore session info
                            const sessionInfo = sessionData.sessionInfo || {};
                            Object.keys(sessionInfo).forEach(key => {
                                const element = document.getElementById(key);
                                if (element) {
                                    element.value = sessionInfo[key] || '';
                                }
                            });

                            // Render pipettes
                            pipettes.forEach(pipette => {
                                renderPipette(pipette);
                                ['asFound', 'asLeft'].forEach(condition => {
                                    ['low', 'mid', 'high'].forEach(point => {
                                        validateMeasurement(pipette.id, condition, point);
                                    });
                                });
                                updateOverallStatus(pipette.id);
                            });

                            updateProgress();
                            updateAnalysis();
                            autoSave();
                            showAlert('Session imported successfully!', 'Success');
                        });
                    } catch (error) {
                        showAlert('Error importing file: ' + error.message, 'Error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ========== End LocalStorage Functions ==========

        function updateEmptyState() {
            const container = document.getElementById('pipettesContainer');
            if (pipettes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #dee2e6;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üìã</div>
                        <h3 style="color: #6c757d; margin-bottom: 10px;">No Pipettes Added Yet</h3>
                        <p style="color: #adb5bd; margin-bottom: 30px;">Click the "+ Add Pipette" button above to start your calibration</p>
                        <button class="btn btn-primary" onclick="addPipette()" style="font-size: 16px; padding: 12px 24px;">
                            ‚ûï Add Your First Pipette
                        </button>
                    </div>
                `;
            }
        }

        function showTab(tabName, clickedTab) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            if (clickedTab) {
                clickedTab.classList.add('active');
            }

            if (tabName === 'analysis') {
                updateAnalysis();
            }
        }

        function updateCalibrationTypeCounts() {
            // Get counts for each equipment type
            const platinumCount = pipettes.filter(p => p.serviceLevel === 'platinum').length;
            const basicCount = pipettes.filter(p => p.serviceLevel === 'basic').length;
            const balanceCount = balances.length;
            const timerCount = timers.length;
            const centrifugeCount = centrifuges.length;
            const tempCount = temperatureDevices.length;

            // Update dropdown options with counts
            const select = document.getElementById('calibrationType');
            if (select) {
                select.options[0].text = `üèÜ Platinum Pipette${platinumCount > 0 ? ` (${platinumCount})` : ''}`;
                select.options[1].text = `‚ö° Basic Pipette${basicCount > 0 ? ` (${basicCount})` : ''}`;
                select.options[2].text = `‚öñÔ∏è Balance${balanceCount > 0 ? ` (${balanceCount})` : ''}`;
                select.options[3].text = `‚è±Ô∏è Timer${timerCount > 0 ? ` (${timerCount})` : ''}`;
                select.options[4].text = `üåÄ Centrifuge${centrifugeCount > 0 ? ` (${centrifugeCount})` : ''}`;
                select.options[5].text = `üå°Ô∏è Temperature Device${tempCount > 0 ? ` (${tempCount})` : ''}`;
            }
        }

        function switchCalibrationType(type) {
            // Hide all calibration sections
            const sections = document.querySelectorAll('.calibration-section');
            sections.forEach(section => section.style.display = 'none');

            // Show the selected section and update service level if pipette type
            if (type === 'platinum-pipette') {
                document.getElementById('pipetteSection').style.display = 'block';
                document.getElementById('pipetteSectionTitle').textContent = 'üèÜ Platinum Pipette Calibration';
                // Set service level to platinum
                const serviceLevelSelect = document.getElementById('serviceLevel');
                if (serviceLevelSelect && serviceLevelSelect.value !== 'platinum') {
                    serviceLevelSelect.value = 'platinum';
                    handleServiceLevelChange('platinum');
                }
            } else if (type === 'basic-pipette') {
                document.getElementById('pipetteSection').style.display = 'block';
                document.getElementById('pipetteSectionTitle').textContent = '‚ö° Basic Pipette Calibration';
                // Set service level to basic
                const serviceLevelSelect = document.getElementById('serviceLevel');
                if (serviceLevelSelect && serviceLevelSelect.value !== 'basic') {
                    serviceLevelSelect.value = 'basic';
                    handleServiceLevelChange('basic');
                }
            } else if (type === 'balance') {
                document.getElementById('balanceSection').style.display = 'block';
            } else if (type === 'timer') {
                document.getElementById('timerSection').style.display = 'block';
            } else if (type === 'centrifuge') {
                document.getElementById('centrifugeSection').style.display = 'block';
            } else if (type === 'temperature') {
                document.getElementById('temperatureSection').style.display = 'block';
            }
        }

        function addPipette() {
            saveStateForUndo('Add pipette');
            currentPipetteId++;

            const serviceLevel = document.getElementById('serviceLevel')?.value || 'platinum';

            const pipette = {
                id: currentPipetteId,
                serviceLevel: serviceLevel,  // Track which service level this pipette belongs to
                number: '',

                // Common fields
                serial: '',
                brand: 'Eppendorf',
                pipetteModel: '',
                volume: 100,
                model: 'P-100',
                comments: '',
                status: 'pending',

                // Platinum-specific fields
                testVolume: 100,
                channelType: 'single',
                channelCount: 1,
                measurements: {
                    asFound: { low: ['', '', '', ''], mid: ['', '', '', ''], high: ['', '', '', ''] },
                    asLeft: { low: ['', '', '', ''], mid: ['', '', '', ''], high: ['', '', '', ''] }
                },
                statusAsFound: 'pending',
                statusAsLeft: 'pending',

                // Basic-specific fields
                makeModel: '',  // Combined make/model for basic
                maxVolume: '',
                inSpec: false,
                outSpec: false,
                adjustments: {
                    SE: '',      // Seal
                    COR: '',     // Corrosion
                    G: '',       // Grease
                    SH: '',      // Shaft
                    FR: '',      // Friction Ring
                    O: '',       // O-Ring
                    OTHER: ''    // Other
                },
                finalVolumes: ['', '', '', ''],
                passFail: ''
            };

            pipettes.push(pipette);
            renderPipette(pipette);
            updateProgress();
            updateSummaryTable(); // Update summary table
            updateBulkActionsBar(); // Update bulk actions
            updateCopyButton(); // Show/hide copy button
            debouncedAutoSave();
        }

        function updateCopyButton() {
            const copyBtn = document.getElementById('copyPrevBtn');
            if (copyBtn) {
                copyBtn.style.display = pipettes.length > 0 ? 'inline-block' : 'none';
            }
        }

        // Generate measurement table HTML based on channel type
        function generateMeasurementTable(pipette, precision) {
            if (pipette.channelType === 'single') {
                return generateSingleChannelTable(pipette, precision);
            } else {
                return generateMultiChannelTable(pipette, precision);
            }
        }

        // Single channel table (4 readings per test point)
        function generateSingleChannelTable(pipette, precision) {
            return `
                <table class="measurement-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Test Point</th>
                            <th colspan="4">As Found</th>
                            <th rowspan="2">As Found<br>Pass/Fail</th>
                            <th colspan="4">As Left</th>
                            <th rowspan="2">As Left<br>Pass/Fail</th>
                        </tr>
                        <tr>
                            <th>Reading 1</th>
                            <th>Reading 2</th>
                            <th>Reading 3</th>
                            <th>Reading 4</th>
                            <th>Reading 1</th>
                            <th>Reading 2</th>
                            <th>Reading 3</th>
                            <th>Reading 4</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Low (${formatVolume(getNominalVolume('low', pipette.model))} ŒºL)</strong></td>
                            ${[0,1,2,3].map(i => `<td><input type="number" step="${precision.step}" min="0" max="10000" class="measurement-input" oninput="validateMeasurementInput(this)" onchange="updateMeasurement(${pipette.id}, 'asFound', 'low', ${i}, this.value)" value="${pipette.measurements.asFound.low[i] || ''}" placeholder="${precision.decimals === 2 ? '0.00' : '0.0'}"></td>`).join('')}
                            <td><span id="status-asFound-low-${pipette.id}" class="status-badge status-pending">PENDING</span></td>
                            ${[0,1,2,3].map(i => `<td><input type="number" step="${precision.step}" min="0" max="10000" class="measurement-input" oninput="validateMeasurementInput(this)" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'low', ${i}, this.value)" value="${pipette.measurements.asLeft.low[i] || ''}" placeholder="${precision.decimals === 2 ? '0.00' : '0.0'}"></td>`).join('')}
                            <td><span id="status-asLeft-low-${pipette.id}" class="status-badge status-pending">PENDING</span></td>
                        </tr>
                        <tr>
                            <td><strong>Mid (${formatVolume(getNominalVolume('mid', pipette.model))} ŒºL)</strong></td>
                            ${[0,1,2,3].map(i => `<td><input type="number" step="${precision.step}" min="0" max="10000" class="measurement-input" oninput="validateMeasurementInput(this)" onchange="updateMeasurement(${pipette.id}, 'asFound', 'mid', ${i}, this.value)" value="${pipette.measurements.asFound.mid[i] || ''}" placeholder="${precision.decimals === 2 ? '0.00' : '0.0'}"></td>`).join('')}
                            <td><span id="status-asFound-mid-${pipette.id}" class="status-badge status-pending">PENDING</span></td>
                            ${[0,1,2,3].map(i => `<td><input type="number" step="${precision.step}" min="0" max="10000" class="measurement-input" oninput="validateMeasurementInput(this)" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'mid', ${i}, this.value)" value="${pipette.measurements.asLeft.mid[i] || ''}" placeholder="${precision.decimals === 2 ? '0.00' : '0.0'}"></td>`).join('')}
                            <td><span id="status-asLeft-mid-${pipette.id}" class="status-badge status-pending">PENDING</span></td>
                        </tr>
                        <tr>
                            <td><strong>High (${formatVolume(getNominalVolume('high', pipette.model))} ŒºL)</strong></td>
                            ${[0,1,2,3].map(i => `<td><input type="number" step="${precision.step}" min="0" max="10000" class="measurement-input" oninput="validateMeasurementInput(this)" onchange="updateMeasurement(${pipette.id}, 'asFound', 'high', ${i}, this.value)" value="${pipette.measurements.asFound.high[i] || ''}" placeholder="${precision.decimals === 2 ? '0.00' : '0.0'}"></td>`).join('')}
                            <td><span id="status-asFound-high-${pipette.id}" class="status-badge status-pending">PENDING</span></td>
                            ${[0,1,2,3].map(i => `<td><input type="number" step="${precision.step}" min="0" max="10000" class="measurement-input" oninput="validateMeasurementInput(this)" onchange="updateMeasurement(${pipette.id}, 'asLeft', 'high', ${i}, this.value)" value="${pipette.measurements.asLeft.high[i] || ''}" placeholder="${precision.decimals === 2 ? '0.00' : '0.0'}"></td>`).join('')}
                            <td><span id="status-asLeft-high-${pipette.id}" class="status-badge status-pending">PENDING</span></td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        // Multi-channel table (one reading per channel per test point)
        function generateMultiChannelTable(pipette, precision) {
            const channelCount = pipette.channelCount;
            const testPoints = [
                { name: 'Low', key: 'low', volume: getNominalVolume('low', pipette.model) },
                { name: 'Mid', key: 'mid', volume: getNominalVolume('mid', pipette.model) },
                { name: 'High', key: 'high', volume: getNominalVolume('high', pipette.model) }
            ];

            // Generate rows for each channel
            let rows = '';
            for (let ch = 0; ch < channelCount; ch++) {
                rows += `
                    <tr>
                        <td><strong>Channel ${ch + 1}</strong></td>
                        ${testPoints.map(point => {
                            const pointPrecision = getVolumePrecision(point.volume);
                            return `
                            <td><input type="number" step="${pointPrecision.step}" min="0" max="10000" class="measurement-input"
                                oninput="validateMeasurementInput(this)"
                                onchange="updateMeasurement(${pipette.id}, 'asFound', '${point.key}', ${ch}, this.value)"
                                value="${pipette.measurements.asFound[point.key][ch] || ''}"
                                placeholder="${pointPrecision.decimals === 2 ? '0.00' : '0.0'}">
                            </td>
                        `}).join('')}
                        ${testPoints.map(point => {
                            const pointPrecision = getVolumePrecision(point.volume);
                            return `
                            <td><input type="number" step="${pointPrecision.step}" min="0" max="10000" class="measurement-input"
                                oninput="validateMeasurementInput(this)"
                                onchange="updateMeasurement(${pipette.id}, 'asLeft', '${point.key}', ${ch}, this.value)"
                                value="${pipette.measurements.asLeft[point.key][ch] || ''}"
                                placeholder="${pointPrecision.decimals === 2 ? '0.00' : '0.0'}">
                            </td>
                        `}).join('')}
                    </tr>
                `;
            }

            // Add status row at the bottom (one status per test point)
            rows += `
                <tr style="background: #f0f0f0; font-weight: bold;">
                    <td>Status</td>
                    <td colspan="3" style="text-align: center;">
                        <span id="status-asFound-low-${pipette.id}" class="status-badge status-pending">LOW</span>
                        <span id="status-asFound-mid-${pipette.id}" class="status-badge status-pending">MID</span>
                        <span id="status-asFound-high-${pipette.id}" class="status-badge status-pending">HIGH</span>
                    </td>
                    <td colspan="3" style="text-align: center;">
                        <span id="status-asLeft-low-${pipette.id}" class="status-badge status-pending">LOW</span>
                        <span id="status-asLeft-mid-${pipette.id}" class="status-badge status-pending">MID</span>
                        <span id="status-asLeft-high-${pipette.id}" class="status-badge status-pending">HIGH</span>
                    </td>
                </tr>
            `;

            return `
                <table class="measurement-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Channel</th>
                            <th colspan="3">As Found</th>
                            <th colspan="3">As Left</th>
                        </tr>
                        <tr>
                            <th>Low (${formatVolume(testPoints[0].volume)} ŒºL)</th>
                            <th>Mid (${formatVolume(testPoints[1].volume)} ŒºL)</th>
                            <th>High (${formatVolume(testPoints[2].volume)} ŒºL)</th>
                            <th>Low (${formatVolume(testPoints[0].volume)} ŒºL)</th>
                            <th>Mid (${formatVolume(testPoints[1].volume)} ŒºL)</th>
                            <th>High (${formatVolume(testPoints[2].volume)} ŒºL)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        function renderPipette(pipette) {
            // Route to appropriate render function based on service level
            if (pipette.serviceLevel === 'basic') {
                renderBasicPipette(pipette);
            } else {
                renderPlatinumPipette(pipette);
            }
        }

        function renderPlatinumPipette(pipette) {
            const container = document.getElementById('pipettesContainer');
            const pipetteDiv = document.createElement('div');
            pipetteDiv.className = 'pipette-card';
            pipetteDiv.id = `pipette-${pipette.id}`;

            const volumeRanges = getVolumeRanges(pipette.model);
            const precision = getVolumePrecision(pipette.testVolume);

            const statusEmoji = pipette.statusAsLeft === 'pass' ? '‚úÖ' : pipette.statusAsLeft === 'fail' ? '‚ùå' : '‚è≥';

            pipetteDiv.innerHTML = `
                <div class="pipette-header" style="background: #69B135; color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h3 style="margin: 0; font-size: 18px;">Pipette #${String(pipette.id).padStart(2, '0')}</h3>
                        <span class="status-badge status-${pipette.statusAsLeft}" id="status-${pipette.id}" style="padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                            ${statusEmoji} ${pipette.statusAsLeft.toUpperCase()}
                        </span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="addPipette()" style="background: #69B135; color: white; padding: 8px 16px;" title="Add another pipette">
                            ‚ûï Add Another
                        </button>
                        <button class="btn btn-danger" onclick="removePipette(${pipette.id})" style="background: rgba(220,53,69,0.9); padding: 8px 16px;">
                            üóëÔ∏è Remove
                        </button>
                    </div>
                </div>

                <div style="padding: 20px;">
                    <!-- Pipette Information -->
                    <h4 style="color: #69B135; margin: 0 0 15px 0;">üß™ Pipette Information</h4>
                    <div class="form-grid">
                    <div class="form-group">
                        <label>Pipette Number</label>
                        <input type="text" value="${pipette.number}" onchange="updatePipetteInfo(${pipette.id}, 'number', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Brand</label>
                        <input type="text" value="${pipette.brand}" onchange="updatePipetteInfo(${pipette.id}, 'brand', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Channel Type</label>
                        <select onchange="updateChannelType(${pipette.id}, this.value)">
                            <option value="single" ${pipette.channelType === 'single' ? 'selected' : ''}>Single Channel</option>
                            <option value="multi-8ch" ${pipette.channelType === 'multi-8ch' ? 'selected' : ''}>Multi-Channel (8ch)</option>
                            <option value="multi-12ch" ${pipette.channelType === 'multi-12ch' ? 'selected' : ''}>Multi-Channel (12ch)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Model</label>
                        <input type="text" value="${pipette.pipetteModel || ''}" onchange="updatePipetteInfo(${pipette.id}, 'pipetteModel', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Serial Number</label>
                        <input type="text" value="${pipette.serial}" onchange="updatePipetteInfo(${pipette.id}, 'serial', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Volume</label>
                        <select onchange="updatePipetteModel(${pipette.id}, this.value)">
                            <option value="P-2" ${pipette.model === 'P-2' ? 'selected' : ''}>P-2 (0.2-2 ŒºL)</option>
                            <option value="P-2.5" ${pipette.model === 'P-2.5' ? 'selected' : ''}>P-2.5 (0.5-2.5 ŒºL)</option>
                            <option value="P-10" ${pipette.model === 'P-10' ? 'selected' : ''}>P-10 (1-10 ŒºL)</option>
                            <option value="P-20" ${pipette.model === 'P-20' ? 'selected' : ''}>P-20 (2-20 ŒºL)</option>
                            <option value="P-25" ${pipette.model === 'P-25' ? 'selected' : ''}>P-25 (5-25 ŒºL)</option>
                            <option value="P-50" ${pipette.model === 'P-50' ? 'selected' : ''}>P-50 (10-50 ŒºL)</option>
                            <option value="P-100" ${pipette.model === 'P-100' ? 'selected' : ''}>P-100 (10-100 ŒºL)</option>
                            <option value="P-200" ${pipette.model === 'P-200' ? 'selected' : ''}>P-200 (20-200 ŒºL)</option>
                            <option value="P-250" ${pipette.model === 'P-250' ? 'selected' : ''}>P-250 (25-250 ŒºL)</option>
                            <option value="P-300" ${pipette.model === 'P-300' ? 'selected' : ''}>P-300 (30-300 ŒºL)</option>
                            <option value="P-500" ${pipette.model === 'P-500' ? 'selected' : ''}>P-500 (100-500 ŒºL)</option>
                            <option value="P-1000" ${pipette.model === 'P-1000' ? 'selected' : ''}>P-1000 (100-1000 ŒºL)</option>
                            <option value="P-1200" ${pipette.model === 'P-1200' ? 'selected' : ''}>P-1200 (250-1200 ŒºL)</option>
                            <option value="P-1250" ${pipette.model === 'P-1250' ? 'selected' : ''}>P-1250 (250-1250 ŒºL)</option>
                            <option value="P-2000" ${pipette.model === 'P-2000' ? 'selected' : ''}>P-2000 (500-2000 ŒºL)</option>
                            <option value="P-5000" ${pipette.model === 'P-5000' ? 'selected' : ''}>P-5000 (1000-5000 ŒºL)</option>
                            <option value="P-10000" ${pipette.model === 'P-10000' ? 'selected' : ''}>P-10000 (2000-10000 ŒºL)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Comments</label>
                        <textarea rows="2" onchange="updatePipetteInfo(${pipette.id}, 'comments', this.value)">${pipette.comments}</textarea>
                    </div>
                </div>

                    <!-- Gravimetric Measurements -->
                    <h4 style="color: #69B135; margin: 20px 0 15px 0;">‚öñÔ∏è Gravimetric Measurements</h4>
                    ${generateMeasurementTable(pipette, precision)}

                    <!-- Test Results -->
                    <h4 style="color: #69B135; margin: 20px 0 15px 0;">üìä Test Results</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <h5 style="margin: 0 0 10px 0; color: #2c5282;">As Found Results</h5>
                        <div id="calculations-asFound-${pipette.id}">
                            <!-- As Found calculations will appear here -->
                        </div>
                    </div>
                        <div>
                            <h5 style="margin: 0 0 10px 0; color: #2c5282;">As Left Results</h5>
                            <div id="calculations-asLeft-${pipette.id}">
                                <!-- As Left calculations will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(pipetteDiv);
        }

        function getVolumeRanges(model) {
            const ranges = {
                'P-2': [0.2, 0.5, 1, 2],
                'P-2.5': [0.5, 1.25, 2.5],
                'P-10': [1, 2, 5, 10],
                'P-20': [2, 5, 10, 20],
                'P-25': [5, 12.5, 25],
                'P-50': [10, 25, 50],
                'P-100': [10, 20, 50, 100],
                'P-200': [20, 50, 100, 200],
                'P-250': [25, 50, 125, 150, 250],
                'P-300': [30, 50, 200, 300],
                'P-500': [100, 250, 500],
                'P-1000': [100, 200, 500, 1000],
                'P-1200': [250, 600, 1200],
                'P-1250': [250, 625, 1250],
                'P-2000': [500, 1000, 2000],
                'P-5000': [1000, 2500, 5000],
                'P-10000': [2000, 5000, 10000]
            };
            return ranges[model] || [100];
        }

        function updatePipetteModel(pipetteId, newModel) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                pipette.model = newModel;
                const ranges = getVolumeRanges(newModel);
                pipette.volume = ranges[ranges.length - 1];
                pipette.testVolume = pipette.volume;

                document.getElementById(`pipette-${pipetteId}`).remove();
                renderPipette(pipette);
            }
        }

        function updateChannelType(pipetteId, newChannelType) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                pipette.channelType = newChannelType;

                // Update channel count based on type
                if (newChannelType === 'single') {
                    pipette.channelCount = 1;
                    // Reset to 4-reading format for single channel
                    pipette.measurements = {
                        asFound: { low: ['', '', '', ''], mid: ['', '', '', ''], high: ['', '', '', ''] },
                        asLeft: { low: ['', '', '', ''], mid: ['', '', '', ''], high: ['', '', '', ''] }
                    };
                } else if (newChannelType === 'multi-8ch') {
                    pipette.channelCount = 8;
                    // Create 8-channel format (one reading per channel per test point)
                    pipette.measurements = {
                        asFound: { low: ['', '', '', '', '', '', '', ''], mid: ['', '', '', '', '', '', '', ''], high: ['', '', '', '', '', '', '', ''] },
                        asLeft: { low: ['', '', '', '', '', '', '', ''], mid: ['', '', '', '', '', '', '', ''], high: ['', '', '', '', '', '', '', ''] }
                    };
                } else if (newChannelType === 'multi-12ch') {
                    pipette.channelCount = 12;
                    // Create 12-channel format (one reading per channel per test point)
                    pipette.measurements = {
                        asFound: { low: ['', '', '', '', '', '', '', '', '', '', '', ''], mid: ['', '', '', '', '', '', '', '', '', '', '', ''], high: ['', '', '', '', '', '', '', '', '', '', '', ''] },
                        asLeft: { low: ['', '', '', '', '', '', '', '', '', '', '', ''], mid: ['', '', '', '', '', '', '', '', '', '', '', ''], high: ['', '', '', '', '', '', '', '', '', '', '', ''] }
                    };
                }

                // Re-render the pipette card with new layout
                document.getElementById(`pipette-${pipetteId}`).remove();
                renderPipette(pipette);
                debouncedAutoSave();
            }
        }

        // ========================================
        // BASIC SERVICE RENDERING
        // ========================================

        function renderBasicPipette(pipette) {
            const container = document.getElementById('pipettesContainer');
            const pipetteDiv = document.createElement('div');
            pipetteDiv.className = 'pipette-card';
            pipetteDiv.id = `pipette-${pipette.id}`;
            pipetteDiv.setAttribute('data-pipette-id', pipette.id);

            const statusClass = pipette.passFail === 'PASS' ? 'pass' : pipette.passFail === 'FAIL' ? 'fail' : 'pending';
            const statusEmoji = pipette.passFail === 'PASS' ? '‚úÖ' : pipette.passFail === 'FAIL' ? '‚ùå' : '‚è≥';

            pipetteDiv.innerHTML = `
                <div class="pipette-header" style="background: #5a9a2d; color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label style="margin: 0; display: flex; align-items: center;">
                            <input type="checkbox" class="pipette-checkbox" data-pipette-id="${pipette.id}"
                                   onchange="togglePipetteSelect(${pipette.id}, this.checked)"
                                   style="width: 20px; height: 20px; cursor: pointer; margin-right: 10px;">
                        </label>
                        <h3 style="margin: 0; font-size: 18px;">Pipette #${String(pipette.id).padStart(2, '0')}</h3>
                        <span class="status-badge status-${statusClass}" style="padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                            ${statusEmoji} ${pipette.passFail || 'PENDING'}
                        </span>
                    </div>
                    <button class="btn btn-danger" onclick="removePipette(${pipette.id})" style="background: rgba(220,53,69,0.9); padding: 8px 16px;">
                        üóëÔ∏è Remove
                    </button>
                </div>

                <div style="padding: 20px;">
                    <!-- Pipette Info -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Pipette Number/ID</label>
                            <input type="text" value="${pipette.number || ''}"
                                   onchange="updateBasicPipetteInfo(${pipette.id}, 'number', this.value)"
                                   placeholder="e.g., EQ-001">
                        </div>
                        <div class="form-group">
                            <label>Serial Number</label>
                            <input type="text" id="serial-${pipette.id}" value="${pipette.serial || ''}"
                                   onchange="updateBasicPipetteInfo(${pipette.id}, 'serial', this.value)"
                                   placeholder="Scan or enter serial">
                        </div>
                        <div class="form-group">
                            <label>Make/Model</label>
                            <select id="makeModel-${pipette.id}" onchange="updateBasicPipetteInfo(${pipette.id}, 'makeModel', this.value)">
                                <option value="">Select...</option>
                                <option value="Eppendorf Research Plus" ${pipette.makeModel === 'Eppendorf Research Plus' ? 'selected' : ''}>Eppendorf Research Plus</option>
                                <option value="Eppendorf Reference 2" ${pipette.makeModel === 'Eppendorf Reference 2' ? 'selected' : ''}>Eppendorf Reference 2</option>
                                <option value="Gilson Pipetman P" ${pipette.makeModel === 'Gilson Pipetman P' ? 'selected' : ''}>Gilson Pipetman P</option>
                                <option value="Rainin Pipet-Lite" ${pipette.makeModel === 'Rainin Pipet-Lite' ? 'selected' : ''}>Rainin Pipet-Lite</option>
                                <option value="Thermo Finnpipette" ${pipette.makeModel === 'Thermo Finnpipette' ? 'selected' : ''}>Thermo Finnpipette</option>
                                <option value="Other" ${pipette.makeModel === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Max Volume</label>
                            <input type="text" id="maxVolume-${pipette.id}" value="${pipette.maxVolume || ''}"
                                   onchange="updateBasicPipetteInfo(${pipette.id}, 'maxVolume', this.value)"
                                   placeholder="e.g., 1000 ŒºL">
                        </div>
                    </div>

                    <!-- In Spec / Out of Spec -->
                    <div style="display: flex; gap: 20px; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" ${pipette.inSpec ? 'checked' : ''}
                                   onchange="updateBasicPipetteInfo(${pipette.id}, 'inSpec', this.checked)"
                                   style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600; color: #28a745;">‚úì In Spec</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" ${pipette.outSpec ? 'checked' : ''}
                                   onchange="updateBasicPipetteInfo(${pipette.id}, 'outSpec', this.checked)"
                                   style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600; color: #dc3545;">‚úó Out of Spec</span>
                        </label>
                    </div>

                    <!-- Adjustments -->
                    <h4 style="color: #69B135; margin: 20px 0 10px 0;">üîß Adjustments Made</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>SE (Seal)</label>
                            <select onchange="updateAdjustment(${pipette.id}, 'SE', this.value)">
                                <option value="">None</option>
                                <option value="X" ${pipette.adjustments?.SE === 'X' ? 'selected' : ''}>X (Replaced)</option>
                                <option value="*" ${pipette.adjustments?.SE === '*' ? 'selected' : ''}>* (Inspected)</option>
                                <option value="Silicone" ${pipette.adjustments?.SE === 'Silicone' ? 'selected' : ''}>Silicone</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>COR (Corrosion)</label>
                            <select onchange="updateAdjustment(${pipette.id}, 'COR', this.value)">
                                <option value="">None</option>
                                <option value="Cleaned" ${pipette.adjustments?.COR === 'Cleaned' ? 'selected' : ''}>Cleaned</option>
                                <option value="Minor" ${pipette.adjustments?.COR === 'Minor' ? 'selected' : ''}>Minor</option>
                                <option value="Severe" ${pipette.adjustments?.COR === 'Severe' ? 'selected' : ''}>Severe</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>G (Grease)</label>
                            <select onchange="updateAdjustment(${pipette.id}, 'G', this.value)">
                                <option value="">None</option>
                                <option value="D" ${pipette.adjustments?.G === 'D' ? 'selected' : ''}>D (Type D)</option>
                                <option value="K" ${pipette.adjustments?.G === 'K' ? 'selected' : ''}>K (Type K)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>SH (Shaft)</label>
                            <select onchange="updateAdjustment(${pipette.id}, 'SH', this.value)">
                                <option value="">None</option>
                                <option value="X" ${pipette.adjustments?.SH === 'X' ? 'selected' : ''}>X (Replaced)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>FR (Friction Ring)</label>
                            <input type="text" value="${pipette.adjustments?.FR || ''}"
                                   onchange="updateAdjustment(${pipette.id}, 'FR', this.value)"
                                   placeholder="Details">
                        </div>
                        <div class="form-group">
                            <label>O (O-Ring)</label>
                            <select onchange="updateAdjustment(${pipette.id}, 'O', this.value)">
                                <option value="">None</option>
                                <option value="X" ${pipette.adjustments?.O === 'X' ? 'selected' : ''}>X (Replaced)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Other Adjustments -->
                    <div class="form-group" style="margin-top: 15px;">
                        <label>OTHER (Additional Notes)</label>
                        <input type="text" value="${pipette.adjustments?.OTHER || ''}"
                               onchange="updateAdjustment(${pipette.id}, 'OTHER', this.value)"
                               placeholder="Any other adjustments or notes">
                    </div>

                    <!-- Final Volumes -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0;">
                        <h4 style="color: #69B135; margin: 0;">üìè Final Volumes (ŒºL)</h4>
                        <div style="display: flex; align-items: center;">
                            <button class="voice-button" id="voice-btn-${pipette.id}" onclick="toggleVoiceInput(${pipette.id})" title="Start voice input for readings">
                                üé§ Voice Input
                            </button>
                            <span class="voice-status" id="voice-status-${pipette.id}"></span>
                        </div>
                    </div>
                    <div class="volume-inputs" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                        ${[0, 1, 2, 3].map(i => `
                            <div class="form-group">
                                <label>Volume ${i + 1}</label>
                                <input type="number" step="0.001" id="vol${i + 1}-${pipette.id}" value="${pipette.finalVolumes?.[i] || ''}"
                                       onchange="updateFinalVolume(${pipette.id}, ${i}, this.value)"
                                       placeholder="0.000">
                            </div>
                        `).join('')}
                    </div>

                    <!-- Pass/Fail & Comments -->
                    <div class="form-grid" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>Pass/Fail</label>
                            <select id="pf-${pipette.id}" onchange="updateBasicPipetteInfo(${pipette.id}, 'passFail', this.value); updateBasicStatus(${pipette.id})">
                                <option value="">Pending...</option>
                                <option value="PASS" ${pipette.passFail === 'PASS' ? 'selected' : ''}>‚úÖ PASS</option>
                                <option value="FAIL" ${pipette.passFail === 'FAIL' ? 'selected' : ''}>‚ùå FAIL</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Comments</label>
                            <input type="text" value="${pipette.comments || ''}"
                                   onchange="updateBasicPipetteInfo(${pipette.id}, 'comments', this.value)"
                                   placeholder="Additional notes">
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(pipetteDiv);
            updateEmptyState();
        }

        function updateBasicPipetteInfo(pipetteId, field, value) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                pipette[field] = value;
                debouncedAutoSave();
            }
        }

        function updateAdjustment(pipetteId, field, value) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                if (!pipette.adjustments) {
                    pipette.adjustments = {};
                }
                pipette.adjustments[field] = value;
                debouncedAutoSave();
            }
        }

        function updateFinalVolume(pipetteId, index, value) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                if (!pipette.finalVolumes) {
                    pipette.finalVolumes = ['', '', '', ''];
                }
                pipette.finalVolumes[index] = value;
                debouncedAutoSave();
            }
        }

        function updateBasicStatus(pipetteId) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                pipette.status = pipette.passFail === 'PASS' ? 'pass' : pipette.passFail === 'FAIL' ? 'fail' : 'pending';

                // Re-render to update badge
                document.getElementById(`pipette-${pipetteId}`).remove();
                renderPipette(pipette);
                updateProgress();
                updateSummaryTable(); // Update summary table
                debouncedAutoSave();
            }
        }

        // ========================================
        // SEARCH AND FILTER FUNCTIONS
        // ========================================

        function filterPipettes() {
            const searchTerm = document.getElementById('searchPipettes')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            const serviceLevelFilter = document.getElementById('filterServiceLevel')?.value || '';

            const pipetteCards = document.querySelectorAll('.pipette-card');

            pipetteCards.forEach(card => {
                const pipetteId = parseInt(card.getAttribute('data-pipette-id'));
                const pipette = pipettes.find(p => p.id === pipetteId);

                if (!pipette) {
                    card.style.display = 'none';
                    return;
                }

                // Search filter
                const searchableText = `
                    ${pipette.id}
                    ${pipette.number || ''}
                    ${pipette.serial || ''}
                    ${pipette.brand || ''}
                    ${pipette.model || ''}
                    ${pipette.pipetteModel || ''}
                    ${pipette.makeModel || ''}
                `.toLowerCase();

                const matchesSearch = !searchTerm || searchableText.includes(searchTerm);

                // Status filter
                const matchesStatus = !statusFilter || pipette.status === statusFilter || pipette.passFail === statusFilter.toUpperCase();

                // Service level filter
                const matchesServiceLevel = !serviceLevelFilter || pipette.serviceLevel === serviceLevelFilter;

                // Show/hide based on all filters
                if (matchesSearch && matchesStatus && matchesServiceLevel) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function clearFilters() {
            document.getElementById('searchPipettes').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterServiceLevel').value = '';
            filterPipettes();
        }

        // ========================================
        // BULK ACTIONS FUNCTIONS
        // ========================================

        function togglePipetteSelect(pipetteId, checked) {
            updateBulkActionsBar();
        }

        function updateBulkActionsBar() {
            const checkboxes = document.querySelectorAll('.pipette-checkbox');
            const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
            const bulkBar = document.getElementById('bulkActionsBar');
            const selectedCount = document.getElementById('selectedCount');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');

            // Only show bulk actions bar if we have Basic mode pipettes
            const basicPipettes = pipettes.filter(p => p.serviceLevel === 'basic');
            if (basicPipettes.length > 0) {
                bulkBar.style.display = 'block';
            } else {
                bulkBar.style.display = 'none';
                return;
            }

            // Update count
            if (selectedCount) {
                selectedCount.textContent = `${checkedBoxes.length} selected`;
            }

            // Update select all checkbox state
            if (selectAllCheckbox) {
                if (checkedBoxes.length === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (checkedBoxes.length === checkboxes.length) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox')?.checked || false;
            const checkboxes = document.querySelectorAll('.pipette-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectAll;
            });
            updateBulkActionsBar();
        }

        function bulkMarkStatus(status) {
            const checkboxes = document.querySelectorAll('.pipette-checkbox:checked');
            if (checkboxes.length === 0) {
                showAlert('Please select at least one pipette.', 'No Selection');
                return;
            }

            saveStateForUndo(`Bulk mark ${status}`);

            const selectedIds = [];
            checkboxes.forEach(checkbox => {
                const pipetteId = parseInt(checkbox.getAttribute('data-pipette-id'));
                selectedIds.push(pipetteId);
                const pipette = pipettes.find(p => p.id === pipetteId);
                if (pipette && pipette.serviceLevel === 'basic') {
                    pipette.passFail = status;
                    pipette.status = status.toLowerCase();
                }
            });

            // Uncheck all checkboxes
            checkboxes.forEach(cb => cb.checked = false);
            updateBulkActionsBar();

            // Re-render affected pipettes
            selectedIds.forEach(id => {
                const element = document.getElementById(`pipette-${id}`);
                if (element) {
                    element.remove();
                    const pipette = pipettes.find(p => p.id === id);
                    if (pipette) {
                        renderPipette(pipette);
                    }
                }
            });

            updateProgress();
            updateSummaryTable();
            debouncedAutoSave();

            showAlert(`${checkboxes.length} pipette(s) marked as ${status}`, 'Bulk Action Complete');
        }

        function bulkDeleteSelected() {
            const checkboxes = document.querySelectorAll('.pipette-checkbox:checked');
            if (checkboxes.length === 0) {
                showToast('Please select at least one pipette', 'warning');
                return;
            }

            showConfirm(`Delete ${checkboxes.length} selected pipette(s)? This cannot be undone.`, 'Confirm Bulk Delete', () => {
                checkboxes.forEach(checkbox => {
                    const pipetteId = parseInt(checkbox.getAttribute('data-pipette-id'));
                    pipettes = pipettes.filter(p => p.id !== pipetteId);
                    const element = document.getElementById(`pipette-${pipetteId}`);
                    if (element) element.remove();
                });

                updateEmptyState();
                updateProgress();
                updateAnalysis();
                updateSummaryTable();
                updateBulkActionsBar();
                updateCopyButton();
                debouncedAutoSave();
                showToast(`${checkboxes.length} pipette(s) deleted successfully`, 'success');
            });
        }

        function deleteAllBalances() {
            if (balances.length === 0) return;

            showConfirm(`Delete all ${balances.length} balance(s)? This cannot be undone.`, 'Confirm Delete All', () => {
                const count = balances.length;
                balances = [];
                renderBalances();
                updateManifest();
                debouncedAutoSave();
                showToast(`${count} balance(s) deleted successfully`, 'success');
                updateDeleteAllButtons();
            });
        }

        function deleteAllTimers() {
            if (timers.length === 0) return;

            showConfirm(`Delete all ${timers.length} timer(s)? This cannot be undone.`, 'Confirm Delete All', () => {
                const count = timers.length;
                timers = [];
                renderTimers();
                updateManifest();
                debouncedAutoSave();
                showToast(`${count} timer(s) deleted successfully`, 'success');
                updateDeleteAllButtons();
            });
        }

        function deleteAllCentrifuges() {
            if (centrifuges.length === 0) return;

            showConfirm(`Delete all ${centrifuges.length} centrifuge(s)? This cannot be undone.`, 'Confirm Delete All', () => {
                const count = centrifuges.length;
                centrifuges = [];
                renderCentrifuges();
                updateManifest();
                debouncedAutoSave();
                showToast(`${count} centrifuge(s) deleted successfully`, 'success');
                updateDeleteAllButtons();
            });
        }

        function deleteAllTemperatureDevices() {
            if (temperatureDevices.length === 0) return;

            showConfirm(`Delete all ${temperatureDevices.length} temperature device(s)? This cannot be undone.`, 'Confirm Delete All', () => {
                const count = temperatureDevices.length;
                temperatureDevices = [];
                renderTemperatureDevices();
                updateManifest();
                debouncedAutoSave();
                showToast(`${count} temperature device(s) deleted successfully`, 'success');
                updateDeleteAllButtons();
            });
        }

        function updateDeleteAllButtons() {
            // Show/hide delete all buttons based on equipment count
            const deleteAllBalancesBtn = document.getElementById('deleteAllBalancesBtn');
            const deleteAllTimersBtn = document.getElementById('deleteAllTimersBtn');
            const deleteAllCentrifugesBtn = document.getElementById('deleteAllCentrifugesBtn');
            const deleteAllTemperatureDevicesBtn = document.getElementById('deleteAllTemperatureDevicesBtn');

            if (deleteAllBalancesBtn) {
                deleteAllBalancesBtn.style.display = balances.length > 0 ? 'block' : 'none';
            }
            if (deleteAllTimersBtn) {
                deleteAllTimersBtn.style.display = timers.length > 0 ? 'block' : 'none';
            }
            if (deleteAllCentrifugesBtn) {
                deleteAllCentrifugesBtn.style.display = centrifuges.length > 0 ? 'block' : 'none';
            }
            if (deleteAllTemperatureDevicesBtn) {
                deleteAllTemperatureDevicesBtn.style.display = temperatureDevices.length > 0 ? 'block' : 'none';
            }
        }

        // ========================================
        // COPY FROM PREVIOUS FUNCTION
        // ========================================

        function copyFromPrevious() {
            if (pipettes.length === 0) {
                showAlert('No pipettes to copy from. Add your first pipette first.', 'No Pipettes');
                return;
            }

            saveStateForUndo('Copy from previous');
            const lastPipette = pipettes[pipettes.length - 1];
            currentPipetteId++;

            const newPipette = {
                id: currentPipetteId,
                serviceLevel: lastPipette.serviceLevel,
                number: '',
                serial: '', // Clear serial - should be unique

                // Common fields - copy from previous
                brand: lastPipette.brand,
                pipetteModel: lastPipette.pipetteModel,
                volume: lastPipette.volume,
                model: lastPipette.model,
                comments: '',
                status: 'pending',

                // Platinum fields
                testVolume: lastPipette.testVolume,
                channelType: lastPipette.channelType,
                channelCount: lastPipette.channelCount,
                measurements: {
                    asFound: { low: ['', '', '', ''], mid: ['', '', '', ''], high: ['', '', '', ''] },
                    asLeft: { low: ['', '', '', ''], mid: ['', '', '', ''], high: ['', '', '', ''] }
                },
                statusAsFound: 'pending',
                statusAsLeft: 'pending',

                // Basic fields - copy some, clear others
                makeModel: lastPipette.makeModel,
                maxVolume: lastPipette.maxVolume,
                inSpec: false,
                outSpec: false,
                adjustments: {
                    SE: lastPipette.adjustments?.SE || '',
                    COR: lastPipette.adjustments?.COR || '',
                    G: lastPipette.adjustments?.G || '',
                    SH: lastPipette.adjustments?.SH || '',
                    FR: lastPipette.adjustments?.FR || '',
                    O: lastPipette.adjustments?.O || '',
                    OTHER: lastPipette.adjustments?.OTHER || ''
                },
                finalVolumes: ['', '', '', ''],
                passFail: ''
            };

            // Handle multi-channel measurements
            if (lastPipette.channelType === 'multi' && lastPipette.channelCount) {
                const emptyArray = Array(lastPipette.channelCount).fill('');
                newPipette.measurements = {
                    asFound: { low: [...emptyArray], mid: [...emptyArray], high: [...emptyArray] },
                    asLeft: { low: [...emptyArray], mid: [...emptyArray], high: [...emptyArray] }
                };
            }

            pipettes.push(newPipette);
            renderPipette(newPipette);
            updateProgress();
            updateSummaryTable();
            updateBulkActionsBar();
            debouncedAutoSave();

            // Scroll to new pipette
            setTimeout(() => {
                const newCard = document.querySelector(`[data-pipette-id="${newPipette.id}"]`);
                if (newCard) {
                    newCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 100);

            showAlert('Pipette copied! Serial number and measurements have been cleared.', 'Copy Successful');
        }

        function updatePipetteInfo(pipetteId, field, value) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                pipette[field] = value;
                if (field === 'volume') {
                    pipette.testVolume = value;
                    // Re-render to update test points when volume changes
                    document.getElementById(`pipette-${pipetteId}`).remove();
                    renderPipette(pipette);
                }
                debouncedAutoSave();
            }
        }

        function updateMeasurement(pipetteId, condition, point, reading, value) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (pipette) {
                if (!pipette.measurements[condition][point]) {
                    pipette.measurements[condition][point] = ['', '', '', ''];
                }
                pipette.measurements[condition][point][reading] = parseFloat(value) || '';

                validateMeasurement(pipetteId, condition, point);
                updateOverallStatus(pipetteId);
                updateProgress();
                debouncedAutoSave();
            }
        }

        function validateMeasurement(pipetteId, condition, point) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (!pipette) return;

            if (pipette.channelType === 'single') {
                validateSingleChannel(pipetteId, condition, point);
            } else {
                validateMultiChannel(pipetteId, condition, point);
            }
        }

        function validateSingleChannel(pipetteId, condition, point) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (!pipette) return;

            const measurements = pipette.measurements[condition][point];
            if (measurements.filter(m => m !== '').length < 4) return;

            const nominalVolume = getNominalVolume(point, pipette.model);
            const specs = getSpecifications(pipette.model, nominalVolume, false);

            if (!specs) return;

            // Get environmental conditions
            const env = getEnvironmentalConditions();

            // Apply environmental corrections if data available
            let correctedMeasurements = measurements;
            let zFactor = 1.0;
            let correctionApplied = false;

            if (env.hasAllData) {
                correctedMeasurements = measurements.map(rawValue => {
                    const result = applyEnvironmentalCorrection(rawValue, env.temperature, env.pressure, env.humidity);
                    zFactor = result.zFactor;
                    correctionApplied = result.correctionApplied;
                    return result.corrected;
                });
            }

            // Calculate statistics using CORRECTED values
            const mean = correctedMeasurements.reduce((a, b) => a + b, 0) / 4;
            const cv = calculateCV(correctedMeasurements);
            const sd = calculateSD(correctedMeasurements);

            // Check pass/fail using CORRECTED values
            const accuracyPass = correctedMeasurements.every(reading =>
                reading >= specs.accuracy.from && reading <= specs.accuracy.to
            );

            // ISO 8655: Precision passes if EITHER CV% OR SD meets limit
            const cvPass = cv <= specs.precision.percent;
            const sdPass = sd <= specs.precision.ul;
            const precisionPass = cvPass || sdPass;

            const overallPass = accuracyPass && precisionPass;

            // Update the appropriate status badge based on condition (asFound or asLeft)
            const statusElement = document.getElementById(`status-${condition}-${point}-${pipetteId}`);
            if (statusElement) {
                statusElement.className = `status-badge status-${overallPass ? 'pass' : 'fail'}`;
                statusElement.textContent = overallPass ? 'PASS' : 'FAIL';
            }

            measurements.forEach((_, index) => {
                const input = document.querySelector(`#pipette-${pipetteId} input[onchange*="${condition}"][onchange*="${point}"][onchange*="${index}"]`);
                if (input) {
                    input.className = `measurement-input ${overallPass ? 'pass' : 'fail'}`;
                }
            });

            updateCalculationsDisplay(pipetteId, condition, point, {
                nominal: nominalVolume,
                mean: mean,
                cv: cv,
                sd: sd,
                specs: specs,
                accuracyPass: accuracyPass,
                precisionPass: precisionPass,
                cvPass: cvPass,
                sdPass: sdPass,
                measurements: correctedMeasurements,
                rawMeasurements: measurements,
                zFactor: zFactor,
                correctionApplied: correctionApplied,
                environmental: env
            });
        }

        function validateMultiChannel(pipetteId, condition, point) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (!pipette) return;

            // For multi-channel, we validate each test point across ALL channels
            // Each test point has ONE measurement per channel (e.g., 8 readings for LOW)
            const testPoints = ['low', 'mid', 'high'];

            // Get environmental conditions once for this validation
            const env = getEnvironmentalConditions();

            // Validate each test point independently
            testPoints.forEach(testPoint => {
                // Collect all channel measurements for this test point
                const measurements = [];
                for (let ch = 0; ch < pipette.channelCount; ch++) {
                    const val = pipette.measurements[condition][testPoint][ch];
                    if (val !== '' && val !== null && val !== undefined) {
                        measurements.push(parseFloat(val));
                    }
                }

                // Need all channels to have data for this test point
                if (measurements.length < pipette.channelCount) return;

                // Get nominal volume and specs for this test point
                const nominalVolume = getNominalVolume(testPoint, pipette.model);
                const specs = getSpecifications(pipette.model, nominalVolume, true);

                if (!specs) return;

                // Apply environmental corrections if data available
                let correctedMeasurements = measurements;
                let zFactor = 1.0;
                let correctionApplied = false;

                if (env.hasAllData) {
                    correctedMeasurements = measurements.map(rawValue => {
                        const result = applyEnvironmentalCorrection(rawValue, env.temperature, env.pressure, env.humidity);
                        zFactor = result.zFactor;
                        correctionApplied = result.correctionApplied;
                        return result.corrected;
                    });
                }

                // Calculate statistics using CORRECTED values
                const mean = correctedMeasurements.reduce((a, b) => a + b, 0) / correctedMeasurements.length;
                const cv = calculateCV(correctedMeasurements);
                const sd = calculateSD(correctedMeasurements);

                // Check accuracy: all readings must be within range (using CORRECTED values)
                const accuracyPass = correctedMeasurements.every(reading =>
                    reading >= specs.accuracy.from && reading <= specs.accuracy.to
                );

                // ISO 8655: Precision passes if EITHER CV% OR SD meets limit
                const cvPass = cv <= specs.precision.percent;
                const sdPass = sd <= specs.precision.ul;
                const precisionPass = cvPass || sdPass;

                const overallPass = accuracyPass && precisionPass;

                // Update status badge for this test point
                const statusElement = document.getElementById(`status-${condition}-${testPoint}-${pipetteId}`);
                if (statusElement) {
                    statusElement.className = `status-badge status-${overallPass ? 'pass' : 'fail'}`;
                    statusElement.textContent = overallPass ? 'PASS' : 'FAIL';
                }

                // Update input styling for all channels in this test point
                for (let ch = 0; ch < pipette.channelCount; ch++) {
                    const input = document.querySelector(`#pipette-${pipetteId} input[onchange*="${condition}"][onchange*="${testPoint}"][onchange*="${ch}"]`);
                    if (input) {
                        input.className = `measurement-input ${overallPass ? 'pass' : 'fail'}`;
                    }
                }

                // Display calculation results with both raw and corrected values
                updateCalculationsDisplay(pipetteId, condition, testPoint, {
                    nominal: nominalVolume,
                    mean: mean,
                    cv: cv,
                    sd: sd,
                    specs: specs,
                    accuracyPass: accuracyPass,
                    precisionPass: precisionPass,
                    cvPass: cvPass,
                    sdPass: sdPass,
                    measurements: correctedMeasurements,
                    rawMeasurements: measurements,  // Keep raw values
                    zFactor: zFactor,                // Z-factor for display
                    correctionApplied: correctionApplied,  // Flag
                    environmental: env               // Environmental conditions
                });
            });
        }

        function getNominalVolume(point, model) {
            // Define actual test volumes for each pipette model
            const testVolumes = {
                'P-2': { low: 0.5, mid: 1, high: 2 },
                'P-2.5': { low: 0.5, mid: 1.25, high: 2.5 },
                'P-10': { low: 2, mid: 5, high: 10 },
                'P-20': { low: 5, mid: 10, high: 20 },
                'P-25': { low: 5, mid: 12.5, high: 25 },
                'P-50': { low: 10, mid: 25, high: 50 },
                'P-100': { low: 20, mid: 50, high: 100 },
                'P-200': { low: 50, mid: 100, high: 200 },
                'P-250': { low: 50, mid: 125, high: 250 },
                'P-300': { low: 50, mid: 200, high: 300 },
                'P-500': { low: 100, mid: 250, high: 500 },
                'P-1000': { low: 200, mid: 500, high: 1000 },
                'P-1200': { low: 250, mid: 600, high: 1200 },
                'P-1250': { low: 250, mid: 625, high: 1250 },
                'P-2000': { low: 500, mid: 1000, high: 2000 },
                'P-5000': { low: 1000, mid: 2500, high: 5000 },
                'P-10000': { low: 2000, mid: 5000, high: 10000 }
            };

            return testVolumes[model][point];
        }

        function getSpecifications(model, volume, isMultiChannel = false) {
            const specsDatabase = isMultiChannel ? isoSpecsMulti : isoSpecs;
            const modelSpecs = specsDatabase[model];
            if (!modelSpecs) return null;

            const volumes = Object.keys(modelSpecs).map(v => parseFloat(v));
            const closest = volumes.reduce((prev, curr) =>
                Math.abs(curr - volume) < Math.abs(prev - volume) ? curr : prev
            );

            return modelSpecs[closest];
        }

        function calculateCV(values) {
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            const stdDev = Math.sqrt(variance);
            return (stdDev / mean) * 100;
        }

        function calculateSD(values) {
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            const stdDev = Math.sqrt(variance);
            return stdDev;
        }

        // ========================================
        // ENVIRONMENTAL CORRECTIONS (ISO 8655-6)
        // ========================================

        // Calculate water density at given temperature (¬∞C)
        // Formula from ISO 8655-6:2002
        function calculateWaterDensity(tempC) {
            // Polynomial approximation for water density (kg/m¬≥)
            // Valid for 15-30¬∞C range
            const t = tempC;
            const density = 999.85308 + 6.32693e-2 * t - 8.523829e-3 * t * t
                          + 6.943248e-5 * t * t * t - 3.821216e-7 * t * t * t * t;
            return density;
        }

        // Calculate air density from temperature, pressure, and humidity
        // Simplified formula suitable for laboratory conditions
        function calculateAirDensity(tempC, pressureKPa, humidityPercent) {
            const T = tempC + 273.15; // Convert to Kelvin
            const P = pressureKPa * 1000; // Convert kPa to Pa
            const RH = humidityPercent / 100; // Convert to fraction

            // Saturation vapor pressure (Pa) - Magnus formula
            const Psat = 611.2 * Math.exp((17.67 * tempC) / (tempC + 243.5));

            // Partial pressure of water vapor
            const Pw = RH * Psat;

            // Partial pressure of dry air
            const Pd = P - Pw;

            // Air density (kg/m¬≥)
            // Using specific gas constants
            const Rd = 287.05; // Specific gas constant for dry air (J/kg¬∑K)
            const Rv = 461.495; // Specific gas constant for water vapor (J/kg¬∑K)

            const rho_air = (Pd / (Rd * T)) + (Pw / (Rv * T));

            return rho_air;
        }

        // Calculate Z-factor for air buoyancy correction
        function calculateZFactor(tempC, pressureKPa, humidityPercent) {
            const rho_air = calculateAirDensity(tempC, pressureKPa, humidityPercent);
            const rho_water = calculateWaterDensity(tempC);
            const rho_weights = 8000; // Standard stainless steel calibration weights (kg/m¬≥)

            // Z-factor formula per ISO 8655-6
            const Z = (1 - rho_air / rho_weights) / (1 - rho_air / rho_water);

            return Z;
        }

        // Apply environmental correction to raw gravimetric measurement
        function applyEnvironmentalCorrection(rawValueUL, tempC, pressureKPa, humidityPercent) {
            // If environmental data is missing, return raw value
            if (!tempC || !pressureKPa || !humidityPercent) {
                return {
                    corrected: rawValueUL,
                    zFactor: 1.0,
                    correctionApplied: false
                };
            }

            const zFactor = calculateZFactor(tempC, pressureKPa, humidityPercent);
            const correctedValue = rawValueUL * zFactor;

            return {
                corrected: correctedValue,
                zFactor: zFactor,
                correctionApplied: true
            };
        }

        // Get current environmental conditions from session
        function getEnvironmentalConditions() {
            const temp = parseFloat(document.getElementById('temperature')?.value);
            const pressure = parseFloat(document.getElementById('pressure')?.value);
            const humidity = parseFloat(document.getElementById('humidity')?.value);

            return {
                temperature: temp || null,
                pressure: pressure || null,
                humidity: humidity || null,
                hasAllData: !!(temp && pressure && humidity)
            };
        }

        // ========================================
        // ENVIRONMENTAL VALIDATION & WARNINGS
        // ========================================

        // ISO 8655-6 recommended ranges:
        const ENV_RANGES = {
            temperature: { min: 15, max: 30, optimal: { min: 20, max: 25 }, unit: '¬∞C' },
            pressure: { min: 95, max: 105, optimal: { min: 98, max: 102 }, unit: 'kPa' },
            humidity: { min: 30, max: 80, optimal: { min: 40, max: 60 }, unit: '% RH' }
        };

        function validateEnvironmentalParameter(value, paramName) {
            const range = ENV_RANGES[paramName];
            if (!value || isNaN(value)) {
                return { valid: false, warning: null };
            }

            if (value < range.min || value > range.max) {
                return {
                    valid: false,
                    warning: `${paramName.charAt(0).toUpperCase() + paramName.slice(1)} out of range! Acceptable: ${range.min}-${range.max} ${range.unit}`
                };
            }

            if (value < range.optimal.min || value > range.optimal.max) {
                return {
                    valid: true,
                    warning: `${paramName.charAt(0).toUpperCase() + paramName.slice(1)} outside optimal range (${range.optimal.min}-${range.optimal.max} ${range.unit})`
                };
            }

            return { valid: true, warning: null };
        }

        function validateTemperature(input) {
            const value = parseFloat(input.value);
            const result = validateEnvironmentalParameter(value, 'temperature');

            input.style.borderColor = result.valid ? '' : '#dc3545';
            showEnvironmentalWarning('temperature', result.warning);
            updateAllCalculations(); // Recalculate with new environmental conditions
        }

        function validatePressure(input) {
            const value = parseFloat(input.value);
            const result = validateEnvironmentalParameter(value, 'pressure');

            input.style.borderColor = result.valid ? '' : '#dc3545';
            showEnvironmentalWarning('pressure', result.warning);
            updateAllCalculations();
        }

        function validateHumidity(input) {
            const value = parseFloat(input.value);
            const result = validateEnvironmentalParameter(value, 'humidity');

            input.style.borderColor = result.valid ? '' : '#dc3545';
            showEnvironmentalWarning('humidity', result.warning);
            updateAllCalculations();
        }

        function showEnvironmentalWarning(paramName, warningText) {
            let warningDiv = document.getElementById(`warning-${paramName}`);

            if (!warningDiv) {
                const input = document.getElementById(paramName);
                if (!input) return;

                warningDiv = document.createElement('div');
                warningDiv.id = `warning-${paramName}`;
                warningDiv.style.cssText = 'color: #dc3545; font-size: 12px; margin-top: 3px;';
                input.parentElement.appendChild(warningDiv);
            }

            if (warningText) {
                warningDiv.textContent = `‚ö† ${warningText}`;
                warningDiv.style.color = warningText.includes('out of range') ? '#dc3545' : '#ff9800';
            } else {
                warningDiv.textContent = '';
            }
        }

        function updateAllCalculations() {
            // Recalculate all pipette validations when environmental conditions change
            pipettes.forEach(pipette => {
                if (pipette.channelType === 'single') {
                    ['low', 'mid', 'high'].forEach(point => {
                        validateSingleChannel(pipette.id, 'asFound', point);
                        validateSingleChannel(pipette.id, 'asLeft', point);
                    });
                } else {
                    validateMultiChannel(pipette.id, 'asFound', null);
                    validateMultiChannel(pipette.id, 'asLeft', null);
                }
            });
        }

        function updateCalculationsDisplay(pipetteId, condition, point, data) {
            const container = document.getElementById(`calculations-${condition}-${pipetteId}`);
            if (!container) return;

            let calculationsDiv = container.querySelector(`.calculations-${point}`);

            if (!calculationsDiv) {
                calculationsDiv = document.createElement('div');
                calculationsDiv.className = `calculations-${point}`;
                calculationsDiv.style.cssText = 'background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px; font-size: 12px;';
                container.appendChild(calculationsDiv);
            }

            const precision = getVolumePrecision(data.nominal);
            const readings = data.measurements.map(val => formatVolume(val)).join(', ');

            // Build environmental correction info if applicable
            let environmentalInfo = '';
            if (data.correctionApplied && data.environmental) {
                const rawReadings = data.rawMeasurements.map(val => formatVolume(val)).join(', ');
                environmentalInfo = `
                    <div style="background: #e3f2fd; padding: 8px; margin: 8px 0; border-left: 3px solid #2196f3; border-radius: 3px;">
                        <strong>Environmental Corrections Applied (ISO 8655-6):</strong><br>
                        Temp: ${data.environmental.temperature}¬∞C | Pressure: ${data.environmental.pressure} kPa | Humidity: ${data.environmental.humidity}%<br>
                        Z-factor: ${data.zFactor.toFixed(6)}<br>
                        <span style="color: #666;">Raw readings: ${rawReadings} ŒºL</span><br>
                        <strong>Corrected readings: ${readings} ŒºL</strong>
                    </div>
                `;
            } else {
                // No correction - show readings normally
                environmentalInfo = `Readings: ${readings} ŒºL | Mean: ${formatVolume(data.mean)} ŒºL<br>`;
            }

            calculationsDiv.innerHTML = `
                <strong>${point.toUpperCase()} (${formatVolume(data.nominal)} ŒºL):</strong><br>
                ${environmentalInfo}
                ${data.correctionApplied ? `Mean (corrected): ${formatVolume(data.mean)} ŒºL<br>` : ''}
                <strong>Accuracy:</strong> Range ${formatVolume(data.specs.accuracy.from)}-${formatVolume(data.specs.accuracy.to)} ŒºL
                <span style="color: ${data.accuracyPass ? 'green' : 'red'}; font-weight: bold;"> ${data.accuracyPass ? '‚úì PASS' : '‚úó FAIL'}</span><br>
                <strong>Precision (ISO 8655 - pass if EITHER criterion met):</strong><br>
                &nbsp;&nbsp;‚Ä¢ CV: ${data.cv.toFixed(2)}% (Limit: ‚â§${data.specs.precision.percent}%)
                <span style="color: ${data.cvPass ? 'green' : 'red'}; font-weight: bold;"> ${data.cvPass ? '‚úì' : '‚úó'}</span><br>
                &nbsp;&nbsp;‚Ä¢ SD: ${formatVolume(data.sd)} ŒºL (Limit: ‚â§${data.specs.precision.ul} ŒºL)
                <span style="color: ${data.sdPass ? 'green' : 'red'}; font-weight: bold;"> ${data.sdPass ? '‚úì' : '‚úó'}</span><br>
                &nbsp;&nbsp;<strong>Overall Precision: <span style="color: ${data.precisionPass ? 'green' : 'red'};">${data.precisionPass ? '‚úì PASS' : '‚úó FAIL'}</span></strong>
            `;
        }

        function updateOverallStatus(pipetteId) {
            const pipette = pipettes.find(p => p.id === pipetteId);
            if (!pipette) return;

            // Check As Found status - look at asFound status badges
            const asFoundElements = ['low', 'mid', 'high'].map(point =>
                document.getElementById(`status-asFound-${point}-${pipetteId}`)
            );
            const asFoundTested = asFoundElements.every(el => el && el.textContent !== 'PENDING');
            const asFoundPass = asFoundElements.every(el => el && el.textContent === 'PASS');

            if (asFoundTested) {
                pipette.statusAsFound = asFoundPass ? 'pass' : 'fail';
            } else {
                pipette.statusAsFound = 'pending';
            }

            // Check As Left status - look at asLeft status badges
            const asLeftElements = ['low', 'mid', 'high'].map(point =>
                document.getElementById(`status-asLeft-${point}-${pipetteId}`)
            );
            const asLeftTested = asLeftElements.every(el => el && el.textContent !== 'PENDING');
            const asLeftPass = asLeftElements.every(el => el && el.textContent === 'PASS');

            if (asLeftTested) {
                pipette.statusAsLeft = asLeftPass ? 'pass' : 'fail';
            } else {
                pipette.statusAsLeft = 'pending';
            }

            // Overall status (as-left takes precedence - final status after calibration)
            pipette.status = pipette.statusAsLeft;

            const overallStatus = document.getElementById(`status-${pipetteId}`);
            if (overallStatus) {
                // Show both statuses side-by-side
                const asFoundBadge = pipette.statusAsFound === 'pass' ? '‚úÖ As Found: PASS' :
                                    pipette.statusAsFound === 'fail' ? '‚ùå As Found: FAIL' : '‚è≥ As Found: PENDING';
                const asLeftBadge = pipette.statusAsLeft === 'pass' ? '‚úÖ As Left: PASS' :
                                   pipette.statusAsLeft === 'fail' ? '‚ùå As Left: FAIL' : '‚è≥ As Left: PENDING';

                overallStatus.className = '';
                overallStatus.innerHTML = `
                    <span class="status-badge status-${pipette.statusAsFound}" style="font-size: 0.85em; margin-right: 8px;">${asFoundBadge}</span>
                    <span class="status-badge status-${pipette.statusAsLeft}" style="font-size: 0.85em;">${asLeftBadge}</span>
                `;

                // Trigger success animation if pipette passes
                if (pipette.statusAsLeft === 'pass') {
                    const pipetteCard = document.getElementById(`pipette-${pipetteId}`);
                    if (pipetteCard) {
                        pipetteCard.classList.add('success-animation');
                        setTimeout(() => pipetteCard.classList.remove('success-animation'), 600);
                    }
                }
            }
        }

        function updateProgress() {
            const total = pipettes.length;
            const completed = pipettes.filter(p => p.status !== 'pending').length;
            const progress = total > 0 ? (completed / total) * 100 : 0;
            
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = `${progress}%`;
            }
        }

        function removePipette(pipetteId) {
            saveStateForUndo('Remove pipette');
            pipettes = pipettes.filter(p => p.id !== pipetteId);
            const element = document.getElementById(`pipette-${pipetteId}`);
            if (element) element.remove();
            updateEmptyState(); // Show empty state if no pipettes left
            updateProgress();
            updateAnalysis();
            updateSummaryTable(); // Update summary table
            updateBulkActionsBar(); // Update bulk actions
            updateCopyButton(); // Show/hide copy button
            debouncedAutoSave();
            showToast('Pipette removed successfully', 'success');
        }

        function updateAnalysis() {
            const total = pipettes.length;
            const passed = pipettes.filter(p => p.status === 'pass').length;
            const failed = pipettes.filter(p => p.status === 'fail').length;
            const passRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;

            const totalEl = document.getElementById('totalPipettes');
            const passEl = document.getElementById('passCount');
            const failEl = document.getElementById('failCount');
            const rateEl = document.getElementById('passRate');

            if (totalEl) totalEl.textContent = total;
            if (passEl) passEl.textContent = passed;
            if (failEl) failEl.textContent = failed;
            if (rateEl) rateEl.textContent = `${passRate}%`;

            const analysisDetails = document.getElementById('analysisDetails');
            if (analysisDetails) {
                analysisDetails.innerHTML = generateAnalysisDetails();
            }
        }

        function generateAnalysisDetails() {
            if (pipettes.length === 0) {
                return '<div class="alert alert-info">No pipettes added yet. Go to the Calibration tab to add pipettes.</div>';
            }

            let html = '<h3>üìã Detailed Analysis</h3>';

            pipettes.forEach(pipette => {
                const statusClass = pipette.status === 'pass' ? 'alert-success' : 
                                  pipette.status === 'fail' ? 'alert-danger' : 'alert-warning';
                
                html += `
                    <div class="alert ${statusClass}">
                        <h4>${pipette.brand} ${pipette.number} (${pipette.serial})</h4>
                        <p><strong>Volume Range:</strong> ${pipette.model} | <strong>Test Volume:</strong> ${pipette.testVolume} ŒºL | <strong>Status:</strong> ${pipette.status.toUpperCase()}</p>
                        ${pipette.comments ? `<p><strong>Comments:</strong> ${pipette.comments}</p>` : ''}
                    </div>
                `;
            });

            return html;
        }

        function autoFillSampleData() {
            pipettes = [];
            document.getElementById('pipettesContainer').innerHTML = '';
            currentPipetteId = 0;

            const sampleData = [
                {
                    number: 'EQ-CPL-PIPS-D-035',
                    brand: 'Eppendorf',
                    pipetteModel: 'Research Plus',
                    serial: '3151046',
                    model: 'P-100',
                    volume: 100,
                    testVolume: 100,
                    channelType: 'single',
                    channelCount: 1,
                    measurements: {
                        asFound: {
                            low: [9.96, 9.97, 9.98, 9.95],
                            mid: [49.8, 49.7, 49.9, 49.85],
                            high: [99.6, 99.7, 99.8, 99.65]
                        },
                        asLeft: {
                            low: [9.99, 9.98, 9.96, 9.97],
                            mid: [49.9, 50.1, 49.8, 49.95],
                            high: [99.9, 99.8, 99.6, 99.75]
                        }
                    },
                    comments: 'Fixed'
                },
                {
                    number: 'EQ-CPL-PIPS-D-019',
                    brand: 'Eppendorf',
                    pipetteModel: 'Reference 2',
                    serial: '162061',
                    model: 'P-100',
                    volume: 100,
                    testVolume: 100,
                    channelType: 'single',
                    channelCount: 1,
                    measurements: {
                        asFound: {
                            low: [20.15, 20.2, 19.99, 20.05],
                            mid: [49.9, 49.7, 49.6, 49.8],
                            high: [99.9, 99.6, 99.7, 99.8]
                        },
                        asLeft: {
                            low: [20.15, 20.32, 20.25, 20.18],
                            mid: [50.1, 49.8, 50.0, 49.9],
                            high: [99.6, 99.8, 99.7, 99.75]
                        }
                    }
                },
                {
                    number: 'EQ-CPL-PIPS-D-007',
                    brand: 'Gilson',
                    pipetteModel: 'Pipetman P',
                    serial: 'Y56900K',
                    model: 'P-100',
                    volume: 100,
                    testVolume: 100,
                    channelType: 'single',
                    channelCount: 1,
                    measurements: {
                        asFound: {
                            low: [19.78, 19.74, 19.81, 19.77],
                            mid: [49.2, 49.7, 49.9, 49.6],
                            high: [99.5, 99.6, 99.5, 99.55]
                        },
                        asLeft: {
                            low: [19.64, 19.74, 19.59, 19.69],
                            mid: [49.9, 50.2, 49.9, 50.0],
                            high: [99.9, 99.8, 99.9, 99.85]
                        }
                    }
                },
                {
                    number: 'EQ-CPL-PIPS-M-008',
                    brand: 'Eppendorf',
                    pipetteModel: 'Research Plus 8-channel',
                    serial: 'M8151234',
                    model: 'P-100',
                    volume: 100,
                    testVolume: 100,
                    channelType: 'multi-8ch',
                    channelCount: 8,
                    measurements: {
                        asFound: {
                            low: [20.1, 19.9, 20.0, 19.95, 20.05, 19.92, 20.08, 19.98],
                            mid: [50.2, 49.8, 50.1, 49.9, 50.0, 49.95, 50.05, 49.85],
                            high: [100.5, 99.7, 100.2, 99.8, 100.0, 99.9, 100.1, 99.95]
                        },
                        asLeft: {
                            low: [20.0, 19.98, 20.02, 19.97, 20.01, 19.99, 20.03, 19.96],
                            mid: [50.1, 49.9, 50.05, 49.95, 50.0, 49.98, 50.02, 49.92],
                            high: [100.2, 99.9, 100.1, 99.95, 100.0, 99.98, 100.05, 99.92]
                        }
                    },
                    comments: 'Multi-channel calibrated'
                },
                {
                    number: 'EQ-CPL-PIPS-D-101',
                    brand: 'Gilson',
                    pipetteModel: 'Pipetman P',
                    serial: 'P2-12345',
                    model: 'P-2',
                    volume: 2,
                    testVolume: 2,
                    channelType: 'single',
                    channelCount: 1,
                    measurements: {
                        asFound: {
                            low: [0.495, 0.502, 0.498, 0.501],
                            mid: [0.998, 1.002, 0.995, 1.001],
                            high: [1.995, 2.002, 1.998, 2.001]
                        },
                        asLeft: {
                            low: [0.498, 0.501, 0.499, 0.502],
                            mid: [0.999, 1.001, 0.998, 1.002],
                            high: [1.998, 2.001, 1.999, 2.002]
                        }
                    },
                    comments: 'Small volume pipette'
                },
                {
                    number: 'EQ-CPL-PIPS-D-102',
                    brand: 'Eppendorf',
                    pipetteModel: 'Reference 2',
                    serial: 'P10-67890',
                    model: 'P-10',
                    volume: 10,
                    testVolume: 10,
                    channelType: 'single',
                    channelCount: 1,
                    measurements: {
                        asFound: {
                            low: [1.98, 2.01, 1.99, 2.02],
                            mid: [4.97, 5.02, 4.99, 5.01],
                            high: [9.95, 10.02, 9.98, 10.01]
                        },
                        asLeft: {
                            low: [1.99, 2.00, 2.01, 1.98],
                            mid: [4.98, 5.01, 4.99, 5.02],
                            high: [9.97, 10.01, 9.99, 10.02]
                        }
                    },
                    comments: 'Good precision'
                },
                {
                    number: 'EQ-CPL-PIPS-D-103',
                    brand: 'Gilson',
                    pipetteModel: 'Pipetman P',
                    serial: 'P20-11223',
                    model: 'P-20',
                    volume: 20,
                    testVolume: 20,
                    channelType: 'single',
                    channelCount: 1,
                    measurements: {
                        asFound: {
                            low: [4.95, 5.02, 4.98, 5.01],
                            mid: [9.96, 10.03, 9.99, 10.02],
                            high: [19.92, 20.05, 19.98, 20.01]
                        },
                        asLeft: {
                            low: [4.98, 5.01, 4.99, 5.02],
                            mid: [9.98, 10.01, 9.99, 10.02],
                            high: [19.96, 20.02, 19.99, 20.01]
                        }
                    }
                },
                {
                    number: 'EQ-CPL-PIPS-D-104',
                    brand: 'Eppendorf',
                    pipetteModel: 'Research Plus',
                    serial: 'P200-55667',
                    model: 'P-200',
                    volume: 200,
                    testVolume: 200,
                    channelType: 'single',
                    channelCount: 1,
                    measurements: {
                        asFound: {
                            low: [49.5, 50.2, 49.8, 50.1],
                            mid: [99.6, 100.3, 99.9, 100.2],
                            high: [199.2, 200.5, 199.8, 200.1]
                        },
                        asLeft: {
                            low: [49.8, 50.1, 49.9, 50.2],
                            mid: [99.8, 100.1, 99.9, 100.2],
                            high: [199.6, 200.2, 199.9, 200.1]
                        }
                    },
                    comments: 'Excellent accuracy'
                },
                {
                    number: 'EQ-CPL-PIPS-M-009',
                    brand: 'Eppendorf',
                    pipetteModel: 'Research Plus 8-channel',
                    serial: 'M200-88990',
                    model: 'P-200',
                    volume: 200,
                    testVolume: 200,
                    channelType: 'multi-8ch',
                    channelCount: 8,
                    measurements: {
                        asFound: {
                            low: [50.1, 49.8, 50.2, 49.9, 50.0, 49.95, 50.05, 49.92],
                            mid: [100.2, 99.7, 100.1, 99.9, 100.0, 99.85, 100.05, 99.95],
                            high: [200.5, 199.6, 200.2, 199.8, 200.0, 199.9, 200.1, 199.95]
                        },
                        asLeft: {
                            low: [50.0, 49.9, 50.1, 49.95, 50.02, 49.98, 50.03, 49.96],
                            mid: [100.1, 99.9, 100.05, 99.95, 100.0, 99.92, 100.02, 99.98],
                            high: [200.2, 199.8, 200.1, 199.95, 200.0, 199.95, 200.05, 199.92]
                        }
                    },
                    comments: 'Multi-channel P-200'
                },
                {
                    number: 'EQ-CPL-PIPS-D-105',
                    brand: 'Gilson',
                    pipetteModel: 'Pipetman P',
                    serial: 'P1000-33445',
                    model: 'P-1000',
                    volume: 1000,
                    testVolume: 1000,
                    channelType: 'single',
                    channelCount: 1,
                    measurements: {
                        asFound: {
                            low: [199.2, 200.5, 199.8, 200.2],
                            mid: [498.5, 501.2, 499.8, 500.5],
                            high: [995.0, 1003.5, 998.2, 1001.0]
                        },
                        asLeft: {
                            low: [199.6, 200.2, 199.9, 200.1],
                            mid: [499.2, 500.5, 499.8, 500.2],
                            high: [997.5, 1001.8, 999.2, 1000.5]
                        }
                    },
                    comments: 'Large volume pipette'
                },
                {
                    number: 'EQ-CPL-PIPS-D-106',
                    brand: 'Eppendorf',
                    pipetteModel: 'Reference 2',
                    serial: 'P5000-77889',
                    model: 'P-5000',
                    volume: 5000,
                    testVolume: 5000,
                    channelType: 'single',
                    channelCount: 1,
                    measurements: {
                        asFound: {
                            low: [995.0, 1005.0, 998.5, 1001.5],
                            mid: [2490.0, 2510.0, 2498.0, 2502.5],
                            high: [4980.0, 5020.0, 4995.0, 5005.0]
                        },
                        asLeft: {
                            low: [998.0, 1002.0, 999.5, 1000.5],
                            mid: [2495.0, 2505.0, 2499.0, 2501.0],
                            high: [4990.0, 5010.0, 4998.0, 5002.0]
                        }
                    },
                    comments: 'Very large volume'
                },
                {
                    number: 'EQ-CPL-PIPS-D-107',
                    brand: 'Gilson',
                    pipetteModel: 'Pipetman P',
                    serial: 'P2.5-44556',
                    model: 'P-2.5',
                    volume: 2.5,
                    testVolume: 2.5,
                    channelType: 'single',
                    channelCount: 1,
                    measurements: {
                        asFound: {
                            low: [0.495, 0.502, 0.498, 0.501],
                            mid: [1.245, 1.252, 1.248, 1.251],
                            high: [2.495, 2.502, 2.498, 2.501]
                        },
                        asLeft: {
                            low: [0.498, 0.501, 0.499, 0.502],
                            mid: [1.248, 1.251, 1.249, 1.252],
                            high: [2.498, 2.501, 2.499, 2.502]
                        }
                    },
                    comments: 'Irregular pattern - P-2.5'
                },
                {
                    number: 'EQ-CPL-PIPS-D-108',
                    brand: 'Eppendorf',
                    pipetteModel: 'Research Plus',
                    serial: 'P25-66778',
                    model: 'P-25',
                    volume: 25,
                    testVolume: 25,
                    channelType: 'single',
                    channelCount: 1,
                    measurements: {
                        asFound: {
                            low: [4.96, 5.03, 4.99, 5.02],
                            mid: [12.45, 12.53, 12.48, 12.51],
                            high: [24.92, 25.06, 24.98, 25.02]
                        },
                        asLeft: {
                            low: [4.98, 5.01, 4.99, 5.02],
                            mid: [12.48, 12.51, 12.49, 12.52],
                            high: [24.96, 25.02, 24.99, 25.01]
                        }
                    },
                    comments: 'Irregular pattern - P-25'
                },
                {
                    number: 'EQ-CPL-PIPS-D-109',
                    brand: 'Gilson',
                    pipetteModel: 'Pipetman P',
                    serial: 'P250-99001',
                    model: 'P-250',
                    volume: 250,
                    testVolume: 250,
                    channelType: 'single',
                    channelCount: 1,
                    measurements: {
                        asFound: {
                            low: [49.5, 50.3, 49.8, 50.2],
                            mid: [124.2, 125.5, 124.8, 125.2],
                            high: [248.5, 251.2, 249.6, 250.3]
                        },
                        asLeft: {
                            low: [49.8, 50.1, 49.9, 50.2],
                            mid: [124.6, 125.2, 124.9, 125.1],
                            high: [249.2, 250.5, 249.8, 250.2]
                        }
                    },
                    comments: 'Irregular pattern - P-250'
                },
                {
                    number: 'EQ-CPL-PIPS-D-110',
                    brand: 'Eppendorf',
                    pipetteModel: 'Reference 2',
                    serial: 'P1200-22334',
                    model: 'P-1200',
                    volume: 1200,
                    testVolume: 1200,
                    channelType: 'single',
                    channelCount: 1,
                    measurements: {
                        asFound: {
                            low: [248.5, 251.2, 249.6, 250.3],
                            mid: [597.0, 603.5, 599.2, 601.8],
                            high: [1192.0, 1208.5, 1198.5, 1203.2]
                        },
                        asLeft: {
                            low: [249.2, 250.5, 249.8, 250.2],
                            mid: [599.0, 601.5, 599.8, 600.8],
                            high: [1196.0, 1204.2, 1199.5, 1201.8]
                        }
                    },
                    comments: 'Irregular pattern - P-1200'
                }
            ];

            sampleData.forEach(data => {
                currentPipetteId++;
                const pipette = {
                    id: currentPipetteId,
                    ...data,
                    status: 'pending'
                };
                pipettes.push(pipette);
                renderPipette(pipette);
                
                ['asFound', 'asLeft'].forEach(condition => {
                    ['low', 'mid', 'high'].forEach(point => {
                        validateMeasurement(pipette.id, condition, point);
                    });
                });
                updateOverallStatus(pipette.id);
            });

            updateProgress();
            updateAnalysis();
        }

        function getSessionInfo() {
            return {
                serviceLevel: document.getElementById('serviceLevel')?.value || 'platinum',
                serviceProvider: document.getElementById('serviceProvider')?.value || '',
                location: document.getElementById('location')?.value || '',
                address: document.getElementById('address')?.value || '',
                client: document.getElementById('client')?.value || '',
                clientEmail: document.getElementById('clientEmail')?.value || '',
                contactName: document.getElementById('contactName')?.value || '',
                contactEmail: document.getElementById('contactEmail')?.value || '',
                technician: document.getElementById('technician')?.value || '',
                calDate: document.getElementById('calDate')?.value || '',
                dueDate: document.getElementById('dueDate')?.value || '',
                frequency: document.getElementById('frequency')?.value || '',
                serviceDate: document.getElementById('serviceDate')?.value || '',
                invoiceCounter: document.getElementById('invoiceCounter')?.value || '1',
                workOrderNo: document.getElementById('workOrderNo')?.value || '',
                invoiceNo: document.getElementById('invoiceNo')?.value || '',
                temperature: document.getElementById('temperature')?.value || '',
                humidity: document.getElementById('humidity')?.value || '',
                pressure: document.getElementById('pressure')?.value || '',
                balanceSerial: document.getElementById('balanceSerial')?.value || '',
                balanceCalDate: document.getElementById('balanceCalDate')?.value || '',
                balanceDueDate: document.getElementById('balanceDueDate')?.value || ''
            };
        }

        function generateReport() {
            const reportContent = document.getElementById('reportContent');
            if (!reportContent) return;

            // Check if we have a mix of service levels or single service level
            const platinumPipettes = pipettes.filter(p => p.serviceLevel === 'platinum' || !p.serviceLevel);
            const basicPipettes = pipettes.filter(p => p.serviceLevel === 'basic');

            // Determine which report to generate
            if (basicPipettes.length > 0 && platinumPipettes.length === 0) {
                // All Basic - generate Basic report
                generateBasicReport();
            } else if (platinumPipettes.length > 0 && basicPipettes.length === 0) {
                // All Platinum - generate Platinum report
                generatePlatinumReport();
            } else {
                // Mixed - generate combined report
                generateMixedReport();
            }
        }

        function generatePlatinumReport() {
            const reportContent = document.getElementById('reportContent');
            if (!reportContent) return;

            const sessionInfo = getSessionInfo();
            const certNumber = `CERT-${new Date(sessionInfo.calDate).getFullYear()}-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`;

            let html = `
                <!-- Professional Header -->
                <div style="border-bottom: 3px solid #69B135; padding-bottom: 20px; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h1 style="margin: 0; color: #2c5282; font-size: 28px;">PIPETTE CALIBRATION CERTIFICATE</h1>
                            <p style="color: #6c757d; margin: 5px 0;">üèÜ Platinum Service | ISO 8655 Compliant | Service Level 3</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0;"><strong>Certificate No:</strong> ${certNumber}</p>
                            <p style="margin: 5px 0;"><strong>Issue Date:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                </div>

                <!-- Service Information and Environmental Conditions -->
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; border: 1px solid #ddd;">
                    <tr style="background: #f8f9fa;">
                        <td colspan="4" style="padding: 10px; font-weight: bold; border: 1px solid #ddd;">SERVICE INFORMATION</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd; width: 25%;"><strong>Service Provider:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; width: 25%;">${sessionInfo.serviceProvider || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; width: 25%;"><strong>Client:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; width: 25%;">${sessionInfo.client || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Location:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.location || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Address:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.address || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Technician:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.technician || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Calibration Date:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.calDate || 'N/A'}</td>
                    </tr>
                    <tr style="background: #f8f9fa;">
                        <td colspan="4" style="padding: 10px; font-weight: bold; border: 1px solid #ddd;">ENVIRONMENTAL CONDITIONS & EQUIPMENT</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Temperature:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.temperature || 'N/A'}¬∞C ¬± 0.5¬∞C</td>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Humidity:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.humidity || 'N/A'}% RH</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Pressure:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.pressure || 'N/A'} kPa</td>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Z-Factor Correction:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.temperature && sessionInfo.pressure && sessionInfo.humidity ? 'Applied per ISO 8655-6' : 'Not Applied'}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Balance S/N:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.balanceSerial || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Water Density:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.temperature ? calculateWaterDensity(parseFloat(sessionInfo.temperature)).toFixed(2) + ' kg/m¬≥' : 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Balance Cal Date:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.balanceCalDate || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Balance Due Date:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.balanceDueDate || 'N/A'}</td>
                    </tr>
                </table>

                <!-- Summary Statistics -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                    <h3 style="margin-top: 0;">Calibration Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #69B135;">${pipettes.length}</div>
                            <div style="color: #6c757d; font-size: 14px;">Total Pipettes</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;">${pipettes.filter(p => p.status === 'pass').length}</div>
                            <div style="color: #6c757d; font-size: 14px;">Passed</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${pipettes.filter(p => p.status === 'fail').length}</div>
                            <div style="color: #6c757d; font-size: 14px;">Failed</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #69B135;">${pipettes.length > 0 ? ((pipettes.filter(p => p.status === 'pass').length / pipettes.length) * 100).toFixed(1) : 0}%</div>
                            <div style="color: #6c757d; font-size: 14px;">Pass Rate</div>
                        </div>
                    </div>
                </div>

                <!-- Individual Pipette Results -->
                <h2 style="color: #2c5282; border-bottom: 2px solid #69B135; padding-bottom: 10px;">DETAILED CALIBRATION RESULTS</h2>
            `;

            // Generate detailed results for each pipette
            pipettes.forEach((pipette, index) => {
                html += generatePipetteDetailedReport(pipette, index + 1);
            });

            // Footer
            html += `
                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #ddd;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
                        <div>
                            <p><strong>Calibration Standard:</strong> ISO 8655 (Piston-operated volumetric apparatus)</p>
                            <p><strong>Traceability:</strong> Measurements traceable to NIST standards</p>
                            <p><strong>Method:</strong> Gravimetric analysis (ISO 8655-6)</p>
                        </div>
                        <div>
                            <p><strong>Service Level:</strong> Level 3 (4 As Found + 4 As Left measurements)</p>
                            <p><strong>Next Calibration Due:</strong> ${sessionInfo.dueDate || 'N/A'}</p>
                            <p><strong>Calibration Frequency:</strong> ${sessionInfo.frequency || 'N/A'}</p>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <p style="font-style: italic; color: #6c757d;">
                            This certificate is valid only for the equipment tested under the conditions stated above.
                            The reported results reflect the status of the equipment at the time of calibration.
                        </p>
                    </div>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                            <div>
                                <p style="margin-bottom: 40px;">Technician Signature:</p>
                                <p style="border-bottom: 1px solid #000; display: inline-block; min-width: 200px;"></p>
                                <p style="margin-top: 5px; font-size: 12px;">${sessionInfo.technician || ''}</p>
                            </div>
                            <div style="text-align: right;">
                                <p><strong>Issue Date:</strong> ${new Date().toLocaleDateString()}</p>
                                <p><strong>Issue Time:</strong> ${new Date().toLocaleTimeString()}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            reportContent.innerHTML = html;
        }

        function generateBasicReport() {
            const reportContent = document.getElementById('reportContent');
            if (!reportContent) return;

            const sessionInfo = getSessionInfo();
            const workOrderNo = sessionInfo.workOrderNo || 'N/A';
            const invoiceNo = sessionInfo.invoiceNo || 'N/A';

            const basicPipettes = pipettes.filter(p => p.serviceLevel === 'basic');

            let html = `
                <!-- Professional Header -->
                <div style="border-bottom: 3px solid #69B135; padding-bottom: 20px; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h1 style="margin: 0; color: #2c5282; font-size: 28px;">PIPETTE CALIBRATION REPORT</h1>
                            <p style="color: #6c757d; margin: 5px 0;">‚ö° Basic Service | Quick Pass/Fail Verification</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0;"><strong>Work Order:</strong> ${workOrderNo}</p>
                            <p style="margin: 5px 0;"><strong>Invoice:</strong> ${invoiceNo}</p>
                            <p style="margin: 5px 0;"><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                </div>

                <!-- Service Information -->
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; border: 1px solid #ddd;">
                    <tr style="background: #f8f9fa;">
                        <td colspan="4" style="padding: 10px; font-weight: bold; border: 1px solid #ddd;">SERVICE INFORMATION</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd; width: 25%;"><strong>Service Provider:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; width: 25%;">${sessionInfo.serviceProvider || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; width: 25%;"><strong>Client:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; width: 25%;">${sessionInfo.client || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>PI Name:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.pi || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Location:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.location || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Technician:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.technician || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Service Date:</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sessionInfo.serviceDate || sessionInfo.calDate || 'N/A'}</td>
                    </tr>
                </table>

                <!-- Summary Statistics -->
                <div style="background: #5a9a2d; padding: 20px; border-radius: 8px; margin-bottom: 30px; color: white;">
                    <h3 style="margin-top: 0; color: white;">Calibration Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 28px; font-weight: bold;">${basicPipettes.length}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Total Pipettes</div>
                        </div>
                        <div>
                            <div style="font-size: 28px; font-weight: bold; color: #d4edda;">${basicPipettes.filter(p => p.passFail === 'PASS').length}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Passed</div>
                        </div>
                        <div>
                            <div style="font-size: 28px; font-weight: bold; color: #f8d7da;">${basicPipettes.filter(p => p.passFail === 'FAIL').length}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Failed</div>
                        </div>
                        <div>
                            <div style="font-size: 28px; font-weight: bold; color: #fff3cd;">${basicPipettes.length > 0 ? ((basicPipettes.filter(p => p.passFail === 'PASS').length / basicPipettes.length) * 100).toFixed(1) : 0}%</div>
                            <div style="font-size: 14px; opacity: 0.9;">Pass Rate</div>
                        </div>
                    </div>
                </div>

                <!-- Pipette Details Table -->
                <h2 style="color: #2c5282; border-bottom: 2px solid #69B135; padding-bottom: 10px;">CALIBRATION RESULTS</h2>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 13px;">
                    <thead>
                        <tr style="background: #5a9a2d; color: white;">
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">No.</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Manufacturer</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Model</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Serial Number</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Max Vol</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">In Spec</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Out Spec</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Adjustments</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Final Volumes</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Result</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            basicPipettes.forEach((pipette, index) => {
                const adjustmentsList = Object.keys(pipette.adjustments || {})
                    .filter(key => pipette.adjustments[key])
                    .join(', ') || 'None';

                const finalVols = (pipette.finalVolumes || []).filter(v => v).join(', ') || 'N/A';

                const resultColor = pipette.passFail === 'PASS' ? '#28a745' : pipette.passFail === 'FAIL' ? '#dc3545' : '#6c757d';
                const resultEmoji = pipette.passFail === 'PASS' ? '‚úì' : pipette.passFail === 'FAIL' ? '‚úó' : '‚è≥';

                html += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${String(index + 1).padStart(2, '0')}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${pipette.brand || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${pipette.makeModel || pipette.model || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${pipette.serial || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${pipette.maxVolume || pipette.volume || 'N/A'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${pipette.inSpec ? '‚úì' : '‚Äî'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${pipette.outSpec ? '‚úì' : '‚Äî'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-size: 11px;">${adjustmentsList}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-size: 11px;">${finalVols}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: ${resultColor}; font-weight: bold;">${resultEmoji} ${pipette.passFail || 'PENDING'}</td>
                    </tr>
                `;

                // Add comments row if there are comments
                if (pipette.comments) {
                    html += `
                        <tr>
                            <td colspan="10" style="padding: 8px; border: 1px solid #ddd; background: #f8f9fa; font-size: 12px;">
                                <strong>Comments:</strong> ${pipette.comments}
                            </td>
                        </tr>
                    `;
                }
            });

            html += `
                    </tbody>
                </table>

                <!-- Footer -->
                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #ddd;">
                    <div style="margin-bottom: 20px;">
                        <p><strong>Service Type:</strong> Basic Service - Quick pass/fail verification with adjustment tracking</p>
                        <p><strong>Next Service Due:</strong> ${sessionInfo.dueDate || 'N/A'}</p>
                        <p><strong>Service Frequency:</strong> ${sessionInfo.frequency || 'N/A'}</p>
                    </div>

                    <div style="margin-top: 30px;">
                        <p style="font-style: italic; color: #6c757d;">
                            This report reflects the functional status of the equipment at the time of service.
                            Results are based on pass/fail verification and adjustment records.
                        </p>
                    </div>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                            <div>
                                <p style="margin-bottom: 40px;">Technician Signature:</p>
                                <p style="border-bottom: 1px solid #000; display: inline-block; min-width: 200px;"></p>
                                <p style="margin-top: 5px; font-size: 12px;">${sessionInfo.technician || ''}</p>
                            </div>
                            <div style="text-align: right;">
                                <p><strong>Report Date:</strong> ${new Date().toLocaleDateString()}</p>
                                <p><strong>Report Time:</strong> ${new Date().toLocaleTimeString()}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            reportContent.innerHTML = html;
        }

        function generateMixedReport() {
            // For mixed service levels, generate sections for each type
            const reportContent = document.getElementById('reportContent');
            if (!reportContent) return;

            const sessionInfo = getSessionInfo();
            const platinumPipettes = pipettes.filter(p => p.serviceLevel === 'platinum' || !p.serviceLevel);
            const basicPipettes = pipettes.filter(p => p.serviceLevel === 'basic');

            let html = `
                <div style="border-bottom: 3px solid #69B135; padding-bottom: 20px; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h1 style="margin: 0; color: #2c5282; font-size: 28px;">PIPETTE CALIBRATION REPORT</h1>
                            <p style="color: #6c757d; margin: 5px 0;">Mixed Service Levels: üèÜ Platinum + ‚ö° Basic</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0;"><strong>Work Order:</strong> ${sessionInfo.workOrderNo || 'N/A'}</p>
                            <p style="margin: 5px 0;"><strong>Invoice:</strong> ${sessionInfo.invoiceNo || 'N/A'}</p>
                            <p style="margin: 5px 0;"><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                </div>

                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #ffc107;">
                    <strong>üìã Note:</strong> This session contains both Platinum and Basic service calibrations. Results are organized by service level below.
                </div>
            `;

            if (platinumPipettes.length > 0) {
                html += `<h2 style="color: #69B135; margin-top: 30px;">üèÜ Platinum Service Pipettes (${platinumPipettes.length})</h2>`;
                html += `<p style="color: #6c757d; margin-bottom: 20px;">ISO 8655 Compliant Full Gravimetric Validation</p>`;
                // Add platinum pipettes summary table here (simplified)
            }

            if (basicPipettes.length > 0) {
                html += `<h2 style="color: #69B135; margin-top: 30px;">‚ö° Basic Service Pipettes (${basicPipettes.length})</h2>`;
                html += `<p style="color: #6c757d; margin-bottom: 20px;">Quick Pass/Fail Verification</p>`;
                // Add basic pipettes summary table here (simplified)
            }

            html += `
                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #ddd;">
                    <p style="font-style: italic; color: #6c757d;">
                        For detailed reports on each service level, please generate separate reports by filtering pipettes by service type.
                    </p>
                </div>
            `;

            reportContent.innerHTML = html;
        }

        function generatePipetteDetailedReport(pipette, number) {
            const testPoints = [
                { name: 'Low', key: 'low', volume: getNominalVolume('low', pipette.model) },
                { name: 'Mid', key: 'mid', volume: getNominalVolume('mid', pipette.model) },
                { name: 'High', key: 'high', volume: getNominalVolume('high', pipette.model) }
            ];

            let html = `
                <div style="page-break-inside: avoid; margin-top: 30px; border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
                    <h3 style="background: #69B135; color: white; padding: 12px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0;">
                        Pipette #${number} - ${pipette.number || 'N/A'}
                        <span style="float: right; font-size: 18px;">${pipette.status === 'pass' ? '‚úì PASS' : pipette.status === 'fail' ? '‚úó FAIL' : '‚è≥ PENDING'}</span>
                    </h3>

                    <!-- Pipette Identification -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px;">
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #f8f9fa; width: 25%;"><strong>Brand:</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd; width: 25%;">${pipette.brand || 'N/A'}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #f8f9fa; width: 25%;"><strong>Model:</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd; width: 25%;">${pipette.pipetteModel || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Serial Number:</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${pipette.serial || 'N/A'}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Volume Range:</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${pipette.model || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Type:</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${pipette.channelType === 'single' ? 'Single Channel' : `Multi-Channel (${pipette.channelCount}ch)`}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; background: #f8f9fa;"><strong>Comments:</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${pipette.comments || 'None'}</td>
                        </tr>
                    </table>
            `;

            if (pipette.channelType === 'single') {
                html += generateSingleChannelResults(pipette, testPoints);
            } else {
                html += generateMultiChannelResults(pipette, testPoints);
            }

            html += `</div>`;
            return html;
        }

        function generateSingleChannelResults(pipette, testPoints) {
            // Get environmental conditions for corrections
            const env = getEnvironmentalConditions();

            let html = `
                <h4 style="color: #2c5282; margin-top: 20px;">As Found Measurements</h4>
                ${env.hasAllData ? '<p style="color: #2196f3; font-size: 12px; margin: 5px 0;"><strong>Note:</strong> Environmentally corrected values shown (Z-factor applied per ISO 8655-6)</p>' : ''}
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px;">
                    <thead>
                        <tr style="background: #69B135; color: white;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Test Point</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Nominal (ŒºL)</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">R1</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">R2</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">R3</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">R4</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Mean</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">CV%</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Result</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            testPoints.forEach(point => {
                const rawMeasurements = pipette.measurements.asFound[point.key];

                // Apply environmental corrections if available
                let measurements = rawMeasurements;
                if (env.hasAllData) {
                    measurements = rawMeasurements.map(val =>
                        applyEnvironmentalCorrection(val, env.temperature, env.pressure, env.humidity).corrected
                    );
                }

                const mean = measurements.reduce((a, b) => a + b, 0) / measurements.length;
                const cv = calculateCV(measurements);
                const specs = getSpecifications(pipette.model, point.volume, false);
                const pass = specs && measurements.every(m => m >= specs.accuracy.from && m <= specs.accuracy.to);

                html += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>${point.name}</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(point.volume)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(measurements[0])}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(measurements[1])}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(measurements[2])}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(measurements[3])}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${formatVolume(mean)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${cv.toFixed(2)}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: ${pass ? '#28a745' : '#dc3545'}; font-weight: bold;">${pass ? '‚úì PASS' : '‚úó FAIL'}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>

                <h4 style="color: #2c5282; margin-top: 20px;">As Left Measurements</h4>
                ${env.hasAllData ? '<p style="color: #2196f3; font-size: 12px; margin: 5px 0;"><strong>Note:</strong> Environmentally corrected values shown (Z-factor applied per ISO 8655-6)</p>' : ''}
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 13px;">
                    <thead>
                        <tr style="background: #69B135; color: white;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Test Point</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Nominal (ŒºL)</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">R1</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">R2</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">R3</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">R4</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Mean</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">CV%</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Result</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            testPoints.forEach(point => {
                const rawMeasurements = pipette.measurements.asLeft[point.key];

                // Apply environmental corrections if available
                let measurements = rawMeasurements;
                if (env.hasAllData) {
                    measurements = rawMeasurements.map(val =>
                        applyEnvironmentalCorrection(val, env.temperature, env.pressure, env.humidity).corrected
                    );
                }

                const mean = measurements.reduce((a, b) => a + b, 0) / measurements.length;
                const cv = calculateCV(measurements);
                const specs = getSpecifications(pipette.model, point.volume, false);
                const pass = specs && measurements.every(m => m >= specs.accuracy.from && m <= specs.accuracy.to);

                html += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>${point.name}</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(point.volume)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(measurements[0])}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(measurements[1])}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(measurements[2])}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(measurements[3])}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${formatVolume(mean)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${cv.toFixed(2)}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: ${pass ? '#28a745' : '#dc3545'}; font-weight: bold;">${pass ? '‚úì PASS' : '‚úó FAIL'}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            return html;
        }

        function generateMultiChannelResults(pipette, testPoints) {
            // Get environmental conditions for corrections
            const env = getEnvironmentalConditions();

            // For multi-channel, show calculated statistics across all channels
            let html = `
                <h4 style="color: #2c5282; margin-top: 20px;">As Found Measurements (Across All Channels)</h4>
                ${env.hasAllData ? '<p style="color: #2196f3; font-size: 12px; margin: 5px 0;"><strong>Note:</strong> Environmentally corrected values shown (Z-factor applied per ISO 8655-6)</p>' : ''}
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px;">
                    <thead>
                        <tr style="background: #69B135; color: white;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Test Point</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Nominal (ŒºL)</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Mean</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">CV%</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">SD (ŒºL)</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Result</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            testPoints.forEach(point => {
                const rawMeasurements = [];
                for (let ch = 0; ch < pipette.channelCount; ch++) {
                    rawMeasurements.push(pipette.measurements.asFound[point.key][ch]);
                }

                // Apply environmental corrections if available
                let measurements = rawMeasurements;
                if (env.hasAllData) {
                    measurements = rawMeasurements.map(val =>
                        applyEnvironmentalCorrection(val, env.temperature, env.pressure, env.humidity).corrected
                    );
                }

                const mean = measurements.reduce((a, b) => a + b, 0) / measurements.length;
                const cv = calculateCV(measurements);
                const sd = calculateSD(measurements);
                const specs = getSpecifications(pipette.model, point.volume, true);
                const pass = specs && measurements.every(m => m >= specs.accuracy.from && m <= specs.accuracy.to);

                html += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>${point.name}</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(point.volume)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${formatVolume(mean)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${cv.toFixed(2)}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(sd)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: ${pass ? '#28a745' : '#dc3545'}; font-weight: bold;">${pass ? '‚úì PASS' : '‚úó FAIL'}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>

                <h4 style="color: #2c5282; margin-top: 20px;">As Left Measurements (Across All Channels)</h4>
                ${env.hasAllData ? '<p style="color: #2196f3; font-size: 12px; margin: 5px 0;"><strong>Note:</strong> Environmentally corrected values shown (Z-factor applied per ISO 8655-6)</p>' : ''}
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 13px;">
                    <thead>
                        <tr style="background: #69B135; color: white;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Test Point</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Nominal (ŒºL)</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Mean</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">CV%</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">SD (ŒºL)</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Result</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            testPoints.forEach(point => {
                const rawMeasurements = [];
                for (let ch = 0; ch < pipette.channelCount; ch++) {
                    rawMeasurements.push(pipette.measurements.asLeft[point.key][ch]);
                }

                // Apply environmental corrections if available
                let measurements = rawMeasurements;
                if (env.hasAllData) {
                    measurements = rawMeasurements.map(val =>
                        applyEnvironmentalCorrection(val, env.temperature, env.pressure, env.humidity).corrected
                    );
                }

                const mean = measurements.reduce((a, b) => a + b, 0) / measurements.length;
                const cv = calculateCV(measurements);
                const sd = calculateSD(measurements);
                const specs = getSpecifications(pipette.model, point.volume, true);
                const pass = specs && measurements.every(m => m >= specs.accuracy.from && m <= specs.accuracy.to);

                html += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;"><strong>${point.name}</strong></td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(point.volume)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${formatVolume(mean)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${cv.toFixed(2)}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatVolume(sd)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: ${pass ? '#28a745' : '#dc3545'}; font-weight: bold;">${pass ? '‚úì PASS' : '‚úó FAIL'}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            return html;
        }

        function saveSession() {
            const sessionData = {
                sessionInfo: getSessionInfo(),
                pipettes: pipettes,
                timestamp: new Date().toISOString()
            };

            const dataStr = JSON.stringify(sessionData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `pipette_calibration_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // Record backup timestamp
            localStorage.setItem('lastBackupDate', Date.now().toString());

            showAlert('Session saved successfully!', 'Success');
        }

        function loadHistory() {
            const sessions = JSON.parse(localStorage.getItem('calibrationSessions') || '[]');
            const historyContainer = document.getElementById('historyContainer');

            if (!historyContainer) return;

            if (sessions.length === 0) {
                historyContainer.innerHTML = '<div class="alert alert-info">No calibration history found. Sessions will appear here after you save them.</div>';
                return;
            }

            let html = '';
            sessions.forEach(session => {
                const date = new Date(session.lastModified || session.timestamp);
                const dateStr = date.toLocaleString();
                const pipetteCount = (session.pipettes || []).length;
                const passCount = (session.pipettes || []).filter(p => p.status === 'pass').length;
                const failCount = (session.pipettes || []).filter(p => p.status === 'fail').length;
                const isCurrent = session.id === currentSessionId;

                html += `
                    <div class="session-card" onclick="loadSessionFromHistory('${session.id}')">
                        <div class="session-card-header">
                            <div>
                                <div class="session-date">${dateStr}</div>
                                ${isCurrent ? '<span class="status-badge status-pending" style="margin-left: 10px;">CURRENT</span>' : ''}
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="deleteSession('${session.id}', event)">Delete</button>
                        </div>
                        <div class="session-stats">
                            <span class="session-stat">Technician: ${session.sessionInfo?.technician || 'N/A'}</span>
                            <span class="session-stat">Location: ${session.sessionInfo?.location || 'N/A'}</span>
                        </div>
                        <div class="session-stats">
                            <span class="session-stat">Total: ${pipetteCount} pipettes</span>
                            <span class="session-stat" style="color: #28a745;">Passed: ${passCount}</span>
                            <span class="session-stat" style="color: #dc3545;">Failed: ${failCount}</span>
                        </div>
                    </div>
                `;
            });

            historyContainer.innerHTML = html;
        }

        function downloadPDF() {
            generateReport();
            window.print();
        }

        function printReport() {
            generateReport();
            window.print();
        }

        // ========== Email & Clipboard Export Functions ==========

        function emailReport() {
            const sessionInfo = getSessionInfo();

            // Build email subject
            const subject = `Pipette Calibration Report - ${sessionInfo.client || 'Lab'} - ${sessionInfo.calDate || new Date().toISOString().split('T')[0]}`;

            // Build email body with summary
            let body = `Pipette Calibration Report Summary\n\n`;
            body += `Client: ${sessionInfo.client || 'N/A'}\n`;
            body += `Location: ${sessionInfo.location || 'N/A'}\n`;
            body += `Technician: ${sessionInfo.technician || 'N/A'}\n`;
            body += `Calibration Date: ${sessionInfo.calDate || 'N/A'}\n`;
            body += `Certificate #: ${sessionInfo.certificateNumber || 'N/A'}\n\n`;

            body += `Environmental Conditions:\n`;
            body += `- Temperature: ${sessionInfo.temperature || 'N/A'}¬∞C\n`;
            body += `- Humidity: ${sessionInfo.humidity || 'N/A'}%\n`;
            body += `- Pressure: ${sessionInfo.pressure || 'N/A'} kPa\n\n`;

            body += `Pipettes Calibrated: ${pipettes.length}\n\n`;

            // Add each pipette summary
            pipettes.forEach((pipette, idx) => {
                body += `\nPipette ${idx + 1}:\n`;
                body += `- Brand: ${pipette.brand}\n`;
                body += `- Serial: ${pipette.serial}\n`;
                body += `- Model: ${pipette.model}\n`;
                body += `- Type: ${pipette.channelType === 'single' ? 'Single Channel' : `Multi-Channel (${pipette.channelCount}ch)`}\n`;

                // Calculate pass/fail status
                const specs = getIsoSpecs(pipette.model);
                const lowStatus = validateTestPoint(pipette.measurements.asLeft.low, specs.low.volume, specs.low.accuracy, specs.low.precision, pipette.channelType);
                const midStatus = validateTestPoint(pipette.measurements.asLeft.mid, specs.mid.volume, specs.mid.accuracy, specs.mid.precision, pipette.channelType);
                const highStatus = validateTestPoint(pipette.measurements.asLeft.high, specs.high.volume, specs.high.accuracy, specs.high.precision, pipette.channelType);

                const overallPass = lowStatus && midStatus && highStatus;
                body += `- Status: ${overallPass ? 'PASS ‚úì' : 'FAIL ‚úó'}\n`;
            });

            body += `\n\n---\n`;
            body += `View full report online: ${window.location.href}\n`;
            body += `Or download PDF/CSV for detailed measurements.\n\n`;
            body += `Generated by Platinum Pipette Calibration System\n`;
            body += `ISO 8655 Compliant | ISO 17025 Traceability\n`;

            // Create mailto link
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

            // Open email client
            window.location.href = mailtoLink;
        }

        function copyReportToClipboard() {
            const sessionInfo = getSessionInfo();

            // Build text report
            let report = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            report += `       PIPETTE CALIBRATION REPORT\n`;
            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;

            report += `CERTIFICATE #: ${sessionInfo.certificateNumber || 'N/A'}\n`;
            report += `CLIENT: ${sessionInfo.client || 'N/A'}\n`;
            report += `LOCATION: ${sessionInfo.location || 'N/A'}\n`;
            report += `ADDRESS: ${sessionInfo.address || 'N/A'}\n`;
            report += `TECHNICIAN: ${sessionInfo.technician || 'N/A'}\n`;
            report += `CALIBRATION DATE: ${sessionInfo.calDate || 'N/A'}\n`;
            report += `DUE DATE: ${sessionInfo.dueDate || 'N/A'}\n\n`;

            report += `ENVIRONMENTAL CONDITIONS:\n`;
            report += `  Temperature: ${sessionInfo.temperature || 'N/A'}¬∞C\n`;
            report += `  Humidity: ${sessionInfo.humidity || 'N/A'}%\n`;
            report += `  Pressure: ${sessionInfo.pressure || 'N/A'} kPa\n\n`;

            report += `BALANCE INFORMATION:\n`;
            report += `  Serial: ${sessionInfo.balanceSerial || 'N/A'}\n`;
            report += `  Cal Date: ${sessionInfo.balanceCalDate || 'N/A'}\n`;
            report += `  Due Date: ${sessionInfo.balanceDueDate || 'N/A'}\n\n`;

            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;

            // Add each pipette
            pipettes.forEach((pipette, idx) => {
                report += `PIPETTE ${idx + 1}:\n`;
                report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                report += `Brand: ${pipette.brand}\n`;
                report += `Serial: ${pipette.serial}\n`;
                report += `Model: ${pipette.model}\n`;
                report += `Type: ${pipette.channelType === 'single' ? 'Single Channel' : `Multi-Channel (${pipette.channelCount}ch)`}\n\n`;

                const specs = getIsoSpecs(pipette.model);

                // As Left results (final status)
                report += `AS LEFT RESULTS:\n`;
                report += `  Low (${specs.low.volume}¬µL): `;
                const lowStatus = validateTestPoint(pipette.measurements.asLeft.low, specs.low.volume, specs.low.accuracy, specs.low.precision, pipette.channelType);
                report += lowStatus ? 'PASS ‚úì\n' : 'FAIL ‚úó\n';

                report += `  Mid (${specs.mid.volume}¬µL): `;
                const midStatus = validateTestPoint(pipette.measurements.asLeft.mid, specs.mid.volume, specs.mid.accuracy, specs.mid.precision, pipette.channelType);
                report += midStatus ? 'PASS ‚úì\n' : 'FAIL ‚úó\n';

                report += `  High (${specs.high.volume}¬µL): `;
                const highStatus = validateTestPoint(pipette.measurements.asLeft.high, specs.high.volume, specs.high.accuracy, specs.high.precision, pipette.channelType);
                report += highStatus ? 'PASS ‚úì\n' : 'FAIL ‚úó\n';

                const overallPass = lowStatus && midStatus && highStatus;
                report += `\n  OVERALL: ${overallPass ? 'PASS ‚úì' : 'FAIL ‚úó'}\n`;

                if (pipette.comments) {
                    report += `\nComments: ${pipette.comments}\n`;
                }

                report += `\n`;
            });

            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            report += `ISO 8655 Compliant | ISO 17025 Traceability\n`;
            report += `Generated by Platinum Pipette Calibration System\n`;
            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;

            // Copy to clipboard
            navigator.clipboard.writeText(report).then(() => {
                showAlert('Report copied to clipboard! You can now paste it into an email or document.', 'Success');
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = report;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showAlert('Report copied to clipboard!', 'Success');
                } catch (err) {
                    showAlert('Could not copy to clipboard. Please try using the Email button instead.', 'Error');
                }
                document.body.removeChild(textArea);
            });
        }

        // ========== CSV Export Functions ==========

        function exportFormattedCSV() {
            const sessionInfo = getSessionInfo();
            let csv = '';

            // Header section
            csv += `Platinum SC Data Intake Worksheets,,,,,,,,,Tech:,${sessionInfo.technician}\n`;
            csv += `Platinum Service,Location:,${sessionInfo.location},,,,,Address:,${sessionInfo.address}\n`;
            csv += `Cal Date:,${sessionInfo.calDate},Client:,${sessionInfo.client},,,,,Bal SN:,${sessionInfo.balanceSerial},Bal Cal Date:,${sessionInfo.balanceCalDate}\n`;
            csv += `Cal Due:,${sessionInfo.dueDate},Frequency:,${sessionInfo.frequency},,,,,Temp:,${sessionInfo.temperature},Bal Due Date:,${sessionInfo.balanceDueDate}\n`;
            csv += `\n`;

            // Export each pipette separately (single and multi-channel have different formats)
            pipettes.forEach((pipette, idx) => {
                csv += `\n--- Pipette ${idx + 1} ---\n`;
                csv += `Pipette #:,${pipette.number}\n`;
                csv += `Brand:,${pipette.brand}\n`;
                csv += `Serial#:,${pipette.serial}\n`;
                csv += `Vol:,${pipette.testVolume}\n`;
                csv += `Type:,${pipette.channelType === 'single' ? 'Single Channel' : `Multi-Channel (${pipette.channelCount}ch)`}\n`;
                csv += `\n`;

                if (pipette.channelType === 'single') {
                    // Single channel format
                    csv += `,As Found,,,,,As Left,,,\n`;
                    csv += `,Low,Mid,High,,Low,Mid,High\n`;
                    for (let i = 0; i < 4; i++) {
                        csv += `Reading ${i + 1},${pipette.measurements.asFound.low[i] || ''},${pipette.measurements.asFound.mid[i] || ''},${pipette.measurements.asFound.high[i] || ''},,`;
                        csv += `${pipette.measurements.asLeft.low[i] || ''},${pipette.measurements.asLeft.mid[i] || ''},${pipette.measurements.asLeft.high[i] || ''}\n`;
                    }
                } else {
                    // Multi-channel format
                    csv += `Channel,As Found Low,As Found Mid,As Found High,As Left Low,As Left Mid,As Left High\n`;
                    for (let ch = 0; ch < pipette.channelCount; ch++) {
                        csv += `Channel ${ch + 1},`;
                        csv += `${pipette.measurements.asFound.low[ch] || ''},${pipette.measurements.asFound.mid[ch] || ''},${pipette.measurements.asFound.high[ch] || ''},`;
                        csv += `${pipette.measurements.asLeft.low[ch] || ''},${pipette.measurements.asLeft.mid[ch] || ''},${pipette.measurements.asLeft.high[ch] || ''}\n`;
                    }
                }

                csv += `Comments:,"${pipette.comments || ''}"\n`;
                csv += `\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `calibration_worksheet_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportDataCSV() {
            const sessionInfo = getSessionInfo();
            let csv = '';

            // CSV Headers - flexible for both single and multi-channel
            csv += 'Date,Technician,Location,Client,Pipette Number,Brand,Model,Serial,Volume,Channel Type,Channel,Test Point,Condition,Measurement,Status,Comments\n';

            // Data rows
            pipettes.forEach(pipette => {
                if (pipette.channelType === 'single') {
                    // Single channel: 4 readings per test point
                    ['low', 'mid', 'high'].forEach(point => {
                        ['asFound', 'asLeft'].forEach(condition => {
                            const measurements = pipette.measurements[condition][point];
                            if (measurements.filter(m => m !== '').length === 4) {
                                const mean = measurements.reduce((a, b) => a + b, 0) / 4;
                                const cv = calculateCV(measurements);
                                const sd = calculateSD(measurements);

                                const nominalVolume = getNominalVolume(point, pipette.model);
                                const specs = getSpecifications(pipette.model, nominalVolume, false);

                                let status = 'PENDING';
                                if (specs) {
                                    const accuracyPass = measurements.every(reading =>
                                        reading >= specs.accuracy.from && reading <= specs.accuracy.to
                                    );
                                    const cvPass = cv <= specs.precision.percent;
                                    const sdPass = sd <= specs.precision.ul;
                                    const precisionPass = cvPass || sdPass;
                                    status = (accuracyPass && precisionPass) ? 'PASS' : 'FAIL';
                                }

                                // One row per reading
                                measurements.forEach((reading, idx) => {
                                    csv += `${sessionInfo.calDate},${sessionInfo.technician},${sessionInfo.location},${sessionInfo.client},`;
                                    csv += `${pipette.number},${pipette.brand},${pipette.model},${pipette.serial},${pipette.testVolume},`;
                                    csv += `Single,Reading ${idx + 1},${point.toUpperCase()},${condition === 'asFound' ? 'As Found' : 'As Left'},`;
                                    csv += `${reading},${status},"${pipette.comments || ''}"\n`;
                                });
                            }
                        });
                    });
                } else {
                    // Multi-channel: one reading per channel per test point
                    ['asFound', 'asLeft'].forEach(condition => {
                        for (let ch = 0; ch < pipette.channelCount; ch++) {
                            const lowVal = pipette.measurements[condition].low[ch];
                            const midVal = pipette.measurements[condition].mid[ch];
                            const highVal = pipette.measurements[condition].high[ch];

                            if (lowVal !== '' && midVal !== '' && highVal !== '') {
                                const nominalVolume = getNominalVolume('high', pipette.model);
                                const specs = getSpecifications(pipette.model, nominalVolume, true);

                                let status = 'PENDING';
                                if (specs) {
                                    const allPass = [lowVal, midVal, highVal].every(val =>
                                        val >= specs.accuracy.from && val <= specs.accuracy.to
                                    );
                                    status = allPass ? 'PASS' : 'FAIL';
                                }

                                // One row per test point per channel
                                ['low', 'mid', 'high'].forEach(point => {
                                    const val = pipette.measurements[condition][point][ch];
                                    csv += `${sessionInfo.calDate},${sessionInfo.technician},${sessionInfo.location},${sessionInfo.client},`;
                                    csv += `${pipette.number},${pipette.brand},${pipette.model},${pipette.serial},${pipette.testVolume},`;
                                    csv += `Multi-${pipette.channelCount}ch,Channel ${ch + 1},${point.toUpperCase()},${condition === 'asFound' ? 'As Found' : 'As Left'},`;
                                    csv += `${val},${status},"${pipette.comments || ''}"\n`;
                                });
                            }
                        }
                    });
                }
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `calibration_data_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ========== End CSV Export Functions ==========

        // ========== Password Protection ==========
        const CALIBRATION_PASSWORD = 'platinum2024'; // Change this to your desired password

        function checkPassword() {
            // Check if already authenticated in this session
            if (sessionStorage.getItem('calibrationAuth') === 'authenticated') {
                return true;
            }

            // Prompt for password
            const password = prompt('Enter password to access Calibration System:');

            if (password === CALIBRATION_PASSWORD) {
                sessionStorage.setItem('calibrationAuth', 'authenticated');
                return true;
            } else if (password === null) {
                // User clicked cancel
                document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-family: Arial; font-size: 24px; color: #666;">Access Denied - Password Required</div>';
                return false;
            } else {
                showAlert('Incorrect password. Access denied.', 'Access Denied');
                document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-family: Arial; font-size: 24px; color: #666;">Access Denied - Incorrect Password</div>';
                return false;
            }
        }

        function logout() {
            showConfirm("Logout and clear authentication?", "Logout", () => {
                sessionStorage.removeItem('calibrationAuth');
                location.reload();
            });
        }

        // ========== End Password Protection ==========

        // ========================================
        // MULTI-EQUIPMENT CALIBRATION FUNCTIONS
        // ========================================

        // BALANCE FUNCTIONS
        function addBalance() {
            currentBalanceId++;
            const balance = {
                id: currentBalanceId,
                equipmentType: 'balance',

                // Equipment Information
                number: '',
                serial: '',
                make: '',
                model: '',
                capacity: '',
                readability: '',
                building: '',
                calDate: '',
                dueDate: '',
                calInterval: '12',
                weightsUsed: '',

                // Eccentricity Test - Weight 1 (default 5g)
                ecc1_nominal: '5',
                ecc1_certified: '5.0000108',
                ecc1_center_asFound: '',
                ecc1_center_asLeft: '',
                ecc1_leftFront_asFound: '',
                ecc1_leftFront_asLeft: '',
                ecc1_leftRear_asFound: '',
                ecc1_leftRear_asLeft: '',
                ecc1_rightRear_asFound: '',
                ecc1_rightRear_asLeft: '',
                ecc1_rightFront_asFound: '',
                ecc1_rightFront_asLeft: '',

                // Eccentricity Test - Weight 2 (default 20g)
                ecc2_nominal: '20',
                ecc2_certified: '20.0000097',
                ecc2_center_asFound: '',
                ecc2_center_asLeft: '',
                ecc2_leftFront_asFound: '',
                ecc2_leftFront_asLeft: '',
                ecc2_leftRear_asFound: '',
                ecc2_leftRear_asLeft: '',
                ecc2_rightRear_asFound: '',
                ecc2_rightRear_asLeft: '',
                ecc2_rightFront_asFound: '',
                ecc2_rightFront_asLeft: '',

                // Sensitivity Test - Weight 1 (default 100mg)
                sens1_nominal: '100mg',
                sens1_certified: '0.1000007',
                sens1_asFound_without: '',
                sens1_asFound_with: '',
                sens1_asLeft_without: '',
                sens1_asLeft_with: '',

                // Sensitivity Test - Weight 2 (default 100g)
                sens2_nominal: '100g',
                sens2_certified: '200.0',
                sens2_asFound_without: '',
                sens2_asFound_with: '',
                sens2_asLeft_without: '',
                sens2_asLeft_with: '',

                // Results
                comments: '',
                passFail: 'PENDING'
            };
            balances.push(balance);
            renderBalances();
            debouncedAutoSave();
            updateDeleteAllButtons();
            showToast('Balance added successfully', 'success');
        }

        function renderBalances() {
            const container = document.getElementById('balancesList');
            if (!container) return;

            if (balances.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                        <div style="font-size: 64px; margin-bottom: 20px;">‚öñÔ∏è</div>
                        <h3 style="color: #6c757d; margin-bottom: 10px;">No Balances Added Yet</h3>
                        <p>Click the "+ Add Balance" button above to start</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = balances.map(balance => `
                <div class="pipette-card" style="margin-bottom: 30px;">
                    <!-- Header -->
                    <div class="pipette-header" style="background: #28a745; color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <h3 style="margin: 0; font-size: 18px;">‚öñÔ∏è Balance #${String(balance.id).padStart(2, '0')}</h3>
                            <span class="status-badge status-${balance.passFail.toLowerCase()}" style="padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                                ${balance.passFail === 'PASS' ? '‚úÖ' : balance.passFail === 'FAIL' ? '‚ùå' : '‚è≥'} ${balance.passFail}
                            </span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="addBalance()" style="background: #69B135; color: white; padding: 8px 16px;" title="Add another balance">
                                ‚ûï Add Another
                            </button>
                            <button class="btn" onclick="generateBalanceCertificate(${balance.id})" style="background: rgba(255,255,255,0.2); padding: 8px 16px; color: white; border: 1px solid rgba(255,255,255,0.5);">
                                üìÑ View Certificate
                            </button>
                            <button class="btn btn-danger" onclick="removeBalance(${balance.id})" style="background: rgba(220,53,69,0.9); padding: 8px 16px;">
                                üóëÔ∏è Remove
                            </button>
                        </div>
                    </div>

                    <div style="padding: 20px;">
                        <!-- Equipment Information -->
                        <h4 style="color: #28a745; margin: 0 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #28a745;">üìã Equipment Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Manufacturer</label>
                                <input type="text" value="${balance.make}" onchange="updateBalance(${balance.id}, 'make', this.value)" placeholder="e.g., Mettler Toledo">
                            </div>
                            <div class="form-group">
                                <label>Bldg/Room</label>
                                <input type="text" value="${balance.building}" onchange="updateBalance(${balance.id}, 'building', this.value)" placeholder="Building/Room">
                            </div>
                            <div class="form-group">
                                <label>Model</label>
                                <input type="text" value="${balance.model}" onchange="updateBalance(${balance.id}, 'model', this.value)" placeholder="e.g., XS204">
                            </div>
                            <div class="form-group">
                                <label>Calibration Interval (months)</label>
                                <input type="text" value="${balance.calInterval}" onchange="updateBalance(${balance.id}, 'calInterval', this.value)" placeholder="12">
                            </div>
                            <div class="form-group">
                                <label>Weights Used</label>
                                <input type="text" value="${balance.weightsUsed}" onchange="updateBalance(${balance.id}, 'weightsUsed', this.value)" placeholder="e.g., 5g, 20g, 100mg, 100g">
                            </div>
                            <div class="form-group">
                                <label>Calibration Date</label>
                                <input type="date" value="${balance.calDate}" onchange="updateBalance(${balance.id}, 'calDate', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Serial No.</label>
                                <input type="text" value="${balance.serial}" onchange="updateBalance(${balance.id}, 'serial', this.value)" placeholder="Serial number">
                            </div>
                            <div class="form-group">
                                <label>Calibration Due Date</label>
                                <input type="date" value="${balance.dueDate}" onchange="updateBalance(${balance.id}, 'dueDate', this.value)">
                            </div>
                        </div>

                        <!-- Eccentricity Test -->
                        <h4 style="color: #28a745; margin: 25px 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #28a745;">üìç Eccentricity Test</h4>

                        <!-- Weight 1 -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: #495057;">Test Weight 1</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div class="form-group">
                                    <label>Nominal Weight (g)</label>
                                    <input type="text" value="${balance.ecc1_nominal}" onchange="updateBalance(${balance.id}, 'ecc1_nominal', this.value)" placeholder="5">
                                </div>
                                <div class="form-group">
                                    <label>Certified Weight (g)</label>
                                    <input type="text" value="${balance.ecc1_certified}" onchange="updateBalance(${balance.id}, 'ecc1_certified', this.value)" placeholder="5.0000108">
                                </div>
                            </div>
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <thead>
                                    <tr style="background: #28a745; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">Position</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">As Found</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">As Left</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">Center</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc1_center_asFound}" onchange="updateBalance(${balance.id}, 'ecc1_center_asFound', this.value)" placeholder="5.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc1_center_asLeft}" onchange="updateBalance(${balance.id}, 'ecc1_center_asLeft', this.value)" placeholder="5.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">Left Front</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc1_leftFront_asFound}" onchange="updateBalance(${balance.id}, 'ecc1_leftFront_asFound', this.value)" placeholder="5.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc1_leftFront_asLeft}" onchange="updateBalance(${balance.id}, 'ecc1_leftFront_asLeft', this.value)" placeholder="5.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">Left Rear</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc1_leftRear_asFound}" onchange="updateBalance(${balance.id}, 'ecc1_leftRear_asFound', this.value)" placeholder="5.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc1_leftRear_asLeft}" onchange="updateBalance(${balance.id}, 'ecc1_leftRear_asLeft', this.value)" placeholder="5.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">Right Rear</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc1_rightRear_asFound}" onchange="updateBalance(${balance.id}, 'ecc1_rightRear_asFound', this.value)" placeholder="5.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc1_rightRear_asLeft}" onchange="updateBalance(${balance.id}, 'ecc1_rightRear_asLeft', this.value)" placeholder="5.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">Right Front</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc1_rightFront_asFound}" onchange="updateBalance(${balance.id}, 'ecc1_rightFront_asFound', this.value)" placeholder="5.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc1_rightFront_asLeft}" onchange="updateBalance(${balance.id}, 'ecc1_rightFront_asLeft', this.value)" placeholder="5.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Weight 2 -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: #495057;">Test Weight 2</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div class="form-group">
                                    <label>Nominal Weight (g)</label>
                                    <input type="text" value="${balance.ecc2_nominal}" onchange="updateBalance(${balance.id}, 'ecc2_nominal', this.value)" placeholder="20">
                                </div>
                                <div class="form-group">
                                    <label>Certified Weight (g)</label>
                                    <input type="text" value="${balance.ecc2_certified}" onchange="updateBalance(${balance.id}, 'ecc2_certified', this.value)" placeholder="20.0000097">
                                </div>
                            </div>
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <thead>
                                    <tr style="background: #28a745; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">Position</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">As Found</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">As Left</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">Center</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc2_center_asFound}" onchange="updateBalance(${balance.id}, 'ecc2_center_asFound', this.value)" placeholder="20.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc2_center_asLeft}" onchange="updateBalance(${balance.id}, 'ecc2_center_asLeft', this.value)" placeholder="20.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">Left Front</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc2_leftFront_asFound}" onchange="updateBalance(${balance.id}, 'ecc2_leftFront_asFound', this.value)" placeholder="20.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc2_leftFront_asLeft}" onchange="updateBalance(${balance.id}, 'ecc2_leftFront_asLeft', this.value)" placeholder="20.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">Left Rear</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc2_leftRear_asFound}" onchange="updateBalance(${balance.id}, 'ecc2_leftRear_asFound', this.value)" placeholder="20.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc2_leftRear_asLeft}" onchange="updateBalance(${balance.id}, 'ecc2_leftRear_asLeft', this.value)" placeholder="20.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">Right Rear</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc2_rightRear_asFound}" onchange="updateBalance(${balance.id}, 'ecc2_rightRear_asFound', this.value)" placeholder="20.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc2_rightRear_asLeft}" onchange="updateBalance(${balance.id}, 'ecc2_rightRear_asLeft', this.value)" placeholder="20.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">Right Front</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc2_rightFront_asFound}" onchange="updateBalance(${balance.id}, 'ecc2_rightFront_asFound', this.value)" placeholder="20.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.ecc2_rightFront_asLeft}" onchange="updateBalance(${balance.id}, 'ecc2_rightFront_asLeft', this.value)" placeholder="20.0000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Sensitivity Test -->
                        <h4 style="color: #28a745; margin: 25px 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #28a745;">‚öñÔ∏è Sensitivity Test</h4>

                        <!-- Sensitivity Weight 1 -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: #495057;">Test Weight 1</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div class="form-group">
                                    <label>Nominal Weight</label>
                                    <input type="text" value="${balance.sens1_nominal}" onchange="updateBalance(${balance.id}, 'sens1_nominal', this.value)" placeholder="100mg">
                                </div>
                                <div class="form-group">
                                    <label>Certified Weight (g)</label>
                                    <input type="text" value="${balance.sens1_certified}" onchange="updateBalance(${balance.id}, 'sens1_certified', this.value)" placeholder="0.1000007">
                                </div>
                            </div>
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <thead>
                                    <tr style="background: #28a745; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;"></th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Without Reference</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">With Reference</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">As Found</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.sens1_asFound_without}" onchange="updateBalance(${balance.id}, 'sens1_asFound_without', this.value)" placeholder="0.0" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.sens1_asFound_with}" onchange="updateBalance(${balance.id}, 'sens1_asFound_with', this.value)" placeholder="0.1000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">As Left</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.sens1_asLeft_without}" onchange="updateBalance(${balance.id}, 'sens1_asLeft_without', this.value)" placeholder="0.0" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.sens1_asLeft_with}" onchange="updateBalance(${balance.id}, 'sens1_asLeft_with', this.value)" placeholder="0.1000" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Sensitivity Weight 2 -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: #495057;">Test Weight 2</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div class="form-group">
                                    <label>Nominal Weight</label>
                                    <input type="text" value="${balance.sens2_nominal}" onchange="updateBalance(${balance.id}, 'sens2_nominal', this.value)" placeholder="100g">
                                </div>
                                <div class="form-group">
                                    <label>Certified Weight (g)</label>
                                    <input type="text" value="${balance.sens2_certified}" onchange="updateBalance(${balance.id}, 'sens2_certified', this.value)" placeholder="200.0">
                                </div>
                            </div>
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <thead>
                                    <tr style="background: #28a745; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;"></th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Without Reference</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">With Reference</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">As Found</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.sens2_asFound_without}" onchange="updateBalance(${balance.id}, 'sens2_asFound_without', this.value)" placeholder="0.0" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.sens2_asFound_with}" onchange="updateBalance(${balance.id}, 'sens2_asFound_with', this.value)" placeholder="100.0" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">As Left</td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.sens2_asLeft_without}" onchange="updateBalance(${balance.id}, 'sens2_asLeft_without', this.value)" placeholder="0.0" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                        <td style="padding: 4px; border: 1px solid #ddd;"><input type="text" value="${balance.sens2_asLeft_with}" onchange="updateBalance(${balance.id}, 'sens2_asLeft_with', this.value)" placeholder="100.0" style="width: 100%; border: 1px solid #ccc; padding: 4px;"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Results Section -->
                        <h4 style="color: #28a745; margin: 25px 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #28a745;">üìù Results & Status</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Overall Status</label>
                                <select value="${balance.passFail}" onchange="updateBalance(${balance.id}, 'passFail', this.value)">
                                    <option value="PENDING" ${balance.passFail === 'PENDING' ? 'selected' : ''}>‚è≥ PENDING</option>
                                    <option value="PASS" ${balance.passFail === 'PASS' ? 'selected' : ''}>‚úÖ PASS</option>
                                    <option value="FAIL" ${balance.passFail === 'FAIL' ? 'selected' : ''}>‚ùå FAIL</option>
                                </select>
                            </div>
                        </div>
                        <p style="color: #6c757d; font-size: 13px; margin-top: 8px;">
                            <em>Note: PI contact info will be pulled from Session Info tab</em>
                        </p>
                        <div class="form-group" style="margin-top: 15px;">
                            <label>Comments</label>
                            <textarea onchange="updateBalance(${balance.id}, 'comments', this.value)" rows="3" placeholder="Additional notes...">${balance.comments}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateBalance(balanceId, field, value) {
            const balance = balances.find(b => b.id === balanceId);
            if (balance) {
                balance[field] = value;
                renderBalances();
                debouncedAutoSave();
            }
        }

        function removeBalance(balanceId) {
            showConfirm('Remove this balance from the session?', 'Confirm Removal', () => {
                balances = balances.filter(b => b.id !== balanceId);
                renderBalances();
                updateManifest();
                debouncedAutoSave();
                updateDeleteAllButtons();
                showToast('Balance removed successfully', 'success');
            });
        }

        // BALANCE CERTIFICATE GENERATION
        function generateBalanceCertificate(balanceId) {
            const balance = balances.find(b => b.id === balanceId);
            if (!balance) return;

            const sessionInfo = getSessionInfo();

            // Calculate deviations (helper function)
            const calcDev = (displayed, certified) => {
                if (!displayed || !certified) return '';
                const dev = parseFloat(displayed) - parseFloat(certified);
                return dev.toFixed(4);
            };

            // Open print window with certificate
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Balance Calibration Certificate - ${balance.serial || 'N/A'}</title>
                    <style>
                        @media print {
                            @page { margin: 0.5in; size: letter; }
                            body { margin: 0; }
                            .no-print { display: none !important; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.4;
                            color: #333;
                            max-width: 8.5in;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        h1 {
                            text-align: center;
                            color: #223077;
                            font-size: 24px;
                            margin: 20px 0 10px 0;
                            border-bottom: 3px solid #69B135;
                            padding-bottom: 10px;
                        }
                        h2 {
                            font-size: 14px;
                            background: #f8f9fa;
                            padding: 8px 12px;
                            border-left: 4px solid #69B135;
                            margin: 20px 0 10px 0;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 15px 0;
                            font-size: 12px;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 6px 8px;
                            text-align: left;
                        }
                        th {
                            background: #69B135;
                            color: white;
                            font-weight: 600;
                        }
                        .info-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 10px;
                            margin: 15px 0;
                        }
                        .info-item {
                            font-size: 12px;
                            padding: 5px 0;
                        }
                        .info-item strong {
                            display: inline-block;
                            width: 150px;
                            color: #555;
                        }
                        .tech-line {
                            text-align: right;
                            font-size: 12px;
                            margin: 10px 0;
                        }
                        .signature-section {
                            margin-top: 40px;
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 30px;
                        }
                        .signature-block {
                            border-top: 1px solid #333;
                            padding-top: 8px;
                            text-align: center;
                            font-size: 12px;
                        }
                        .footer {
                            margin-top: 40px;
                            text-align: center;
                            font-size: 11px;
                            color: #666;
                            border-top: 2px solid #28a745;
                            padding-top: 15px;
                        }
                        .test-section {
                            background: #f8f9fa;
                            padding: 15px;
                            margin: 15px 0;
                            border-radius: 8px;
                            border: 1px solid #ddd;
                        }
                        .test-header {
                            font-weight: 600;
                            color: #28a745;
                            margin-bottom: 10px;
                            font-size: 13px;
                        }
                        .weight-info {
                            font-size: 11px;
                            color: #666;
                            margin-bottom: 8px;
                        }
                        .print-btn {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            padding: 12px 24px;
                            background: #69B135;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                        }
                        .print-btn:hover {
                            background: #558a2a;
                        }
                    </style>
                </head>
                <body>
                    <button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è Print Certificate</button>

                    <h1>‚öñÔ∏è ANALYTICAL BALANCE</h1>
                    <h1 style="font-size: 20px; margin-top: -10px; border: none;">CERTIFICATE</h1>

                    <div class="tech-line">
                        <strong>Tech:</strong> ${sessionInfo.technician || '_____________'}
                    </div>

                    <!-- Equipment Information -->
                    <div class="info-grid">
                        <div class="info-item"><strong>Manufacturer:</strong> ${balance.make || 'N/A'}</div>
                        <div class="info-item"><strong>Bldg/Room:</strong> ${balance.building || 'N/A'}</div>
                        <div class="info-item"><strong>Model:</strong> ${balance.model || 'N/A'}</div>
                        <div class="info-item"><strong>Calibration Interval:</strong> ${balance.calInterval || '12'} Month</div>
                        <div class="info-item"><strong>Weights:</strong> ${balance.weightsUsed || 'N/A'}</div>
                        <div class="info-item"><strong>Calibration Date:</strong> ${balance.calDate || 'N/A'}</div>
                        <div class="info-item"><strong>Serial No.:</strong> ${balance.serial || 'N/A'}</div>
                        <div class="info-item"><strong>Calibration Due Date:</strong> ${balance.dueDate || 'N/A'}</div>
                    </div>

                    <!-- Eccentricity Test -->
                    <h2>Eccentricity (g):</h2>

                    <!-- Eccentricity Weight 1 -->
                    <div class="test-section">
                        <div class="test-header">Test Weight: ${balance.ecc1_nominal || '5'}g</div>
                        <div class="weight-info">Cert Wt: ${balance.ecc1_certified || '5.0000108'}g</div>
                        <table>
                            <thead>
                                <tr>
                                    <th rowspan="2">Test Weight</th>
                                    <th rowspan="2">Position</th>
                                    <th colspan="2">As Found</th>
                                    <th colspan="2">As Left</th>
                                </tr>
                                <tr>
                                    <th>Displayed Value</th>
                                    <th>Deviation</th>
                                    <th>Displayed Value</th>
                                    <th>Deviation</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${balance.ecc1_nominal || '5.0'}</td>
                                    <td>Center</td>
                                    <td>${balance.ecc1_center_asFound || ''}</td>
                                    <td>${calcDev(balance.ecc1_center_asFound, balance.ecc1_certified)}</td>
                                    <td>${balance.ecc1_center_asLeft || ''}</td>
                                    <td>${calcDev(balance.ecc1_center_asLeft, balance.ecc1_certified)}</td>
                                </tr>
                                <tr>
                                    <td>${balance.ecc1_nominal || '5.0'}</td>
                                    <td>Left Front</td>
                                    <td>${balance.ecc1_leftFront_asFound || ''}</td>
                                    <td>${calcDev(balance.ecc1_leftFront_asFound, balance.ecc1_certified)}</td>
                                    <td>${balance.ecc1_leftFront_asLeft || ''}</td>
                                    <td>${calcDev(balance.ecc1_leftFront_asLeft, balance.ecc1_certified)}</td>
                                </tr>
                                <tr>
                                    <td>${balance.ecc1_nominal || '5.0'}</td>
                                    <td>Left Rear</td>
                                    <td>${balance.ecc1_leftRear_asFound || ''}</td>
                                    <td>${calcDev(balance.ecc1_leftRear_asFound, balance.ecc1_certified)}</td>
                                    <td>${balance.ecc1_leftRear_asLeft || ''}</td>
                                    <td>${calcDev(balance.ecc1_leftRear_asLeft, balance.ecc1_certified)}</td>
                                </tr>
                                <tr>
                                    <td>${balance.ecc1_nominal || '5.0'}</td>
                                    <td>Right Rear</td>
                                    <td>${balance.ecc1_rightRear_asFound || ''}</td>
                                    <td>${calcDev(balance.ecc1_rightRear_asFound, balance.ecc1_certified)}</td>
                                    <td>${balance.ecc1_rightRear_asLeft || ''}</td>
                                    <td>${calcDev(balance.ecc1_rightRear_asLeft, balance.ecc1_certified)}</td>
                                </tr>
                                <tr>
                                    <td>${balance.ecc1_nominal || '5.0'}</td>
                                    <td>Right Front</td>
                                    <td>${balance.ecc1_rightFront_asFound || ''}</td>
                                    <td>${calcDev(balance.ecc1_rightFront_asFound, balance.ecc1_certified)}</td>
                                    <td>${balance.ecc1_rightFront_asLeft || ''}</td>
                                    <td>${calcDev(balance.ecc1_rightFront_asLeft, balance.ecc1_certified)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Eccentricity Weight 2 -->
                    <div class="test-section">
                        <div class="test-header">Test Weight: ${balance.ecc2_nominal || '20'}g</div>
                        <div class="weight-info">Cert Wt: ${balance.ecc2_certified || '20.0000097'}g</div>
                        <table>
                            <thead>
                                <tr>
                                    <th rowspan="2">Test Weight</th>
                                    <th rowspan="2">Position</th>
                                    <th colspan="2">As Found</th>
                                    <th colspan="2">As Left</th>
                                </tr>
                                <tr>
                                    <th>Displayed Value</th>
                                    <th>Deviation</th>
                                    <th>Displayed Value</th>
                                    <th>Deviation</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${balance.ecc2_nominal || '20.0'}</td>
                                    <td>Center</td>
                                    <td>${balance.ecc2_center_asFound || ''}</td>
                                    <td>${calcDev(balance.ecc2_center_asFound, balance.ecc2_certified)}</td>
                                    <td>${balance.ecc2_center_asLeft || ''}</td>
                                    <td>${calcDev(balance.ecc2_center_asLeft, balance.ecc2_certified)}</td>
                                </tr>
                                <tr>
                                    <td>${balance.ecc2_nominal || '20.0'}</td>
                                    <td>Left Front</td>
                                    <td>${balance.ecc2_leftFront_asFound || ''}</td>
                                    <td>${calcDev(balance.ecc2_leftFront_asFound, balance.ecc2_certified)}</td>
                                    <td>${balance.ecc2_leftFront_asLeft || ''}</td>
                                    <td>${calcDev(balance.ecc2_leftFront_asLeft, balance.ecc2_certified)}</td>
                                </tr>
                                <tr>
                                    <td>${balance.ecc2_nominal || '20.0'}</td>
                                    <td>Left Rear</td>
                                    <td>${balance.ecc2_leftRear_asFound || ''}</td>
                                    <td>${calcDev(balance.ecc2_leftRear_asFound, balance.ecc2_certified)}</td>
                                    <td>${balance.ecc2_leftRear_asLeft || ''}</td>
                                    <td>${calcDev(balance.ecc2_leftRear_asLeft, balance.ecc2_certified)}</td>
                                </tr>
                                <tr>
                                    <td>${balance.ecc2_nominal || '20.0'}</td>
                                    <td>Right Rear</td>
                                    <td>${balance.ecc2_rightRear_asFound || ''}</td>
                                    <td>${calcDev(balance.ecc2_rightRear_asFound, balance.ecc2_certified)}</td>
                                    <td>${balance.ecc2_rightRear_asLeft || ''}</td>
                                    <td>${calcDev(balance.ecc2_rightRear_asLeft, balance.ecc2_certified)}</td>
                                </tr>
                                <tr>
                                    <td>${balance.ecc2_nominal || '20.0'}</td>
                                    <td>Right Front</td>
                                    <td>${balance.ecc2_rightFront_asFound || ''}</td>
                                    <td>${calcDev(balance.ecc2_rightFront_asFound, balance.ecc2_certified)}</td>
                                    <td>${balance.ecc2_rightFront_asLeft || ''}</td>
                                    <td>${calcDev(balance.ecc2_rightFront_asLeft, balance.ecc2_certified)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Sensitivity Test -->
                    <h2>Sensitivity (g):</h2>

                    <!-- Sensitivity Weight 1 -->
                    <div class="test-section">
                        <div class="test-header">Test Weight: ${balance.sens1_nominal || '100mg'}</div>
                        <div class="weight-info">Cert Wt: ${balance.sens1_certified || '0.1000007'}g</div>
                        <table>
                            <thead>
                                <tr>
                                    <th rowspan="2">Wt</th>
                                    <th colspan="3">As Found</th>
                                    <th colspan="3">As Left</th>
                                </tr>
                                <tr>
                                    <th>Without Reference Weight</th>
                                    <th>With Reference Weight</th>
                                    <th>Deviation</th>
                                    <th>Without Reference Weight</th>
                                    <th>With Reference Weight</th>
                                    <th>Deviation</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${balance.sens1_nominal || '100.0'}</td>
                                    <td>${balance.sens1_asFound_without || ''}</td>
                                    <td>${balance.sens1_asFound_with || ''}</td>
                                    <td>${calcDev((parseFloat(balance.sens1_asFound_without || 0) + parseFloat(balance.sens1_asFound_with || 0)), balance.sens1_certified)}</td>
                                    <td>${balance.sens1_asLeft_without || ''}</td>
                                    <td>${balance.sens1_asLeft_with || ''}</td>
                                    <td>${calcDev((parseFloat(balance.sens1_asLeft_without || 0) + parseFloat(balance.sens1_asLeft_with || 0)), balance.sens1_certified)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Sensitivity Weight 2 -->
                    <div class="test-section">
                        <div class="test-header">Test Weight: ${balance.sens2_nominal || '100g'}</div>
                        <div class="weight-info">Cert Wt: ${balance.sens2_certified || '200.0'}g</div>
                        <table>
                            <thead>
                                <tr>
                                    <th rowspan="2">Wt</th>
                                    <th colspan="3">As Found</th>
                                    <th colspan="3">As Left</th>
                                </tr>
                                <tr>
                                    <th>Without Reference Weight</th>
                                    <th>With Reference Weight</th>
                                    <th>Deviation</th>
                                    <th>Without Reference Weight</th>
                                    <th>With Reference Weight</th>
                                    <th>Deviation</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${balance.sens2_nominal || '100.0'}</td>
                                    <td>${balance.sens2_asFound_without || ''}</td>
                                    <td>${balance.sens2_asFound_with || ''}</td>
                                    <td>${calcDev((parseFloat(balance.sens2_asFound_without || 0) + parseFloat(balance.sens2_asFound_with || 0)), balance.sens2_certified)}</td>
                                    <td>${balance.sens2_asLeft_without || ''}</td>
                                    <td>${balance.sens2_asLeft_with || ''}</td>
                                    <td>${calcDev((parseFloat(balance.sens2_asLeft_without || 0) + parseFloat(balance.sens2_asLeft_with || 0)), balance.sens2_certified)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Comments -->
                    ${balance.comments ? `
                        <h2>Comments:</h2>
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 12px;">
                            ${balance.comments}
                        </div>
                    ` : ''}

                    <!-- Contact Information (from Session Info) -->
                    <div class="info-grid" style="margin-top: 30px;">
                        <div class="info-item"><strong>PI Name:</strong> ${sessionInfo.pi || 'N/A'}</div>
                        <div class="info-item"><strong>Technician:</strong> ${sessionInfo.technician || 'N/A'}</div>
                    </div>

                    <!-- Signature Section -->
                    <div class="signature-section">
                        <div class="signature-block">
                            Verified By: _________________________
                        </div>
                        <div class="signature-block">
                            Date: ${balance.calDate || '______________'}
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="footer">
                        <p style="margin: 5px 0; font-weight: 600; color: #223077;">Calibrations International, Inc.</p>
                        <p style="margin: 5px 0; color: #666;">Bozeman, Montana 59718</p>
                        <p style="margin: 5px 0; color: #666;">1-877 CAL-INTL | 406-589-6025</p>
                        <p style="margin: 5px 0; color: #69B135;">theresa@calibrationsinternational.com</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // TIMER FUNCTIONS
        function addTimer() {
            currentTimerId++;
            const timer = {
                id: currentTimerId,
                equipmentType: 'timer',
                number: '',
                serial: '',
                make: '',
                model: '',
                building: '',
                // Time Point 1 (30 seconds)
                timePoint1_nominal: '30',
                timePoint1_reading: '',
                // Time Point 2 (2 minutes / 120 seconds)
                timePoint2_nominal: '120',
                timePoint2_reading: '',
                passFail: 'PENDING',
                comments: ''
            };
            timers.push(timer);
            renderTimers();
            debouncedAutoSave();
            updateDeleteAllButtons();
        }

        function renderTimers() {
            const container = document.getElementById('timersList');
            if (!container) return;

            if (timers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                        <div style="font-size: 64px; margin-bottom: 20px;">‚è±Ô∏è</div>
                        <h3 style="color: #6c757d; margin-bottom: 10px;">No Timers Added Yet</h3>
                        <p>Click the "+ Add Timer" button above to start</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = timers.map(timer => `
                <div class="pipette-card" style="margin-bottom: 20px;">
                    <div class="pipette-header" style="background: #17a2b8; color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <h3 style="margin: 0; font-size: 18px;">‚è±Ô∏è Timer #${String(timer.id).padStart(2, '0')}</h3>
                            <span class="status-badge status-${timer.passFail.toLowerCase()}" style="padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                                ${timer.passFail === 'PASS' ? '‚úÖ' : timer.passFail === 'FAIL' ? '‚ùå' : '‚è≥'} ${timer.passFail}
                            </span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="addTimer()" style="background: #69B135; color: white; padding: 8px 16px;" title="Add another timer">
                                ‚ûï Add Another
                            </button>
                            <button class="btn btn-danger" onclick="removeTimer(${timer.id})" style="background: rgba(220,53,69,0.9); padding: 8px 16px;">
                                üóëÔ∏è Remove
                            </button>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Timer Number</label>
                                <input type="text" value="${timer.number}" onchange="updateTimer(${timer.id}, 'number', this.value)" placeholder="e.g., TIM-001">
                            </div>
                            <div class="form-group">
                                <label>Serial Number</label>
                                <input type="text" value="${timer.serial}" onchange="updateTimer(${timer.id}, 'serial', this.value)" placeholder="Serial number">
                            </div>
                            <div class="form-group">
                                <label>Make</label>
                                <input type="text" value="${timer.make}" onchange="updateTimer(${timer.id}, 'make', this.value)" placeholder="e.g., VWR">
                            </div>
                            <div class="form-group">
                                <label>Model</label>
                                <input type="text" value="${timer.model}" onchange="updateTimer(${timer.id}, 'model', this.value)" placeholder="Model number">
                            </div>
                            <div class="form-group">
                                <label>Bldg/Room</label>
                                <input type="text" value="${timer.building}" onchange="updateTimer(${timer.id}, 'building', this.value)" placeholder="Building/Room">
                            </div>
                        </div>

                        <h4 style="color: #17a2b8; margin: 20px 0 10px 0;">‚è±Ô∏è Timer Verification</h4>
                        <div style="background: #e7f3f8; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #17a2b8;">
                            <div style="font-size: 13px; color: #0c5460;">
                                <strong>Reference:</strong> <a href="https://time.gov" target="_blank" rel="noopener noreferrer" style="color: #17a2b8; text-decoration: none; font-weight: 600;">üåê time.gov</a>
                                <span style="margin-left: 10px; color: #666;">| Official U.S. Time Reference</span>
                            </div>
                        </div>

                        <!-- Time Point 1: 30 Seconds -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #dee2e6;">
                            <h5 style="color: #17a2b8; margin: 0 0 10px 0;">Time Point 1: 30 Seconds</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Nominal Time (seconds)</label>
                                    <input type="number" value="${timer.timePoint1_nominal || '30'}" onchange="updateTimer(${timer.id}, 'timePoint1_nominal', this.value)" placeholder="30">
                                </div>
                                <div class="form-group">
                                    <label>Actual Reading (seconds)</label>
                                    <input type="text" value="${timer.timePoint1_reading || ''}" onchange="updateTimer(${timer.id}, 'timePoint1_reading', this.value)" placeholder="Enter reading">
                                </div>
                            </div>
                        </div>

                        <!-- Time Point 2: 2 Minutes (120 Seconds) -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #dee2e6;">
                            <h5 style="color: #17a2b8; margin: 0 0 10px 0;">Time Point 2: 2 Minutes (120 Seconds)</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Nominal Time (seconds)</label>
                                    <input type="number" value="${timer.timePoint2_nominal || '120'}" onchange="updateTimer(${timer.id}, 'timePoint2_nominal', this.value)" placeholder="120">
                                </div>
                                <div class="form-group">
                                    <label>Actual Reading (seconds)</label>
                                    <input type="text" value="${timer.timePoint2_reading || ''}" onchange="updateTimer(${timer.id}, 'timePoint2_reading', this.value)" placeholder="Enter reading">
                                </div>
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Overall Status</label>
                                <select value="${timer.passFail}" onchange="updateTimer(${timer.id}, 'passFail', this.value)">
                                    <option value="PENDING" ${timer.passFail === 'PENDING' ? 'selected' : ''}>‚è≥ PENDING</option>
                                    <option value="PASS" ${timer.passFail === 'PASS' ? 'selected' : ''}>‚úÖ PASS</option>
                                    <option value="FAIL" ${timer.passFail === 'FAIL' ? 'selected' : ''}>‚ùå FAIL</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <label>Comments</label>
                            <textarea value="${timer.comments}" onchange="updateTimer(${timer.id}, 'comments', this.value)" rows="3" placeholder="Additional notes...">${timer.comments}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateTimer(timerId, field, value) {
            const timer = timers.find(t => t.id === timerId);
            if (timer) {
                timer[field] = value;
                renderTimers();
                debouncedAutoSave();
            }
        }

        function removeTimer(timerId) {
            showConfirm('Remove this timer from the session?', 'Confirm Removal', () => {
                timers = timers.filter(t => t.id !== timerId);
                renderTimers();
                updateManifest();
                debouncedAutoSave();
                updateDeleteAllButtons();
            });
        }

        // CENTRIFUGE FUNCTIONS
        function addCentrifuge() {
            currentCentrifugeId++;
            const centrifuge = {
                id: currentCentrifugeId,
                equipmentType: 'centrifuge',
                number: '',
                serial: '',
                make: '',
                model: '',
                maxRPM: '',
                testRPM: '',
                asFoundRPM: '',
                asLeftRPM: '',
                accuracy: '',
                passFail: 'PENDING',
                comments: ''
            };
            centrifuges.push(centrifuge);
            renderCentrifuges();
            debouncedAutoSave();
            updateDeleteAllButtons();
        }

        function renderCentrifuges() {
            const container = document.getElementById('centrifugesList');
            if (!container) return;

            if (centrifuges.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üåÄ</div>
                        <h3 style="color: #6c757d; margin-bottom: 10px;">No Centrifuges Added Yet</h3>
                        <p>Click the "+ Add Centrifuge" button above to start</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = centrifuges.map(centrifuge => `
                <div class="pipette-card" style="margin-bottom: 20px;">
                    <div class="pipette-header" style="background: #6f42c1; color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <h3 style="margin: 0; font-size: 18px;">üåÄ Centrifuge #${String(centrifuge.id).padStart(2, '0')}</h3>
                            <span class="status-badge status-${centrifuge.passFail.toLowerCase()}" style="padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                                ${centrifuge.passFail === 'PASS' ? '‚úÖ' : centrifuge.passFail === 'FAIL' ? '‚ùå' : '‚è≥'} ${centrifuge.passFail}
                            </span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="addCentrifuge()" style="background: #69B135; color: white; padding: 8px 16px;" title="Add another centrifuge">
                                ‚ûï Add Another
                            </button>
                            <button class="btn btn-danger" onclick="removeCentrifuge(${centrifuge.id})" style="background: rgba(220,53,69,0.9); padding: 8px 16px;">
                                üóëÔ∏è Remove
                            </button>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Centrifuge Number</label>
                                <input type="text" value="${centrifuge.number}" onchange="updateCentrifuge(${centrifuge.id}, 'number', this.value)" placeholder="e.g., CENT-001">
                            </div>
                            <div class="form-group">
                                <label>Serial Number</label>
                                <input type="text" value="${centrifuge.serial}" onchange="updateCentrifuge(${centrifuge.id}, 'serial', this.value)" placeholder="Serial number">
                            </div>
                            <div class="form-group">
                                <label>Make</label>
                                <input type="text" value="${centrifuge.make}" onchange="updateCentrifuge(${centrifuge.id}, 'make', this.value)" placeholder="e.g., Eppendorf">
                            </div>
                            <div class="form-group">
                                <label>Model</label>
                                <input type="text" value="${centrifuge.model}" onchange="updateCentrifuge(${centrifuge.id}, 'model', this.value)" placeholder="Model number">
                            </div>
                            <div class="form-group">
                                <label>Max RPM</label>
                                <input type="text" value="${centrifuge.maxRPM}" onchange="updateCentrifuge(${centrifuge.id}, 'maxRPM', this.value)" placeholder="e.g., 15000">
                            </div>
                        </div>

                        <h4 style="color: #6f42c1; margin: 20px 0 10px 0;">üåÄ Calibration Test</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Test RPM</label>
                                <input type="text" value="${centrifuge.testRPM}" onchange="updateCentrifuge(${centrifuge.id}, 'testRPM', this.value)" placeholder="e.g., 5000">
                            </div>
                            <div class="form-group">
                                <label>As Found Actual RPM</label>
                                <input type="text" value="${centrifuge.asFoundRPM}" onchange="updateCentrifuge(${centrifuge.id}, 'asFoundRPM', this.value)" placeholder="Measured RPM">
                            </div>
                            <div class="form-group">
                                <label>As Left Actual RPM</label>
                                <input type="text" value="${centrifuge.asLeftRPM}" onchange="updateCentrifuge(${centrifuge.id}, 'asLeftRPM', this.value)" placeholder="Measured RPM">
                            </div>
                            <div class="form-group">
                                <label>Accuracy / Deviation</label>
                                <input type="text" value="${centrifuge.accuracy}" onchange="updateCentrifuge(${centrifuge.id}, 'accuracy', this.value)" placeholder="e.g., ¬±50 RPM">
                            </div>
                            <div class="form-group">
                                <label>Overall Status</label>
                                <select value="${centrifuge.passFail}" onchange="updateCentrifuge(${centrifuge.id}, 'passFail', this.value)">
                                    <option value="PENDING" ${centrifuge.passFail === 'PENDING' ? 'selected' : ''}>‚è≥ PENDING</option>
                                    <option value="PASS" ${centrifuge.passFail === 'PASS' ? 'selected' : ''}>‚úÖ PASS</option>
                                    <option value="FAIL" ${centrifuge.passFail === 'FAIL' ? 'selected' : ''}>‚ùå FAIL</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <label>Comments</label>
                            <textarea value="${centrifuge.comments}" onchange="updateCentrifuge(${centrifuge.id}, 'comments', this.value)" rows="3" placeholder="Additional notes...">${centrifuge.comments}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateCentrifuge(centrifugeId, field, value) {
            const centrifuge = centrifuges.find(c => c.id === centrifugeId);
            if (centrifuge) {
                centrifuge[field] = value;
                renderCentrifuges();
                debouncedAutoSave();
            }
        }

        function removeCentrifuge(centrifugeId) {
            showConfirm('Remove this centrifuge from the session?', 'Confirm Removal', () => {
                centrifuges = centrifuges.filter(c => c.id !== centrifugeId);
                renderCentrifuges();
                updateManifest();
                debouncedAutoSave();
                updateDeleteAllButtons();
            });
        }

        // TEMPERATURE DEVICE FUNCTIONS
        function addTemperatureDevice() {
            currentTemperatureDeviceId++;
            const device = {
                id: currentTemperatureDeviceId,
                equipmentType: 'temperature',
                number: '',
                serial: '',
                make: '',
                model: '',
                building: '',
                range: '',
                testPoint: '',
                asFoundReading: '',
                asLeftReading: '',
                accuracy: '',
                passFail: 'PENDING',
                comments: ''
            };
            temperatureDevices.push(device);
            renderTemperatureDevices();
            debouncedAutoSave();
            updateDeleteAllButtons();
        }

        function renderTemperatureDevices() {
            const container = document.getElementById('temperatureDevicesList');
            if (!container) return;

            if (temperatureDevices.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üå°Ô∏è</div>
                        <h3 style="color: #6c757d; margin-bottom: 10px;">No Temperature Devices Added Yet</h3>
                        <p>Click the "+ Add Temperature Device" button above to start</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = temperatureDevices.map(device => `
                <div class="pipette-card" style="margin-bottom: 20px;">
                    <div class="pipette-header" style="background: #fd7e14; color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <h3 style="margin: 0; font-size: 18px;">üå°Ô∏è Temperature Device #${String(device.id).padStart(2, '0')}</h3>
                            <span class="status-badge status-${device.passFail.toLowerCase()}" style="padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                                ${device.passFail === 'PASS' ? '‚úÖ' : device.passFail === 'FAIL' ? '‚ùå' : '‚è≥'} ${device.passFail}
                            </span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="addTemperatureDevice()" style="background: #69B135; color: white; padding: 8px 16px;" title="Add another temperature device">
                                ‚ûï Add Another
                            </button>
                            <button class="btn btn-danger" onclick="removeTemperatureDevice(${device.id})" style="background: rgba(220,53,69,0.9); padding: 8px 16px;">
                                üóëÔ∏è Remove
                            </button>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Device Number</label>
                                <input type="text" value="${device.number}" onchange="updateTemperatureDevice(${device.id}, 'number', this.value)" placeholder="e.g., TEMP-001">
                            </div>
                            <div class="form-group">
                                <label>Serial Number</label>
                                <input type="text" value="${device.serial}" onchange="updateTemperatureDevice(${device.id}, 'serial', this.value)" placeholder="Serial number">
                            </div>
                            <div class="form-group">
                                <label>Make</label>
                                <input type="text" value="${device.make}" onchange="updateTemperatureDevice(${device.id}, 'make', this.value)" placeholder="e.g., Fisher Scientific">
                            </div>
                            <div class="form-group">
                                <label>Model</label>
                                <input type="text" value="${device.model}" onchange="updateTemperatureDevice(${device.id}, 'model', this.value)" placeholder="Model number">
                            </div>
                            <div class="form-group">
                                <label>Bldg/Room</label>
                                <input type="text" value="${device.building}" onchange="updateTemperatureDevice(${device.id}, 'building', this.value)" placeholder="Building/Room">
                            </div>
                            <div class="form-group">
                                <label>Temperature Range</label>
                                <input type="text" value="${device.range}" onchange="updateTemperatureDevice(${device.id}, 'range', this.value)" placeholder="e.g., -20 to 100¬∞C">
                            </div>
                        </div>

                        <h4 style="color: #fd7e14; margin: 20px 0 10px 0;">üå°Ô∏è Calibration Test</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Test Point (¬∞C)</label>
                                <input type="text" value="${device.testPoint}" onchange="updateTemperatureDevice(${device.id}, 'testPoint', this.value)" placeholder="e.g., 25.0">
                            </div>
                            <div class="form-group">
                                <label>As Found Reading (¬∞C)</label>
                                <input type="text" value="${device.asFoundReading}" onchange="updateTemperatureDevice(${device.id}, 'asFoundReading', this.value)" placeholder="Measured temp">
                            </div>
                            <div class="form-group">
                                <label>As Left Reading (¬∞C)</label>
                                <input type="text" value="${device.asLeftReading}" onchange="updateTemperatureDevice(${device.id}, 'asLeftReading', this.value)" placeholder="Measured temp">
                            </div>
                            <div class="form-group">
                                <label>Accuracy / Deviation</label>
                                <input type="text" value="${device.accuracy}" onchange="updateTemperatureDevice(${device.id}, 'accuracy', this.value)" placeholder="e.g., ¬±0.5¬∞C">
                            </div>
                            <div class="form-group">
                                <label>Overall Status</label>
                                <select value="${device.passFail}" onchange="updateTemperatureDevice(${device.id}, 'passFail', this.value)">
                                    <option value="PENDING" ${device.passFail === 'PENDING' ? 'selected' : ''}>‚è≥ PENDING</option>
                                    <option value="PASS" ${device.passFail === 'PASS' ? 'selected' : ''}>‚úÖ PASS</option>
                                    <option value="FAIL" ${device.passFail === 'FAIL' ? 'selected' : ''}>‚ùå FAIL</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <label>Comments</label>
                            <textarea value="${device.comments}" onchange="updateTemperatureDevice(${device.id}, 'comments', this.value)" rows="3" placeholder="Additional notes...">${device.comments}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateTemperatureDevice(deviceId, field, value) {
            const device = temperatureDevices.find(d => d.id === deviceId);
            if (device) {
                device[field] = value;
                renderTemperatureDevices();
                debouncedAutoSave();
            }
        }

        function removeTemperatureDevice(deviceId) {
            showConfirm('Remove this temperature device from the session?', 'Confirm Removal', () => {
                temperatureDevices = temperatureDevices.filter(d => d.id !== deviceId);
                renderTemperatureDevices();
                updateManifest();
                debouncedAutoSave();
                updateDeleteAllButtons();
            });
        }

        // MANIFEST / SUMMARY FUNCTION
        function updateManifest() {
            const summaryContainer = document.getElementById('manifestSummary');
            const tableContainer = document.getElementById('manifestTable');

            if (!summaryContainer || !tableContainer) return;

            // Calculate counts
            const counts = {
                pipettes: pipettes.length,
                balances: balances.length,
                timers: timers.length,
                centrifuges: centrifuges.length,
                temperature: temperatureDevices.length
            };

            const total = Object.values(counts).reduce((sum, count) => sum + count, 0);

            // Render summary cards with CI branding
            summaryContainer.innerHTML = `
                <div style="background: #69B135; padding: 25px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <div style="font-size: 48px; font-weight: bold; margin-bottom: 5px;">${total}</div>
                    <div style="opacity: 0.95; font-size: 16px; font-weight: 600;">üìä Total Equipment</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #69B135; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="font-size: 32px; font-weight: bold; color: #69B135;">${counts.pipettes}</div>
                    <div style="color: #666; font-weight: 600;">üíß Pipettes</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #28a745; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="font-size: 32px; font-weight: bold; color: #28a745;">${counts.balances}</div>
                    <div style="color: #666; font-weight: 600;">‚öñÔ∏è Balances</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #17a2b8; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="font-size: 32px; font-weight: bold; color: #17a2b8;">${counts.timers}</div>
                    <div style="color: #666; font-weight: 600;">‚è±Ô∏è Timers</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #6f42c1; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="font-size: 32px; font-weight: bold; color: #6f42c1;">${counts.centrifuges}</div>
                    <div style="color: #666; font-weight: 600;">üåÄ Centrifuges</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #fd7e14; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="font-size: 32px; font-weight: bold; color: #fd7e14;">${counts.temperature}</div>
                    <div style="color: #666; font-weight: 600;">üå°Ô∏è Temperature</div>
                </div>
            `;

            // Combine all equipment
            const allEquipment = [
                ...pipettes.map(p => ({...p, type: 'Pipette', icon: 'üíß'})),
                ...balances.map(b => ({...b, type: 'Balance', icon: '‚öñÔ∏è'})),
                ...timers.map(t => ({...t, type: 'Timer', icon: '‚è±Ô∏è'})),
                ...centrifuges.map(c => ({...c, type: 'Centrifuge', icon: 'üåÄ'})),
                ...temperatureDevices.map(d => ({...d, type: 'Temperature', icon: 'üå°Ô∏è'}))
            ];

            if (allEquipment.length === 0) {
                tableContainer.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üìã</div>
                        <h3 style="color: #6c757d; margin-bottom: 10px;">No Equipment Added Yet</h3>
                        <p>Add equipment using the tabs above to see them here</p>
                    </div>
                `;
                return;
            }

            // Render equipment table
            tableContainer.innerHTML = `
                <table class="pipette-table" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 15px; text-align: left;">Type</th>
                            <th style="padding: 15px; text-align: left;">ID</th>
                            <th style="padding: 15px; text-align: left;">Serial</th>
                            <th style="padding: 15px; text-align: left;">Make</th>
                            <th style="padding: 15px; text-align: left;">Model</th>
                            <th style="padding: 15px; text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allEquipment.map((item, index) => `
                            <tr style="border-bottom: 1px solid #dee2e6; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                                <td style="padding: 12px;">${item.icon} ${item.type}</td>
                                <td style="padding: 12px;">#${String(item.id).padStart(2, '0')}</td>
                                <td style="padding: 12px;">${item.serial || '-'}</td>
                                <td style="padding: 12px;">${item.make || '-'}</td>
                                <td style="padding: 12px;">${item.model || item.makeModel || '-'}</td>
                                <td style="padding: 12px; text-align: center;">
                                    <span class="status-badge status-${(item.passFail || item.statusAsLeft || 'PENDING').toLowerCase()}" style="padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                                        ${(item.passFail || item.statusAsLeft || 'PENDING') === 'PASS' || (item.passFail || item.statusAsLeft) === 'pass' ? '‚úÖ PASS' :
                                          (item.passFail || item.statusAsLeft || 'PENDING') === 'FAIL' || (item.passFail || item.statusAsLeft) === 'fail' ? '‚ùå FAIL' :
                                          '‚è≥ PENDING'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Export session data as JSON file
        function exportSessionData() {
            const sessionData = {
                id: currentSessionId,
                sessionInfo: getSessionInfo(),
                pipettes: pipettes,
                balances: balances,
                timers: timers,
                centrifuges: centrifuges,
                temperatureDevices: temperatureDevices,
                inventoryUsage: inventoryUsage,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };

            const dataStr = JSON.stringify(sessionData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;

            const date = new Date().toISOString().split('T')[0];
            const workOrder = document.getElementById('workOrder')?.value || 'session';
            link.download = `calibration_session_${workOrder}_${date}.json`;

            link.click();
            URL.revokeObjectURL(url);

            showToast('Session data exported successfully', 'success');
        }

        // ========================================
        // INVENTORY MANAGEMENT FUNCTIONS
        // ========================================

        function autoDetectInventory() {
            // Auto-detect inventory items from Basic mode pipettes
            const basicPipettes = pipettes.filter(p => p.serviceLevel === 'basic');
            const detected = [];

            basicPipettes.forEach(pipette => {
                const adjustments = pipette.adjustments || {};
                const pipetteNo = String(pipette.id).padStart(2, '0');

                // Check each adjustment type
                Object.keys(adjustments).forEach(adjType => {
                    if (adjustments[adjType] && adjustments[adjType].trim() !== '') {
                        const itemName = getAdjustmentItemName(adjType);
                        detected.push({
                            item: itemName,
                            quantity: 1,
                            pipetteNo: pipetteNo,
                            notes: `Auto-detected from ${adjType} adjustment`
                        });
                    }
                });
            });

            return detected;
        }

        function autoDetectAndAddInventory() {
            const detected = autoDetectInventory();

            if (detected.length === 0) {
                showAlert('No adjustments found in Basic mode pipettes. Complete calibrations first.', 'No Items Detected');
                return;
            }

            const sessionInfo = getSessionInfo();
            const technician = sessionInfo.technician || 'Unknown';
            const invoice = sessionInfo.invoiceNo || '';

            // Add each detected item to inventory
            detected.forEach(det => {
                const item = {
                    id: Date.now() + Math.random(), // Ensure unique IDs
                    item: det.item,
                    quantity: det.quantity,
                    pipetteNo: det.pipetteNo,
                    jobInvoice: invoice,
                    usedBy: technician,
                    timestamp: new Date().toLocaleString(),
                    notes: det.notes
                };
                inventoryUsage.push(item);
            });

            renderInventoryUsage();
            updateInventoryStats();
            debouncedAutoSave();

            showAlert(`Auto-detected and added ${detected.length} inventory item(s) from calibration adjustments.`, 'Inventory Detected');
        }

        function getAdjustmentItemName(adjType) {
            const itemMap = {
                'SE': 'Seal/Ejector Adjustment',
                'COR': 'Corrector/Piston Adjustment',
                'G': 'Grease Application',
                'SH': 'Shaft Adjustment',
                'FR': 'Frame Repair',
                'O': 'O-Ring Replacement',
                'OTHER': 'Miscellaneous Part'
            };
            return itemMap[adjType] || adjType;
        }

        function openAddInventoryModal() {
            document.getElementById('inventoryModal').style.display = 'flex';
            document.getElementById('invItemName').value = '';
            document.getElementById('invQuantity').value = '1';
            document.getElementById('invPipetteNo').value = '';
            document.getElementById('invNotes').value = '';
            document.getElementById('invItemName').focus();
        }

        function closeInventoryModal() {
            document.getElementById('inventoryModal').style.display = 'none';
        }

        function addInventoryItem() {
            const itemName = document.getElementById('invItemName')?.value.trim();
            const quantity = parseInt(document.getElementById('invQuantity')?.value || '1');
            const pipetteNo = document.getElementById('invPipetteNo')?.value.trim();
            const notes = document.getElementById('invNotes')?.value.trim();

            if (!itemName) {
                showAlert('Please enter an item name', 'Validation Error');
                return;
            }

            const sessionInfo = getSessionInfo();
            const technician = sessionInfo.technician || 'Unknown';
            const invoice = sessionInfo.invoiceNo || '';

            const item = {
                id: Date.now(),
                item: itemName,
                quantity: quantity,
                pipetteNo: pipetteNo,
                jobInvoice: invoice,
                usedBy: technician,
                timestamp: new Date().toLocaleString(),
                notes: notes
            };

            inventoryUsage.push(item);
            renderInventoryUsage();
            updateInventoryStats();
            closeInventoryModal();
            debouncedAutoSave();
        }

        function renderInventoryUsage() {
            const tbody = document.getElementById('inventoryUsageBody');
            if (!tbody) return;

            if (inventoryUsage.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>
                            <div style="font-size: 16px;">No inventory items used yet</div>
                            <div style="font-size: 14px; margin-top: 5px;">Items will be auto-detected from adjustments or added manually</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = inventoryUsage.map(item => `
                <tr>
                    <td>${item.item}</td>
                    <td style="text-align: center;">${item.quantity}</td>
                    <td style="text-align: center;">${item.pipetteNo || '-'}</td>
                    <td>${item.jobInvoice || '-'}</td>
                    <td>${item.usedBy}</td>
                    <td style="font-size: 12px;">${item.timestamp}</td>
                    <td>${item.notes || '-'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteInventoryUsage(${item.id})"
                                style="padding: 5px 10px; font-size: 12px;">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateInventoryStats() {
            const totalItems = inventoryUsage.reduce((sum, item) => sum + item.quantity, 0);
            const uniqueItems = new Set(inventoryUsage.map(item => item.item)).size;
            const currentSessionItems = inventoryUsage.length;

            document.getElementById('invTotalItems').textContent = totalItems;
            document.getElementById('invCurrentSession').textContent = currentSessionItems;
            document.getElementById('invUniqueItems').textContent = uniqueItems;
        }

        function deleteInventoryUsage(id) {
            showConfirm('Delete this inventory item?', 'Confirm Delete', () => {
                inventoryUsage = inventoryUsage.filter(item => item.id !== id);
                renderInventoryUsage();
                updateInventoryStats();
                debouncedAutoSave();
            });
        }

        function clearInventoryUsage() {
            if (inventoryUsage.length === 0) {
                showAlert('Inventory is already empty', 'Notice');
                return;
            }

            showConfirm('Clear all inventory items?', 'Confirm Clear', () => {
                inventoryUsage = [];
                renderInventoryUsage();
                updateInventoryStats();
                debouncedAutoSave();
            });
        }

        function exportInventoryUsage() {
            if (inventoryUsage.length === 0) {
                showAlert('No inventory items to export', 'Notice');
                return;
            }

            const sessionInfo = getSessionInfo();
            const headers = ['Item Name', 'Quantity', 'Pipette #', 'Job/Invoice', 'Used By', 'Timestamp', 'Notes'];

            const rows = inventoryUsage.map(item => [
                item.item,
                item.quantity,
                item.pipetteNo || '',
                item.jobInvoice || '',
                item.usedBy,
                item.timestamp,
                item.notes || ''
            ]);

            const csv = [headers, ...rows].map(row =>
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory-usage-${sessionInfo.invoiceNo || 'export'}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========================================
        // SUMMARY TABLE FUNCTIONS (Basic Mode)
        // ========================================

        function updateSummaryTable() {
            const tbody = document.getElementById('summaryTableBody');
            if (!tbody) return;

            const basicPipettes = pipettes.filter(p => p.serviceLevel === 'basic');

            if (basicPipettes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #6c757d;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üìä</div>
                            <div style="font-size: 16px;">No Basic service pipettes added yet</div>
                            <div style="font-size: 14px; margin-top: 5px;">Add pipettes in the Calibration tab</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = basicPipettes.map(pipette => {
                const adjustmentsList = Object.keys(pipette.adjustments || {})
                    .filter(key => pipette.adjustments[key])
                    .join(', ') || '-';

                const finalVols = (pipette.finalVolumes || []).filter(v => v).join(', ') || '-';

                const statusClass = pipette.passFail === 'PASS' ? 'pass' : pipette.passFail === 'FAIL' ? 'fail' : 'pending';
                const statusBadge = `<span class="status-badge status-${statusClass}">${pipette.passFail || 'PENDING'}</span>`;

                return `
                    <tr>
                        <td style="text-align: center; font-weight: bold;">${String(pipette.id).padStart(2, '0')}</td>
                        <td>${pipette.brand || '-'}</td>
                        <td>${pipette.makeModel || pipette.model || '-'}</td>
                        <td>${pipette.maxVolume || pipette.volume || '-'}</td>
                        <td style="text-align: center;">${pipette.inSpec ? '‚úÖ' : '‚Äî'}</td>
                        <td style="text-align: center;">${pipette.outSpec ? '‚ùå' : '‚Äî'}</td>
                        <td style="font-size: 12px;">${adjustmentsList}</td>
                        <td style="font-size: 12px;">${finalVols}</td>
                        <td style="text-align: center;">${statusBadge}</td>
                        <td style="text-align: center;">
                            <button class="btn btn-sm btn-danger" onclick="removePipette(${pipette.id})"
                                    style="padding: 5px 10px; font-size: 12px;">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function exportSummaryToCSV() {
            const basicPipettes = pipettes.filter(p => p.serviceLevel === 'basic');

            if (basicPipettes.length === 0) {
                showAlert('No Basic service pipettes to export', 'Notice');
                return;
            }

            const sessionInfo = getSessionInfo();
            const headers = ['No.', 'Manufacturer', 'Model', 'Max Vol', 'In Spec', 'Out Spec', 'Adjustments', 'Final Volumes', 'P/F'];

            const rows = basicPipettes.map(pipette => {
                const adjustmentsList = Object.keys(pipette.adjustments || {})
                    .filter(key => pipette.adjustments[key])
                    .join(', ') || '';

                const finalVols = (pipette.finalVolumes || []).filter(v => v).join(', ') || '';

                return [
                    String(pipette.id).padStart(2, '0'),
                    pipette.brand || '',
                    pipette.makeModel || pipette.model || '',
                    pipette.maxVolume || pipette.volume || '',
                    pipette.inSpec ? 'Yes' : 'No',
                    pipette.outSpec ? 'Yes' : 'No',
                    adjustmentsList,
                    finalVols,
                    pipette.passFail || 'PENDING'
                ];
            });

            const csv = [headers, ...rows].map(row =>
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `summary-table-${sessionInfo.invoiceNo || 'export'}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========================================
        // LABELS FUNCTIONS
        // ========================================

        function generateLabels() {
            const container = document.getElementById('labelsContainer');
            if (!container) return;

            if (pipettes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üè∑Ô∏è</div>
                        <div style="font-size: 16px;">No pipettes to generate labels for</div>
                    </div>
                `;
                return;
            }

            const sessionInfo = getSessionInfo();
            const calDate = sessionInfo.calDate || new Date().toISOString().split('T')[0];
            const dueDate = sessionInfo.dueDate || '';
            const technician = sessionInfo.technician || '';

            container.innerHTML = pipettes.map(pipette => {
                const statusEmoji = pipette.serviceLevel === 'basic'
                    ? (pipette.passFail === 'PASS' ? '‚úÖ' : pipette.passFail === 'FAIL' ? '‚ùå' : '‚è≥')
                    : (pipette.statusAsLeft === 'pass' ? '‚úÖ' : pipette.statusAsLeft === 'fail' ? '‚ùå' : '‚è≥');

                const status = pipette.serviceLevel === 'basic'
                    ? pipette.passFail || 'PENDING'
                    : pipette.statusAsLeft.toUpperCase();

                return `
                    <div class="label" style="border: 2px solid #333; padding: 15px; margin: 10px; width: 300px;
                                               display: inline-block; font-family: monospace; background: white;">
                        <div style="text-align: center; font-weight: bold; font-size: 18px; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 10px;">
                            CALIBRATION LABEL
                        </div>
                        <div style="margin: 5px 0;"><strong>Pipette #:</strong> ${String(pipette.id).padStart(2, '0')}</div>
                        <div style="margin: 5px 0;"><strong>Serial:</strong> ${pipette.serial || 'N/A'}</div>
                        <div style="margin: 5px 0;"><strong>Brand:</strong> ${pipette.brand}</div>
                        <div style="margin: 5px 0;"><strong>Model:</strong> ${pipette.makeModel || pipette.model || 'N/A'}</div>
                        <div style="margin: 5px 0;"><strong>Volume:</strong> ${pipette.maxVolume || pipette.volume} ¬µL</div>
                        <div style="margin: 5px 0;"><strong>Cal Date:</strong> ${calDate}</div>
                        <div style="margin: 5px 0;"><strong>Due Date:</strong> ${dueDate}</div>
                        <div style="margin: 5px 0;"><strong>Technician:</strong> ${technician}</div>
                        <div style="margin: 5px 0;"><strong>Status:</strong> ${statusEmoji} ${status}</div>
                        <div style="margin: 5px 0;"><strong>Service:</strong> ${pipette.serviceLevel === 'basic' ? '‚ö° Basic' : 'üèÜ Platinum'}</div>
                    </div>
                `;
            }).join('');

            showAlert(`Generated ${pipettes.length} label(s). Click "Print Labels" to print.`, 'Labels Generated');
        }

        function printLabels() {
            const container = document.getElementById('labelsContainer');
            if (!container || !container.innerHTML.trim() || pipettes.length === 0) {
                showAlert('Please generate labels first', 'Notice');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Calibration Labels</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        .label {
                            border: 2px solid #333;
                            padding: 15px;
                            margin: 10px;
                            width: 300px;
                            display: inline-block;
                            font-family: monospace;
                            background: white;
                            page-break-inside: avoid;
                        }
                        @media print {
                            .label { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    ${container.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // ========================================
        // TEMPLATES SYSTEM
        // ========================================

        let pipetteTemplates = JSON.parse(localStorage.getItem('pipetteTemplates') || '[]');

        function openTemplatesModal() {
            document.getElementById('templatesModal').style.display = 'flex';
            renderTemplatesList();
            populateTemplatePipetteSelect();
        }

        function closeTemplatesModal() {
            document.getElementById('templatesModal').style.display = 'none';
        }

        function renderTemplatesList() {
            const container = document.getElementById('templatesList');
            if (!container) return;

            if (pipetteTemplates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìù</div>
                        <div>No templates saved yet</div>
                        <div style="font-size: 14px; margin-top: 5px;">Add a pipette and save it as a template to get started</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = pipetteTemplates.map((template, index) => `
                <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 10px 0; color: #17a2b8;">${template.name}</h4>
                            <div style="font-size: 13px; color: #6c757d;">
                                <div><strong>Brand:</strong> ${template.data.brand || 'N/A'}</div>
                                <div><strong>Model:</strong> ${template.data.makeModel || template.data.model || 'N/A'}</div>
                                <div><strong>Volume:</strong> ${template.data.maxVolume || template.data.volume || 'N/A'} ¬µL</div>
                                <div><strong>Service:</strong> ${template.data.serviceLevel === 'basic' ? '‚ö° Basic' : 'üèÜ Platinum'}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-primary btn-sm" onclick="loadFromTemplate(${index})" style="padding: 6px 12px; font-size: 12px;">
                                ‚ûï Use Template
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTemplate(${index})" style="padding: 6px 12px; font-size: 12px;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function populateTemplatePipetteSelect() {
            const select = document.getElementById('templatePipetteSelect');
            if (!select) return;

            select.innerHTML = '<option value="">-- Select a pipette --</option>';
            pipettes.forEach(pipette => {
                const label = `Pipette #${String(pipette.id).padStart(2, '0')} - ${pipette.brand} ${pipette.makeModel || pipette.model || ''}`;
                select.innerHTML += `<option value="${pipette.id}">${label}</option>`;
            });
        }

        function saveAsTemplate() {
            const pipetteId = parseInt(document.getElementById('templatePipetteSelect')?.value);
            const templateName = document.getElementById('templateName')?.value.trim();

            if (!pipetteId) {
                showAlert('Please select a pipette to save as template', 'Validation Error');
                return;
            }

            if (!templateName) {
                showAlert('Please enter a template name', 'Validation Error');
                return;
            }

            const pipette = pipettes.find(p => p.id === pipetteId);
            if (!pipette) {
                showAlert('Pipette not found', 'Error');
                return;
            }

            // Create template (exclude ID and specific data like serial, measurements)
            const template = {
                name: templateName,
                data: {
                    serviceLevel: pipette.serviceLevel,
                    brand: pipette.brand,
                    pipetteModel: pipette.pipetteModel,
                    volume: pipette.volume,
                    model: pipette.model,
                    testVolume: pipette.testVolume,
                    channelType: pipette.channelType,
                    channelCount: pipette.channelCount,
                    makeModel: pipette.makeModel,
                    maxVolume: pipette.maxVolume,
                    adjustments: pipette.adjustments
                },
                createdAt: new Date().toISOString()
            };

            pipetteTemplates.push(template);
            localStorage.setItem('pipetteTemplates', JSON.stringify(pipetteTemplates));

            document.getElementById('templateName').value = '';
            renderTemplatesList();
            showAlert(`Template "${templateName}" saved successfully!`, 'Template Saved');
        }

        function loadFromTemplate(index) {
            const template = pipetteTemplates[index];
            if (!template) return;

            saveStateForUndo('Load from template');
            currentPipetteId++;

            const newPipette = {
                id: currentPipetteId,
                ...template.data,
                number: '',
                serial: '',
                comments: '',
                status: 'pending',
                measurements: {
                    asFound: { low: ['', '', '', ''], mid: ['', '', '', ''], high: ['', '', '', ''] },
                    asLeft: { low: ['', '', '', ''], mid: ['', '', '', ''], high: ['', '', '', ''] }
                },
                statusAsFound: 'pending',
                statusAsLeft: 'pending',
                inSpec: false,
                outSpec: false,
                finalVolumes: ['', '', '', ''],
                passFail: ''
            };

            // Handle multi-channel
            if (template.data.channelType === 'multi' && template.data.channelCount) {
                const emptyArray = Array(template.data.channelCount).fill('');
                newPipette.measurements = {
                    asFound: { low: [...emptyArray], mid: [...emptyArray], high: [...emptyArray] },
                    asLeft: { low: [...emptyArray], mid: [...emptyArray], high: [...emptyArray] }
                };
            }

            pipettes.push(newPipette);
            renderPipette(newPipette);
            updateProgress();
            updateSummaryTable();
            updateBulkActionsBar();
            updateCopyButton();
            debouncedAutoSave();

            closeTemplatesModal();
            showTab('calibration', document.querySelector('.nav-tab:nth-child(2)'));

            // Scroll to new pipette
            setTimeout(() => {
                const newCard = document.querySelector(`[data-pipette-id="${newPipette.id}"]`);
                if (newCard) {
                    newCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 100);

            showAlert(`Pipette created from template "${template.name}"`, 'Template Loaded');
        }

        function deleteTemplate(index) {
            const template = pipetteTemplates[index];
            showConfirm(`Delete template "${template.name}"?`, 'Confirm Delete', () => {
                pipetteTemplates.splice(index, 1);
                localStorage.setItem('pipetteTemplates', JSON.stringify(pipetteTemplates));
                renderTemplatesList();
            });
        }

        // ========================================
        // DARK MODE
        // ========================================

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');

            // Update button
            const btn = document.getElementById('darkModeToggle');
            if (btn) {
                btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
                btn.title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
            }
        }

        function initDarkMode() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
                const btn = document.getElementById('darkModeToggle');
                if (btn) {
                    btn.textContent = '‚òÄÔ∏è';
                    btn.title = 'Switch to light mode';
                }
            }
        }

        // ========================================
        // TOAST NOTIFICATIONS
        // ========================================

        function showToast(message, type = 'success', title = '') {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            // Icon based on type
            const icons = {
                success: '‚úì',
                error: '‚úó',
                warning: '‚ö†',
                info: '‚Ñπ'
            };

            const defaultTitles = {
                success: 'Success',
                error: 'Error',
                warning: 'Warning',
                info: 'Info'
            };

            const icon = icons[type] || icons.info;
            const toastTitle = title || defaultTitles[type] || defaultTitles.info;

            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    <div class="toast-title">${toastTitle}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ========================================
        // LOADING SPINNER
        // ========================================

        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            if (overlay && text) {
                text.textContent = message;
                overlay.classList.add('show');
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        // ========================================
        // FORM VALIDATION
        // ========================================

        function validateField(input, validationRules) {
            // Remove previous validation classes
            input.classList.remove('error', 'success');

            // Get or create error message element
            let errorMsg = input.parentElement.querySelector('.error-message');
            if (!errorMsg) {
                errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                input.parentElement.appendChild(errorMsg);
            }

            let isValid = true;
            let errorText = '';

            // Check required
            if (validationRules.required && !input.value.trim()) {
                isValid = false;
                errorText = 'This field is required';
            }
            // Check min length
            else if (validationRules.minLength && input.value.length < validationRules.minLength) {
                isValid = false;
                errorText = `Minimum ${validationRules.minLength} characters required`;
            }
            // Check pattern (e.g., email, numbers)
            else if (validationRules.pattern && !validationRules.pattern.test(input.value)) {
                isValid = false;
                errorText = validationRules.patternMessage || 'Invalid format';
            }
            // Check min/max for numbers
            else if (input.type === 'number') {
                const num = parseFloat(input.value);
                if (validationRules.min !== undefined && num < validationRules.min) {
                    isValid = false;
                    errorText = `Minimum value is ${validationRules.min}`;
                } else if (validationRules.max !== undefined && num > validationRules.max) {
                    isValid = false;
                    errorText = `Maximum value is ${validationRules.max}`;
                }
            }

            // Apply validation state
            if (isValid && input.value.trim()) {
                input.classList.add('success');
                errorMsg.classList.remove('show');
            } else if (!isValid) {
                input.classList.add('error');
                errorMsg.textContent = errorText;
                errorMsg.classList.add('show');
            } else {
                errorMsg.classList.remove('show');
            }

            return isValid;
        }

        function markFieldAsRequired(fieldId) {
            const input = document.getElementById(fieldId);
            if (input) {
                const label = input.parentElement.querySelector('label');
                if (label && !label.classList.contains('required')) {
                    label.classList.add('required');
                }
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check password first
            if (!checkPassword()) {
                return; // Stop initialization if password check fails
            }

            // Set up modal event listeners
            document.getElementById('customModal')?.addEventListener('click', (e) => {
                if (e.target.id === 'customModal') closeModal();
            });

            // Close modal on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.getElementById('customModal')?.style.display === 'flex') {
                    closeModal();
                }

                // ========================================
                // BARCODE SCANNER DETECTION
                // ========================================
                // Detect rapid keystrokes from barcode scanner
                // Scanners type much faster than humans (<50ms between keys)

                const now = Date.now();
                const timeSinceLastKey = now - lastKeyTime;
                const isInputField = ['INPUT', 'TEXTAREA'].includes(e.target.tagName);

                // Only detect barcodes in text input fields
                if (isInputField && e.target.type === 'text') {
                    // Rapid keystrokes indicate barcode scanner
                    if (timeSinceLastKey < BARCODE_SCAN_SPEED_MS && timeSinceLastKey > 0) {
                        // Scanner is typing
                        barcodeBuffer += e.key;
                    } else {
                        // Human typing or new scan starting
                        barcodeBuffer = e.key;
                    }

                    lastKeyTime = now;

                    // Enter key signals end of barcode scan
                    if (e.key === 'Enter' && barcodeBuffer.length > 3) {
                        e.preventDefault(); // Prevent form submission

                        // Remove 'Enter' from buffer
                        const scannedValue = barcodeBuffer.slice(0, -5).trim();

                        // Show visual feedback
                        showScanFeedback(e.target, scannedValue);

                        // Auto-advance to next field
                        autoAdvanceAfterScan(e.target);

                        // Clear buffer
                        barcodeBuffer = '';
                        return;
                    }
                }
            });

            // Try to load saved session first
            const sessionLoaded = loadCurrentSession();

            // Show empty state if no pipettes
            updateEmptyState();

            // If no session loaded, set default dates
            if (!sessionLoaded) {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('calDate').value = today;

                const nextYear = new Date();
                nextYear.setFullYear(nextYear.getFullYear() + 1);
                document.getElementById('dueDate').value = nextYear.toISOString().split('T')[0];

                const firstOfMonth = new Date();
                firstOfMonth.setDate(1);
                document.getElementById('balanceCalDate').value = firstOfMonth.toISOString().split('T')[0];
                document.getElementById('balanceDueDate').value = nextYear.toISOString().split('T')[0];
            }

            loadHistory();

            // Setup autofill for common fields
            setupAutofill();

            // Check if backup reminder should be shown
            checkBackupReminder();

            // Initialize inventory and summary table
            renderInventoryUsage();
            updateInventoryStats();
            updateSummaryTable();

            // Initialize Dymo LabelWriter connection
            checkDymoService();
            renderDymoLabelList();

            // Initialize dark mode
            initDarkMode();

            // Initialize environmental section visibility based on service level
            const serviceLevel = document.getElementById('serviceLevel')?.value || 'platinum';
            const envSection = document.getElementById('environmentalSection');
            if (envSection) {
                envSection.style.display = serviceLevel === 'platinum' ? 'block' : 'none';
            }

            // Add listeners to session form fields for auto-save
            document.querySelectorAll('#session input, #session select').forEach(input => {
                input.addEventListener('change', debouncedAutoSave);
            });
        });
    </script>

    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="loading-text" id="loadingText">Loading...</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <h1 style="margin: 0; color: #34495e;">Calibrations International Inc.</h1>
                    <p style="margin: 5px 0 0 0; color: #69B135; font-weight: 600; font-size: 16px;">Quality Calibrations Across the Globe</p>
                    <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">Data Intake System | ISO 8655 Compliant | Bozeman, MT</p>
                </div>
                <div style="text-align: right; color: #223077; font-size: 13px;">
                    <div style="font-weight: 600;">1-877-CAL-INTL</div>
                    <div>406-589-6025</div>
                    <div style="color: #69B135;">theresa@calibrationsinternational.com</div>
                </div>
                <div style="margin-left: auto; display: flex; flex-direction: column; gap: 8px;">
                    <!-- Row 1: Templates, Voice, Dark Mode -->
                    <div style="display: flex; gap: 8px;">
                        <button onclick="openTemplatesModal()" title="Manage pipette templates" style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">üìù Templates</button>
                        <button id="globalVoiceBtn" onclick="toggleGlobalVoice()" title="Enable voice control for hands-free navigation" style="padding: 6px 12px; font-size: 13px;">üéôÔ∏è Voice Control</button>
                        <button id="darkModeToggle" onclick="toggleDarkMode()" title="Toggle dark mode" style="padding: 6px 12px; background: #495057; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">üåô</button>
                    </div>
                    <!-- Row 2: Undo, Redo, Logout -->
                    <div style="display: flex; gap: 8px;">
                        <button id="undoBtn" onclick="undo()" disabled title="Nothing to undo" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">‚Ü∂ Undo</button>
                        <button id="redoBtn" onclick="redo()" disabled title="Nothing to redo" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">‚Ü∑ Redo</button>
                        <button onclick="logout()" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">üîí Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('session', this)">üìã Session Info</button>
            <button class="nav-tab" onclick="showTab('calibrations', this)">üß™ Calibrations</button>
            <button class="nav-tab" id="analysisTab" onclick="showTab('analysis', this)">üìä Analysis</button>
            <button class="nav-tab" id="summaryTab" onclick="showTab('summary', this)" style="display: none;">üìä Summary Table</button>
            <button class="nav-tab" id="manifestTab" onclick="showTab('manifest', this)">üìã Manifest</button>
            <button class="nav-tab" onclick="showTab('report', this)">üìÑ Report</button>
            <button class="nav-tab" id="labelsTab" onclick="showTab('labels', this)">üè∑Ô∏è Labels</button>
            <button class="nav-tab" id="inventoryTab" onclick="showTab('inventory', this)">üì¶ Inventory</button>
            <button class="nav-tab" onclick="showTab('history', this)">üìö History</button>
        </div>

        <!-- Session Info Tab -->
        <div id="session" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìã Calibration Session Setup</h2>
                <div>
                    <button class="btn btn-success" onclick="newSession()">üÜï New Session</button>
                    <button class="btn btn-primary" onclick="importFromFile()">üì• Import JSON</button>
                </div>
            </div>

            <!-- Hidden service level field for backwards compatibility - actual selection happens in Calibrations tab -->
            <input type="hidden" id="serviceLevel" value="platinum">

            <div class="form-grid">
                <div class="form-group">
                    <label>Service Provider</label>
                    <input type="text" id="serviceProvider" value="Calibrations International Inc.">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="location" placeholder="Client facility location">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="address" placeholder="Client facility address">
                </div>
                <div class="form-group">
                    <label>PI/Client</label>
                    <input type="text" id="client" placeholder="Principal Investigator / Client name" onchange="generateWorkOrderAndInvoice()">
                </div>
                <div class="form-group">
                    <label>PI/Client Email</label>
                    <input type="email" id="clientEmail" placeholder="pi@example.com">
                </div>
                <div class="form-group">
                    <label>Contact Name</label>
                    <input type="text" id="contactName" placeholder="Primary contact name">
                </div>
                <div class="form-group">
                    <label>Contact Email</label>
                    <input type="email" id="contactEmail" placeholder="contact@example.com">
                </div>
                <div class="form-group">
                    <label>Technician</label>
                    <input type="text" id="technician" placeholder="Technician initials" onchange="generateWorkOrderAndInvoice()">
                </div>
                <div class="form-group">
                    <label>Calibration Date</label>
                    <input type="date" id="calDate" onchange="generateWorkOrderAndInvoice()">
                </div>
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="date" id="dueDate">
                </div>
                <div class="form-group">
                    <label>Frequency</label>
                    <select id="frequency" onchange="generateWorkOrderAndInvoice()">
                        <option value="A">Annual (A)</option>
                        <option value="S">Semi-Annual (S)</option>
                        <option value="Q">Quarterly (Q)</option>
                        <option value="M">Monthly (M)</option>
                    </select>
                </div>
            </div>

            <!-- Work Order & Invoice Section -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 25px 0; border-left: 4px solid #28a745;">
                <h3 style="color: #28a745; margin-bottom: 15px;">üìù Work Order & Invoice</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Service Date</label>
                        <input type="date" id="serviceDate" onchange="generateWorkOrderAndInvoice()">
                    </div>
                    <div class="form-group">
                        <label>Invoice # of Day</label>
                        <input type="number" id="invoiceCounter" value="1" min="1" onchange="generateWorkOrderAndInvoice()"
                               title="How many invoices have been generated today? Usually 1.">
                    </div>
                    <div class="form-group">
                        <label>Work Order Number</label>
                        <input type="text" id="workOrderNo" readonly style="background: #e9ecef; cursor: not-allowed;"
                               title="Auto-generated from PI/Client + Date + Counter + Frequency">
                    </div>
                    <div class="form-group">
                        <label>Invoice Number</label>
                        <input type="text" id="invoiceNo" readonly style="background: #e9ecef; cursor: not-allowed;"
                               title="Auto-generated from Technician + Date + Counter + Frequency">
                    </div>
                </div>
                <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                    üí° Work Order and Invoice numbers are auto-generated when PI/Client, Technician, Date, and Frequency are filled.
                </p>
            </div>

            <div id="environmentalSection" class="environmental-data">
                <h3>üå°Ô∏è Environmental Conditions</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Temperature (¬∞C)</label>
                        <input type="number" id="temperature" step="0.1" min="15" max="30" value="21.8" oninput="validateTemperature(this)">
                    </div>
                    <div class="form-group">
                        <label>Humidity (%)</label>
                        <input type="number" id="humidity" step="0.1" min="20" max="80" oninput="validateHumidity(this)">
                    </div>
                    <div class="form-group">
                        <label>Barometric Pressure (kPa)</label>
                        <input type="number" id="pressure" step="0.1" min="90" max="110" oninput="validatePressure(this)">
                    </div>
                    <div class="form-group">
                        <label>Balance Serial Number</label>
                        <input type="text" id="balanceSerial" value="B621501811">
                    </div>
                    <div class="form-group">
                        <label>Balance Calibration Date</label>
                        <input type="date" id="balanceCalDate">
                    </div>
                    <div class="form-group">
                        <label>Balance Due Date</label>
                        <input type="date" id="balanceDueDate">
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="showTab('calibrations', document.querySelector('.nav-tab:nth-child(2)'))">Next: Start Calibration ‚Üí</button>
        </div>

        <!-- Unified Calibrations Tab -->
        <div id="calibrations" class="tab-content">
            <!-- Calibration Type Selector -->
            <div style="background: #69B135; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                <label style="color: white; font-weight: 600; font-size: 16px; margin-bottom: 8px; display: block;">
                    Select Calibration Type
                </label>
                <select id="calibrationType" onchange="switchCalibrationType(this.value)"
                        style="width: 100%; padding: 12px 15px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; background: white; cursor: pointer;">
                    <option value="basic-pipette">‚ö° Basic Pipette (Quick Pass/Fail)</option>
                    <option value="platinum-pipette">üèÜ Platinum Pipette (ISO 8655 Full Gravimetric)</option>
                    <option value="balance">‚öñÔ∏è Balance Calibration</option>
                    <option value="timer">‚è±Ô∏è Timer Calibration</option>
                    <option value="centrifuge">üåÄ Centrifuge Calibration</option>
                    <option value="temperature">üå°Ô∏è Temperature Device Calibration</option>
                </select>
            </div>

            <!-- Pipette Calibration Section -->
            <div id="pipetteSection" class="calibration-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="pipetteSectionTitle">‚öñÔ∏è Pipette Calibration</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="addPipette()">+ Add Pipette</button>
                        <button class="btn btn-secondary" onclick="copyFromPrevious()" id="copyPrevBtn" style="display: none;">üìã Copy from Previous</button>
                        <button class="btn btn-success" onclick="autoFillSampleData()">üìä Load Sample Data</button>
                    </div>
                </div>

            <!-- Search and Filter Bar -->
            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div style="flex: 1;">
                        <input type="text" id="searchPipettes" placeholder="üîç Search by serial, brand, model, or pipette number..."
                               oninput="filterPipettes()"
                               style="width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <select id="filterStatus" onchange="filterPipettes()"
                            style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 150px;">
                        <option value="">All Status</option>
                        <option value="pass">‚úÖ Pass</option>
                        <option value="fail">‚ùå Fail</option>
                        <option value="pending">‚è≥ Pending</option>
                    </select>
                    <select id="filterServiceLevel" onchange="filterPipettes()"
                            style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 150px;">
                        <option value="">All Service Levels</option>
                        <option value="platinum">üèÜ Platinum</option>
                        <option value="basic">‚ö° Basic</option>
                    </select>
                    <button class="btn btn-secondary" onclick="clearFilters()" style="padding: 10px 16px; white-space: nowrap;">
                        Clear Filters
                    </button>
                </div>
            </div>

            <!-- Bulk Actions Bar (for Basic mode) -->
            <div id="bulkActionsBar" style="display: none; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #69B135; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <label style="margin: 0; font-weight: 600; display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"
                                   style="width: 20px; height: 20px; cursor: pointer; margin-right: 8px;">
                            Select All
                        </label>
                        <span id="selectedCount" style="color: #6c757d; font-weight: 600;">0 selected</span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="bulkMarkStatus('PASS')" style="padding: 8px 18px; font-size: 14px; font-weight: 600;">
                            ‚úì Mark as PASS
                        </button>
                        <button class="btn btn-danger" onclick="bulkMarkStatus('FAIL')" style="padding: 8px 18px; font-size: 14px; font-weight: 600;">
                            ‚úó Mark as FAIL
                        </button>
                        <button class="btn" onclick="bulkDeleteSelected()" style="background: #dc3545; color: white; padding: 8px 18px; font-size: 14px; font-weight: 600;">
                            üóëÔ∏è Delete Selected
                        </button>
                    </div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div id="pipettesContainer">
                <!-- Pipettes will be added here dynamically -->
            </div>
            </div>

            <!-- Balance Calibration Section -->
            <div id="balanceSection" class="calibration-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>‚öñÔ∏è Balance Calibration</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="addBalance()">+ Add Balance</button>
                        <button class="btn btn-danger" onclick="deleteAllBalances()" id="deleteAllBalancesBtn" style="display: none;">üóëÔ∏è Delete All</button>
                    </div>
                </div>
                <div id="balancesList"></div>
            </div>

            <!-- Timer Calibration Section -->
            <div id="timerSection" class="calibration-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>‚è±Ô∏è Timer Calibration</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="addTimer()">+ Add Timer</button>
                        <button class="btn btn-danger" onclick="deleteAllTimers()" id="deleteAllTimersBtn" style="display: none;">üóëÔ∏è Delete All</button>
                    </div>
                </div>
                <div id="timersList"></div>
            </div>

            <!-- Centrifuge Calibration Section -->
            <div id="centrifugeSection" class="calibration-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üåÄ Centrifuge Calibration</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="addCentrifuge()">+ Add Centrifuge</button>
                        <button class="btn btn-danger" onclick="deleteAllCentrifuges()" id="deleteAllCentrifugesBtn" style="display: none;">üóëÔ∏è Delete All</button>
                    </div>
                </div>
                <div id="centrifugesList"></div>
            </div>

            <!-- Temperature Device Calibration Section -->
            <div id="temperatureSection" class="calibration-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üå°Ô∏è Temperature Device Calibration</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="addTemperatureDevice()">+ Add Temperature Device</button>
                        <button class="btn btn-danger" onclick="deleteAllTemperatureDevices()" id="deleteAllTemperatureDevicesBtn" style="display: none;">üóëÔ∏è Delete All</button>
                    </div>
                </div>
                <div id="temperatureDevicesList"></div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <h2>üìä Real-time Analysis</h2>
            
            <div class="statistics">
                <div class="stat-card">
                    <div class="stat-value" id="totalPipettes">0</div>
                    <div class="stat-label">Total Pipettes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="passCount">0</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="failCount">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="passRate">0%</div>
                    <div class="stat-label">Pass Rate</div>
                </div>
            </div>

            <div id="analysisDetails">
                <!-- Analysis details will be populated here -->
            </div>
        </div>

        <!-- Report Tab -->
        <div id="report" class="tab-content">
            <h2>üìÑ Calibration Report</h2>

            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="generateReport()">üìÑ Generate Report</button>
                <button class="btn btn-success" onclick="downloadPDF()">üìÑ Download PDF</button>
                <button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Print</button>
                <br style="margin: 5px 0;">
                <button class="btn btn-success" onclick="exportFormattedCSV()">üìä Export Formatted CSV</button>
                <button class="btn btn-success" onclick="exportDataCSV()">üìä Export Data CSV</button>
                <button class="btn btn-primary" onclick="saveSession()">üíæ Save JSON</button>
                <br style="margin: 5px 0;">
                <button class="btn btn-secondary" onclick="emailReport()">üìß Email Report</button>
                <button class="btn btn-secondary" onclick="copyReportToClipboard()">üìã Copy Report Text</button>
            </div>

            <div id="reportContent" class="report-section">
                <!-- Report content will be generated here -->
            </div>
        </div>

        <!-- Summary Table Tab (Basic Mode Only) -->
        <div id="summary" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #69B135;">üìä Summary Table</h2>
                <button class="btn btn-secondary" onclick="exportSummaryToCSV()">üì• Export CSV</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="pipette-table" id="summaryTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background: #5a9a2d; color: white;">
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">No.</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Manufacturer</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Model</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Max Vol</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">In Spec</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Out Spec</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Adjustments</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Final Volumes</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">P/F</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 40px; color: #6c757d; border: 1px solid #ddd;">
                                No pipettes to display. Add pipettes in the Calibration tab.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Labels Tab -->
        <div id="labels" class="tab-content">
            <h2 style="color: #69B135;">üè∑Ô∏è Calibration Labels</h2>
            <p style="color: #6c757d; margin-bottom: 20px;">Generate printable calibration labels for your pipettes</p>

            <!-- Dymo LabelWriter 450 Section -->
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid #28a745;">
                <h3 style="color: #28a745; margin-top: 0;">üñ®Ô∏è Dymo LabelWriter 450</h3>
                <p style="color: #2e7d32; margin-bottom: 15px;">Print directly to your Dymo label printer</p>

                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <div id="printerStatus" style="font-weight: 600; margin-bottom: 5px;">Checking for Dymo Connect...</div>
                            <div id="printerInfo" style="font-size: 14px;"></div>
                        </div>
                        <button class="btn btn-secondary" onclick="checkDymoService(); renderDymoLabelList();" title="Refresh printer status">
                            üîÑ Refresh
                        </button>
                    </div>

                    <!-- Instructions if Dymo not detected -->
                    <div id="dymoInstructions" style="display: none; background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107; margin-top: 15px;">
                        <strong style="color: #856404;">‚ö†Ô∏è Dymo Connect Not Detected</strong>
                        <ol style="margin: 10px 0 0 20px; padding: 0; color: #856404;">
                            <li>Download and install <a href="https://www.dymo.com/support?cfid=online-support-dls" target="_blank" style="color: #856404; text-decoration: underline;">Dymo Connect</a></li>
                            <li>Connect your Dymo LabelWriter 450 via USB</li>
                            <li>Make sure Dymo Connect software is running</li>
                            <li>Load 30334 labels (2-1/4" x 1-1/4") into the printer</li>
                            <li>Click "Refresh" button above</li>
                        </ol>
                    </div>
                </div>

                <!-- Pipette selection for Dymo printing -->
                <div id="dymoLabelPipetteList"></div>
            </div>

            <!-- Browser Print Section (Standard/Fallback) -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 4px solid #69B135;">
                <h3 style="color: #69B135; margin-top: 0;">üñ®Ô∏è Standard Browser Print</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">Generate HTML labels for standard printers</p>

                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="generateLabels()">üìù Generate Labels</button>
                    <button class="btn btn-secondary" onclick="printLabels()">üìÑ Print Labels</button>
                </div>

                <div id="labelsContainer" style="background: white; padding: 20px; border-radius: 8px;">
                    <p style="text-align: center; color: #6c757d; padding: 40px;">
                        Click "Generate Labels" to create printable calibration labels
                    </p>
                </div>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #69B135;">üì¶ Inventory Used</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="autoDetectAndAddInventory()" class="btn btn-secondary" title="Auto-detect inventory from calibration data">
                        üîÑ Auto-Detect from Calibrations
                    </button>
                    <button onclick="openAddInventoryModal()" class="btn btn-primary">
                        ‚ú® Add Item Used
                    </button>
                </div>
            </div>

            <!-- Summary Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div style="background: #3b82f6; padding: 20px; border-radius: 12px; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;" id="invTotalItems">0</div>
                    <div style="opacity: 0.9;">Total Items Used</div>
                </div>
                <div style="background: #10b981; padding: 20px; border-radius: 12px; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;" id="invCurrentSession">0</div>
                    <div style="opacity: 0.9;">Current Session</div>
                </div>
                <div style="background: #f59e0b; padding: 20px; border-radius: 12px; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;" id="invUniqueItems">0</div>
                    <div style="opacity: 0.9;">Unique Items</div>
                </div>
            </div>

            <!-- Usage Table -->
            <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="color: #69B135; margin-bottom: 20px;">Items Used in Current Session</h3>
                <div style="overflow-x: auto;">
                    <table id="inventoryUsageTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
                                <th style="padding: 15px; text-align: left; font-weight: 700; color: #374151; border-bottom: 2px solid #e5e7eb;">Item Name</th>
                                <th style="padding: 15px; text-align: center; font-weight: 700; color: #374151; border-bottom: 2px solid #e5e7eb;">Quantity</th>
                                <th style="padding: 15px; text-align: left; font-weight: 700; color: #374151; border-bottom: 2px solid #e5e7eb;">Pipette #</th>
                                <th style="padding: 15px; text-align: left; font-weight: 700; color: #374151; border-bottom: 2px solid #e5e7eb;">Job/Invoice</th>
                                <th style="padding: 15px; text-align: left; font-weight: 700; color: #374151; border-bottom: 2px solid #e5e7eb;">Used By</th>
                                <th style="padding: 15px; text-align: left; font-weight: 700; color: #374151; border-bottom: 2px solid #e5e7eb;">Time</th>
                                <th style="padding: 15px; text-align: left; font-weight: 700; color: #374151; border-bottom: 2px solid #e5e7eb;">Notes</th>
                                <th style="padding: 15px; text-align: center; font-weight: 700; color: #374151; border-bottom: 2px solid #e5e7eb;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryUsageBody">
                            <tr>
                                <td colspan="8" style="padding: 40px; text-align: center; color: #6c757d;">
                                    <div style="font-size: 3rem; opacity: 0.3; margin-bottom: 10px;">üì¶</div>
                                    <div>No items used yet. Click "Auto-Detect" or "Add Item Used" to track inventory.</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Export Section -->
            <div style="margin-top: 25px; text-align: right;">
                <button onclick="exportInventoryUsage()" class="btn btn-secondary">
                    üìÑ Export Usage Report
                </button>
                <button onclick="clearInventoryUsage()" class="btn btn-danger" style="margin-left: 10px;">
                    üóëÔ∏è Clear All Usage
                </button>
            </div>
        </div>

        <!-- Manifest Tab (Summary of All Equipment) -->
        <div id="manifest" class="tab-content">
            <div style="background: #69B135; padding: 30px; border-radius: 12px; margin-bottom: 30px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">üìä Session Dashboard</h2>
                <p style="margin: 0; opacity: 0.9;">Complete overview of all equipment in this calibration session</p>
            </div>

            <!-- Summary Statistics Cards -->
            <div id="manifestSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <!-- Summary cards will be populated here -->
            </div>

            <!-- Quick Actions -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 2px solid #e9ecef;">
                <h3 style="margin: 0 0 15px 0; color: #223077;">‚ö° Quick Actions</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showTab('calibrations', document.querySelector('.nav-tab:nth-child(2)'))">
                        ‚ûï Add Equipment
                    </button>
                    <button class="btn btn-success" onclick="showTab('report', document.querySelector('.nav-tab:nth-child(6)'))">
                        üìÑ Generate Report
                    </button>
                    <button class="btn" onclick="exportSessionData()" style="background: #69B135; color: white;">
                        üíæ Export Session
                    </button>
                    <button class="btn btn-secondary" onclick="loadHistory()">
                        üìö View History
                    </button>
                </div>
            </div>

            <!-- Equipment Details Table -->
            <h3 style="color: #223077; margin-bottom: 15px;">üìã Equipment Manifest</h3>
            <div id="manifestTable">
                <!-- Equipment table will be populated here -->
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <h2>üìö Calibration History</h2>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="loadHistory()">üîÑ Refresh History</button>
            </div>

            <div id="historyContainer">
                <!-- History will be populated here -->
            </div>
        </div>
    </div>

    <!-- Custom Modal Dialog -->
    <div id="customModal" class="modal-overlay" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 id="modalTitle">Confirm</h3>
            </div>
            <div class="modal-body">
                <p id="modalMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="modalConfirmBtn" onclick="">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventoryModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üì¶ Add Inventory Item</h2>
                <button class="close-btn" onclick="closeInventoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Item Name/Part Number</label>
                    <input type="text" id="invItemName" placeholder="e.g., SE Adjustment Screw, O-Ring Kit">
                </div>
                <div class="form-group">
                    <label>Quantity Used</label>
                    <input type="number" id="invQuantity" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>Pipette Number (optional)</label>
                    <input type="text" id="invPipetteNo" placeholder="e.g., 01, 02">
                </div>
                <div class="form-group">
                    <label>Notes (optional)</label>
                    <textarea id="invNotes" rows="3" placeholder="Additional details..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeInventoryModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addInventoryItem()">Add Item</button>
            </div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div id="templatesModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üìù Pipette Templates</h2>
                <button class="close-btn" onclick="closeTemplatesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #6c757d; margin-bottom: 20px;">Save commonly used pipette configurations as templates for quick entry.</p>

                <!-- Saved Templates List -->
                <div style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px;">Saved Templates</h3>
                    <div id="templatesList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Templates will be listed here -->
                    </div>
                </div>

                <!-- Save Current as Template -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                    <h3 style="margin-bottom: 15px; color: #17a2b8;">üíæ Save Current Pipette as Template</h3>
                    <div class="form-group">
                        <label>Select Pipette to Save</label>
                        <select id="templatePipetteSelect" style="width: 100%;">
                            <option value="">-- Select a pipette --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Template Name</label>
                        <input type="text" id="templateName" placeholder="e.g., Eppendorf P-100 Standard" style="width: 100%;">
                    </div>
                    <button class="btn btn-primary" onclick="saveAsTemplate()" style="width: 100%;">
                        üíæ Save as Template
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTemplatesModal()">Close</button>
            </div>
        </div>
    </div>

</body>
</html>